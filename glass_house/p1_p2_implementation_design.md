# P1/P2 整改设计与实现说明

**依据**：glass_house/architecture_compliance_report.md 建议整改优先级  
**合规**：00 修正案 #5、01 核心法律 2.2、4.2、4.4、7.3、元规则 #8

---

## 一、签名与验签（P1）

### 1.1 设计

- **00 修正案 #5**：所有跨系统（如 ERP→WMS）数据交互必须包含数字签名；接收方必须验签，验签失败必须触发告警并记录「黑客入侵日志」。
- **实现位置**：
  - 平台或各细胞：提供签名接口（如 HMAC-SHA256 或国密 SM2）；请求头建议 `X-Cell-Signature`，body 规范化后签名。
  - 网关或细胞在接收跨细胞请求时验签；验签失败时记录审计日志（入侵日志）并告警，返回 401 或 403。

### 1.2 使用方式

- 细胞 A 调用细胞 B 时：A 对 payload 签名，放入请求头 `X-Cell-Signature`。
- 细胞 B 或网关：验签，失败则记录并拒绝。

---

## 二、敏感字段加密（P1）

### 2.1 设计

- **01 核心法律 2.2**：敏感字段（金额、身份证、手机号）须 AES-256 或国密 SM4 加密。
- **细胞侧**：在写入存储前对敏感字段加密；读取后对展示层解密或仅脱敏展示。多租户下密钥按租户或全局配置注入。

---

## 三、事件溯源与事件总线（P1）

### 3.1 设计

- **01 7.3**：事件语义冻结；事件只描述已发生事实。禁止跨细胞直接库连。
- **实现**：
  - 细胞写操作应追加到 event_store，再更新读模型。
  - 跨细胞通过事件或 HTTP 接口；生产可接 Kafka/RocketMQ，事件命名遵循接口设计说明书（如 erp.order.created）。

---

## 四、日志与 trace_id（已落实）

- 人类可读日志 + 全链路 trace_id（X-Request-ID）；满足 3 分钟定位（CT 扫描原则）。

---

*文档版本：V1.0 | 依据：00 宪法、01 核心法律、architecture_compliance_report*
