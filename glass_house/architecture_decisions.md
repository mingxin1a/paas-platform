# 架构决策记录（玻璃房 · 透明化）

**依据**：《00_【最高宪法】SuperPaaS-God v8.0》修正案 #14 玻璃房原则——安全透明化，用户可查“谁在什么时候访问了我的数据”；本目录提供系统级透明：所有关键架构决策及依据可追溯。

---

## ADR-001：五层架构与细胞化

**决策**：平台采用五层架构（感知交互、生态与运营、应用开发、平台服务、基础设施），业务模块以“细胞”形式存在于应用开发层，每个细胞独立数据库、独立部署、仅经网关与事件通信。

**依据**：
- 《01_【核心法律】》7.2.1 细胞自治原则、7.2.2 跨细胞访问禁令。
- 《00_最高宪法》修正案 #10 生物学原则：服务是细胞，消息队列是神经，数据库是记忆；修正案 #11 乐高原则：功能模块可独立安装、卸载、计费。

**状态**：已采纳。

---

## ADR-002：网关动态路由与熔断

**决策**：网关支持从环境变量或配置文件加载动态路由（cell → base_url）；为每个细胞维护独立熔断器，10 秒内异常率 ≥ 50% 时开启熔断，半开状态放行少量探测请求，连续成功后关闭。

**依据**：
- 《接口设计说明书》3.3.1 断路器机制、3.3.2 优雅降级。
- 《00_最高宪法》第五审判（运维）：需预设熔断降级与重试机制。

**状态**：已采纳。

---

## ADR-003：全链路追踪与黄金指标

**决策**：每个请求携带 trace_id 与 span_id，响应头回传；监控层为所有经网关的请求发射黄金指标：延迟（duration_ms）、错误率（5xx/4xx 计数）、流量（请求数）、饱和度（可选）。

**依据**：
- 《00_最高宪法》元规则 #9 CT 扫描原则：3 分钟内通过 trace_id 定位到代码行；第五审判：日志 JSON + trace_id。
- 《超级PaaS平台全量化体系书》/ 全量化可观测：每个组件自带可观测性。

**状态**：已采纳。

---

## ADR-004：细胞健康检查与扩缩容建议

**决策**：注册中心配套健康检查模块，对已注册细胞周期性 GET /health，连续失败 N 次标记不健康；扩缩容策略根据错误率与 P99 延迟输出 up/down/none 建议，不自动执行，由编排层消费。

**依据**：
- 《01_核心法律》7.2.1 细胞自治：独立扩缩容与独立失效能力。
- 量化驱动：健康状态与扩缩容建议可观测。

**状态**：已采纳。

---

## ADR-005：管家式 AI 与自愈策略

**决策**：每个细胞目录下提供 ai_agent.py（监控日志、匹配预设异常模式、执行 log/alert/restart）与 auto_healing.yaml（定义 api_error_rate > 5% 重启等规则）；实际执行 restart 需显式开启 SUPPAAS_AUTO_HEAL_RESTART=1。

**依据**：
- 《01_核心法律》3.1 管家式 AI、3.2 智能容错。
- 《00_最高宪法》修正案 #12 自动驾驶原则：AI 代替人完成操作；零心智负担：开箱即用。

**状态**：已采纳。

---

## ADR-006：跨细胞仅异步、禁止同步强一致

**决策**：细胞间数据交换仅通过事件总线或异步 API 调用，禁止跨细胞数据库直连与同步强一致事务。

**依据**：
- 《01_核心法律》7.6.1 跨细胞同步调用禁令；7.3 事件语义冻结与事件事实性。
- 《00_最高宪法》修正案 #6 最终一致性：消息队列 + 最大努力通知 + 人工对账。

**状态**：已采纳。

---

## ADR-007：接口契约不可变（集装箱原则）

**决策**：对外 API 的路径、请求/响应格式、必须头为神圣契约，细胞内部重构不得改变契约；变更须通过新版本（如 /api/v2/）或新事件类型实现。

**依据**：
- 《00_最高宪法》元规则 #7 集装箱原则。
- 《接口设计说明书》2.1 集装箱原则。

**状态**：已采纳。

---

## ADR-008：CRM 商机阶段状态机与赢率分析（业界知识注入）

**决策**：商机采用阶段状态机（qualification → needs_analysis → proposal → negotiation → closed_won/closed_lost），每阶段配置赢率权重（0–100%）；预测金额 = Σ(阶段金额 × 阶段赢率)。赢率分析接口按周期（如 90 天）统计赢单/输单数量与占比。线索支持“分配”与“转化”（account / opportunity / both），转化时创建客户与可选商机，符合 Salesforce 式流程。

**依据**：
- 《接口设计说明书》RESTful、幂等（X-Request-ID）、必须头 X-Tenant-Id、X-Response-Time。
- 《01_核心法律》金额以分存储（Long/分）；多租户 tenant_id 隔离；读模型仅展示、不参与业务决策（7.5.1）。
- 业界标杆：Salesforce 线索→商机→客户流程与阶段预测。

**状态**：已采纳（CRM 细胞 v1.1.0）。

---

## ADR-008b：CRM 开放功能探索 + 封闭架构实现（CPO+CA）

**决策**：功能由 CPO+CA 智能体自主推导（业界最佳实践），输出《{CELL}_自主产品规格说明书》；实现严格封闭：仅 PaaS 网关、独立 Schema、@superpaas/ui-components，无外部库。本期 CRM 新增：活动/任务、产品与商机行项目、管道/漏斗报表、审批流、模板合并（{{key}}）；每功能配套验收测试并更新 delivery.package。

**依据**：用户指令「开放功能探索、封闭架构实现」；《00_最高宪法》集装箱原则；《01_核心法律》细胞自治与金额-分。

**状态**：已采纳（CRM v1.2.0）。

---

## ADR-009：CRM 客户 360° 视图与关系图谱

**决策**：提供 GET /customers/{id}/360 聚合该客户的档案、联系人、商机及关系边；关系图谱 GET /customers/{id}/relationships 返回 nodes（客户节点）与 edges（关系类型），便于前端绘制关系图。关系数据存于 account_relationship 读模型，不跨细胞。

**依据**：
- 《01_核心法律》7.2.2 跨细胞访问禁令；7.5.1 读模型只读原则。
- 业界标杆：客户 360° 视图与关系图谱为 CRM 通用能力。

**状态**：已采纳（CRM 细胞 v1.1.0）。

---

## ADR-010：ERP 财务与物料生产域（SAP 式业界注入）

**决策**：ERP 细胞提供四大域：财务总账（GL 科目与分录、借贷平衡）、应收/应付（AR/AP 发票、金额-分）、物料管理（MM 物料主数据、采购订单、发票校验读模型）、生产计划（PP BOM、工单）。所有金额以分存储（Long）；POST 均支持 X-Request-ID 幂等；多租户 X-Tenant-Id 隔离。

**依据**：
- 《01_核心法律》金额 Long(分)、分库分表/tenant_id、事件溯源+读模型。
- 《接口设计说明书》必须头、错误格式、幂等。
- 业界标杆：SAP GL/AR/AP/MM/PP 通用能力子集。

**状态**：已采纳（ERP 细胞 v1.0.0）。

---

*本文件随架构演进持续更新，所有决策均可追溯到宪法与法律条款。*
