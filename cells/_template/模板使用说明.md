# 细胞模块模板使用说明

本模板提供符合**细胞化架构规范**与**《接口设计说明书》**的通用结构，新增 ERP、MES 等模块时，复制本目录后仅需**填充业务逻辑**即可接入，无需修改底层规范。

---

## 1. 目录结构

```
_template/
├── api/                 # 接口层
│   ├── middleware.py    # 鉴权拦截器、request_id/tenant_id 上下文、统一错误
│   ├── schemas.py       # 请求/响应模型（含统一错误格式）
│   └── routes.py        # 路由（示例 items，复制后改为 orders、work_orders 等）
├── models/              # 数据模型层
│   ├── base.py          # 基类（可选）
│   └── item.py          # 示例实体与存储（复制后改为订单、工单等）
├── service/             # 业务逻辑层
│   └── item_service.py  # 示例 CRUD 服务（复制后改为业务服务）
├── config/              # 配置
│   └── settings.py      # 仅环境变量，不依赖 platform_core
├── tests/               # 测试
│   ├── conftest.py      # 路径与 fixture
│   └── unit/
│       └── test_api.py  # 健康、鉴权、CRUD、幂等、错误码
├── docker/
│   └── Dockerfile       # 通用镜像构建
├── main.py              # 应用入口：健康检查、中间件、路由挂载、统一异常处理
├── requirements.txt     # 依赖
├── verify_delivery.sh   # 交付校验脚本
├── delivery.package     # 交付元数据（delivery.package.schema）
├── completion.manifest  # 交付能力清单
├── cell_profile.md      # 细胞档案
└── 模板使用说明.md      # 本文件
```

---

## 2. 内置规范（无需修改）

| 能力 | 说明 | 位置 |
|------|------|------|
| **健康检查** | GET /health → `{"status":"up","cell":"<细胞名>"}`，符合网关注册与健康巡检 | main.py |
| **鉴权拦截器** | 请求头 Authorization Bearer；若配置 PLATFORM_AUTH_URL 则 HTTP 校验，否则可接受 Bearer 联调 | api/middleware.py |
| **统一响应头** | X-Response-Time、请求上下文 request_id/tenant_id（X-Request-ID、X-Tenant-Id） | main.py + api/middleware.py |
| **统一错误格式** | `{"code","message","details","requestId"}`；401 UNAUTHORIZED、400 BAD_REQUEST、404 NOT_FOUND、409 IDEMPOTENT_CONFLICT | api/schemas.py + main.py 异常处理 |
| **幂等** | POST/PUT/PATCH 必须带 X-Request-ID，重复请求返回 409 | api/middleware.py require_request_id + service 层 idempotent |

---

## 3. 新增模块步骤（以 ERP、MES 为例）

### 3.1 复制模板

```bash
cp -r cells/_template cells/erp
# 或
cp -r cells/_template cells/mes
```

### 3.2 必改项（仅改名称与业务）

| 项 | 操作 |
|----|------|
| **delivery.package** | `cell_name: erp`（或 mes），`status: building` |
| **completion.manifest** | `cell_name: erp`，`delivered` 列表改为本细胞能力（如 api_orders、api_contracts） |
| **cell_profile.md** | 细胞代码、显示名称、资源与 URL 设计 |
| **main.py** | `health()` 返回中 `"cell": "erp"`；`include_router(..., prefix="/orders", ...)` 等 |
| **config/settings.py** | 可选：将 `CELL_` 改为 `ERP_`/`MES_` 以隔离配置 |
| **docker/Dockerfile** | 端口按规划修改（如 ERP 8002）；COPY 若目录有增删则相应调整 |

### 3.3 填充业务逻辑（不改规范代码）

| 层 | 操作 |
|----|------|
| **models/** | 新增 order.py、contract.py 等，实现 list/get/create/update/delete 与 idempotent 存储（可接 SQLite/MySQL） |
| **service/** | 新增 order_service.py 等，调用 models，封装业务规则与幂等 |
| **api/** | 复制 routes.py 为 orders.py，改为 OrderCreate/OrderUpdate、OrderService；在 schemas.py 增加对应 Pydantic 模型；在 main.py 中 `include_router(orders_router, prefix="/orders", ...)` |

### 3.4 测试与交付校验

- 在 `tests/unit/` 中补充或改写 `test_api.py`（覆盖本细胞资源与错误码）。
- 在细胞根目录执行：`sh verify_delivery.sh`，通过后可将 `delivery.package` 中 `status` 置为 `production_ready`。

---

## 4. 环境变量（《接口设计说明书》）

| 变量 | 说明 | 默认 |
|------|------|------|
| PORT | 服务端口 | 8001 |
| CELL_DATABASE_URL | 数据库连接 | sqlite:///./cell.db |
| PLATFORM_AUTH_URL | 平台认证地址（HTTP 校验 Token） | - |
| CELL_AUTH_STRICT | 未配置认证时是否拒绝 | 0 |
| DEFAULT_TENANT_ID | 默认租户 | default |

---

## 5. 构建与运行

```bash
# 安装依赖
pip install -r requirements.txt

# 本地运行
uvicorn main:app --host 0.0.0.0 --port 8001

# Docker 构建（在细胞根目录执行）
docker build -f docker/Dockerfile -t cell-template:latest .

# 交付校验
sh verify_delivery.sh
```

---

后续新增 ERP、MES 等模块时，按上述步骤复制模板并**仅填充 models/service/api 业务逻辑**即可完成接入，无需修改健康检查、鉴权、统一响应与错误码等底层规范。
