# ERP 细胞 - 企业级可落地验证报告

**扫描范围**：`cells/erp/` 目录下全部代码  
**验证时间**：基于当前代码库静态分析  
**依据**：企业级 ERP 可落地标准（业务流程闭环、数据完整性、权限、企业特性、部署可行性）

---

## 一、业务流程闭环验证

### 1.1 采购流程：采购申请 → 采购订单 → 采购入库 → 应付账款 → 付款

| 环节           | 状态     | 说明 |
|----------------|----------|------|
| 采购申请       | ❌ 未实现 | 无采购申请单、审批流，无对应 API 与表 |
| 采购订单       | ✅ 已实现 | `mm_purchase_orders` GET/POST，`mm_purchase_order` 表 |
| 采购订单行项目 | ❌ 未实现 | 无 PO 行（物料、数量、单价），仅总金额 |
| 采购入库       | ❌ 未实现 | 无入库单、库存变动；规格书标注「规划」 |
| 应付账款       | ✅ 已实现 | `ap_invoices` 创建、GET；与 PO 无业务关联 |
| 付款           | ✅ 已实现 | `ap/invoices/{id}/payments` 登记付款 |

**结论**：采购流程**不闭环**。缺少采购申请、PO 行、采购入库；AP 与 PO 未关联（无三单匹配）。

---

### 1.2 销售流程：销售报价 → 销售订单 → 销售出库 → 应收账款 → 收款

| 环节     | 状态     | 说明 |
|----------|----------|------|
| 销售报价 | ❌ 未实现 | 无报价单、报价单 API |
| 销售订单 | ✅ 已实现 | `orders` GET/POST，`order_read_model` 读模型；无行项目 |
| 销售出库 | ❌ 未实现 | 无出库单、库存扣减；规格书标注「规划」 |
| 应收账款 | ✅ 已实现 | `ar_invoices` 创建、GET；与订单无自动关联 |
| 收款     | ✅ 已实现 | `ar/invoices/{id}/receipts` 登记收款 |

**结论**：销售流程**不闭环**。缺少报价、出库；订单与应收未自动关联。

---

### 1.3 生产流程：BOM → 生产订单 → 生产领料 → 生产入库

| 环节     | 状态     | 说明 |
|----------|----------|------|
| BOM      | ⚠️ 部分实现 | 有 BOM 主表与 API；**无 BOM 子件**（`pp_bom_item` 表存在但无 API/Store 维护） |
| 生产订单 | ✅ 已实现 | `pp/work-orders` 创建/查询，关联 BOM、产品物料、计划数量 |
| 生产领料 | ❌ 未实现 | 无领料单、无扣减原料库存 |
| 生产入库 | ❌ 未实现 | 工单报工仅更新完成数量与状态，无成品入库、库存增加 |

**结论**：生产流程**不闭环**。BOM 无子件清单；无领料、无成品入库。

---

### 1.4 库存流程：入库 → 调拨 → 盘点 → 出库

| 环节 | 状态     | 说明 |
|------|----------|------|
| 入库 | ❌ 未实现 | 无入库单、无库存表、无库存量维护 |
| 调拨 | ❌ 未实现 | 无库位/仓库、无调拨单 |
| 盘点 | ❌ 未实现 | 无盘点单、无盈亏处理 |
| 出库 | ❌ 未实现 | 无出库单、无库存扣减 |

**结论**：库存流程**整体未实现**。Schema 仅有物料主数据与采购订单，无库存余额表与出入库业务。

---

### 1.5 财务流程：应收/应付 → 收付款 → 对账 → 报表

| 环节       | 状态     | 说明 |
|------------|----------|------|
| 应收/应付  | ✅ 已实现 | 发票 CRUD、状态（待收/部分/已收等） |
| 收付款     | ✅ 已实现 | 收款/付款登记，更新已付金额与状态 |
| 对账       | ❌ 未实现 | 无对账单、无与银行/客户对账 API |
| 报表       | ⚠️ 部分实现 | 试算表、账龄 API 有；**无报表导出**（Excel/PDF） |
| 总账过账   | ⚠️ 部分实现 | 分录借贷平衡在应用层**未强制校验**（见数据完整性） |

**结论**：财务主流程有；对账与报表导出缺失，分录平衡校验不足。

---

## 二、数据完整性验证

### 2.1 外键关系

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 表间外键 | ❌ 未实现 | `database_schema.sql` 中**无任何 FOREIGN KEY / REFERENCES** |
| 应用层关联 | ⚠️ 部分 | 仅租户隔离；无校验如：`gl_journal_line.account_code` 是否存在 `gl_account`，`pp_bom_item.material_id` 是否存在于 `mm_material` |

**修复建议**：  
- 在 Schema 中为关联表增加 FK（如 `gl_journal_line.entry_id → gl_journal_entry.entry_id`，`gl_journal_line.account_code → gl_account(tenant_id, account_code)`，`pp_bom_item.bom_id → pp_bom.bom_id` 等）。  
- 在应用层对关键外键做存在性校验（如创建分录时校验科目、创建工单时校验 BOM 存在）。

---

### 2.2 软删除

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 软删除 | ❌ 未实现 | 所有表均无 `deleted_at` / `is_deleted` 字段；代码中无软删除逻辑 |

**影响**：物理删除会导致历史引用断裂、无法追溯。  
**修复建议**：  
- 对主数据与业务单增加 `deleted_at`（或 `is_deleted`），删除时仅更新该字段。  
- 查询与关联处统一过滤 `deleted_at IS NULL`。

---

### 2.3 操作日志

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 审计表 | ⚠️ 仅表存在 | `audit_log` 表已建，但**应用未写入** |
| 当前审计 | ✅ 有 | `_human_audit()` 仅写 **Python logging**，不落库；无 `trace_id`/业务主键持久化 |

**影响**：无法在库内按操作人/时间/单据做审计查询与合规追溯。  
**修复建议**：  
- 在关键写操作后调用统一审计服务，将 `tenant_id, user_id, operation_type, operation_result, trace_id, occurred_at` 等写入 `audit_log`。  
- 可选：与现有 `_human_audit` 并存，日志 + 数据库双写。

---

### 2.4 数据校验规则

| 检查项       | 状态     | 说明 |
|--------------|----------|------|
| 必填项       | ❌ 不足 | 未校验如 `customerId`、`accountCode`、`documentNo` 等非空；空串可写入 |
| 数据格式     | ❌ 不足 | 日期格式、金额范围、枚举状态未做统一校验 |
| 业务规则     | ❌ 不足 | **分录借贷平衡未校验**（`gl_entry_create` 未校验 `total_d == total_c`）；收款/付款可超过发票金额、可重复登记无幂等 |

**修复建议**：  
- 对必填字段做请求体校验（如 400 + 明确错误码）。  
- 分录创建时强制 `sum(debit) == sum(credit)`，否则 400。  
- 收付款：校验 `amountCents <= 待付/待收金额`，并为其增加幂等（如 X-Request-ID 写收付款记录）。

---

## 三、权限控制验证

### 3.1 RBAC

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 角色/权限模型 | ❌ 未实现 | 无角色表、权限表、用户-角色关联 |
| 接口鉴权     | ❌ 未实现 | 无 JWT/会话校验；仅网关可做验签（`CELL_VERIFY_SIGNATURE`） |

**修复建议**：在网关或本细胞内引入 RBAC（角色、权限码、菜单/按钮权限），接口鉴权时校验权限码。

---

### 3.2 菜单权限 / 按钮权限

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 菜单/按钮权限 | ❌ 未实现 | 后端无菜单/按钮权限码；前端若由平台统一控制则需与后端权限一致 |

**修复建议**：定义权限码（如 `erp:gl:write`、`erp:ar:approve`），接口按权限码控制返回与操作。

---

### 3.3 数据权限（如本部门）

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 数据权限 | ❌ 未实现 | 仅有 `X-Tenant-Id` 租户隔离，无部门/组织/数据范围过滤 |

**修复建议**：若需「本部门」等数据权限，需在用户上下文带部门/组织，查询时过滤（如订单、发票按部门/业务员过滤）。

---

## 四、企业级特性验证

### 4.1 审批流程

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 审批流 | ❌ 未实现 | 无审批单、审批状态、审批历史；采购/销售/财务均无审批 |

**修复建议**：引入工作流引擎或简单审批状态机（草稿→提交→审批中→已通过/拒绝），关键单据（如 PO、发票）走审批。

---

### 4.2 报表导出

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 导出   | ❌ 未实现 | 无 Excel/CSV/PDF 导出接口；试算表、账龄等仅 JSON API |

**修复建议**：对试算表、账龄、凭证列表等提供 `?format=excel` 或 `Accept: application/vnd.ms-excel` 导出。

---

### 4.3 库存预警

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 库存预警 | ❌ 未实现 | 无库存余额、安全库存、最低库存；无预警接口与定时任务 |

**修复建议**：先实现库存余额与安全库存字段，再提供「低于安全库存」的查询/预警 API 或消息。

---

### 4.4 批次/序列号管理

| 检查项 | 状态     | 说明 |
|--------|----------|------|
| 批次/序列号 | ❌ 未实现 | 物料与库存无批次号、序列号字段；无出入库批次/序列号记录 |

**修复建议**：若需批次/序列号，在物料或库存表增加策略配置，在库存/流水表增加批次号、序列号及追溯查询。

---

## 五、部署可行性验证

### 5.1 Dockerfile

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 基础镜像 | ✅ | `python:3.11-slim` |
| 依赖安装 | ✅ | `requirements.txt` + pip |
| 工作目录与 COPY | ✅ | `/app`，COPY src/、合约等 |
| 端口 | ✅ | `ENV PORT=8002`，`EXPOSE 8002` |
| 启动命令 | ✅ | `CMD ["python", "src/app.py"]` |

**建议**：生产建议加非 root 用户、健康检查在镜像内可执行（若需）。

---

### 5.2 数据库初始化脚本

| 检查项 | 状态 | 说明 |
|--------|------|------|
| Schema 文件 | ✅ | `database_schema.sql` 存在，表结构完整（event_store、order_read_model、GL、AR/AP、MM、PP、audit_log） |
| 应用与库连接 | ❌ | **当前应用未接数据库**；`store.py` 为内存实现，未使用 `database_schema.sql` |

**影响**：生产必须接数据库，否则重启数据丢失。  
**修复建议**：增加 DB 适配层（如 MySQL），使用 `database_schema.sql` 做初始化；或提供迁移工具（如 Flyway/自定义脚本版本管理）。

---

### 5.3 健康检查接口

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 健康检查 | ✅ | `GET /health` 返回 `{"status":"up","cell":"erp"}`，200 |
| 依赖检查 | ❌ | 未检查 DB（因当前未接库）、未检查外部服务 |

**修复建议**：接入 DB 后，健康检查内增加 DB 只读查询（如 `SELECT 1`），失败时返回 503。

---

### 5.4 环境变量配置

| 变量 | 用途 | 文档/代码 |
|------|------|-----------|
| `PORT` | 服务端口 | ✅ 文档与 Dockerfile |
| `X-Tenant-Id` | 租户（由网关传入） | ✅ 文档 |
| `CELL_VERIFY_SIGNATURE` | 是否验签 | ✅ 代码 |
| `CELL_SIGNING_SECRET` | 验签密钥 | ✅ 代码 |
| `CELL_SECURITY_AUDIT_PATH` | 安全审计文件路径 | ✅ 代码 |

**缺失**：若后续接数据库，需补充 `DATABASE_URL` 或等价配置并在文档中说明。

---

## 六、不通过项汇总与修复优先级

| 序号 | 维度 | 不通过项 | 影响范围 | 修复建议 |
|------|------|----------|----------|----------|
| 1 | 业务 | 采购/销售/库存流程不闭环 | 无法支撑完整业财一体化 | 按规格书补采购申请、PO 行、入库/出库、库存表与流程 |
| 2 | 业务 | BOM 无子件、生产无领料/入库 | 生产计划无法执行 | 实现 BOM 子件 API 与 Store；实现领料与成品入库 |
| 3 | 数据 | 无外键、无软删除 | 引用与历史数据风险 | Schema 加 FK；主数据与单据加软删除并过滤 |
| 4 | 数据 | 操作日志未落库 | 合规与审计不足 | 写 `audit_log`；与 `_human_audit` 对齐字段 |
| 5 | 数据 | 分录无借贷平衡、收付款无校验与幂等 | 财务数据错误、重复付款 | 分录创建校验借贷平衡；收付款校验金额与幂等 |
| 6 | 权限 | 无 RBAC/菜单/数据权限 | 无法做细粒度管控 | 引入角色与权限码；接口按权限与数据范围过滤 |
| 7 | 企业 | 无审批、无报表导出、无库存预警、无批次 | 企业场景不完整 | 按优先级做审批流、导出、库存与预警、批次/序列号 |
| 8 | 部署 | 应用未接数据库 | 生产不可用 | 实现 DB 适配层并配置初始化脚本与健康检查 |

---

## 七、核心业务流程测试用例（建议）

以下用例可用于回归与验收，建议纳入 CI。

### 7.1 采购-应付-付款（当前能力范围内）

1. **创建采购订单**  
   - POST `/mm/purchase-orders`，`supplierId`、`documentNo`、`totalAmountCents`，带 `X-Request-ID`、`X-Tenant-Id`。  
   - 断言 201，返回 `poId`。

2. **创建应付发票**  
   - POST `/ap/invoices`，`supplierId`、`documentNo`、`amountCents`、`dueDate`。  
   - 断言 201，返回 `invoiceId`。

3. **付款登记**  
   - POST `/ap/invoices/{invoiceId}/payments`，`amountCents`。  
   - 断言 200，`status` 变为 3（已付）、`paidAmountCents` 等于发票金额。

4. **应付账龄**  
   - GET `/ap/ageing`。  
   - 断言已付发票不在账龄结果中（或金额为 0）。

### 7.2 销售-应收-收款（当前能力范围内）

1. **创建销售订单**  
   - POST `/orders`，`customerId`、`totalAmountCents`、`currency`，幂等键。  
   - 断言 201，返回 `orderId`。

2. **创建应收发票**  
   - POST `/ar/invoices`，`customerId`、`documentNo`、`amountCents`、`dueDate`。  
   - 断言 201。

3. **部分收款**  
   - POST `/ar/invoices/{id}/receipts`，`amountCents` 小于发票金额。  
   - 断言 200，`status` 为 2（部分收），`paidAmountCents` 正确。

4. **应收账龄**  
   - GET `/ar/ageing`。  
   - 断言未收/部分收发票出现在对应账龄区间。

### 7.3 总账（当前能力范围内）

1. **创建科目**  
   - POST `/gl/accounts`，`accountCode`、`name`、`accountType`。  
   - 断言 201。

2. **创建平衡分录**  
   - POST `/gl/journal-entries`，`documentNo`、`postingDate`，`lines` 中借贷合计相等。  
   - 断言 201；若后续加借贷平衡校验，则提交不平衡分录应 400。

3. **试算表**  
   - GET `/gl/trial-balance`。  
   - 断言 200，`data` 含科目余额，借方/贷方/余额与分录一致。

4. **凭证列表**  
   - GET `/gl/journal-entries?dateFrom=...&dateTo=...`。  
   - 断言 200，列表含该期间凭证。

### 7.4 生产（当前能力范围内）

1. **创建物料与 BOM**  
   - POST `/mm/materials` 得 `materialId`；POST `/pp/boms`，`productMaterialId` 为该 ID。  
   - 断言 201。

2. **创建工单并报工**  
   - POST `/pp/work-orders`，`bomId`、`productMaterialId`、`plannedQuantity`。  
   - POST `/pp/work-orders/{id}/report`，`completedQuantity`。  
   - 断言工单 `status` 为 4，`completedQuantity` 正确。

### 7.5 幂等与异常（建议补充）

1. **同一 X-Request-ID 重复 POST 订单**  
   - 第二次应 409， body 含 `IDEMPOTENT_CONFLICT`。

2. **收款超过待收金额**  
   - 当前无校验；建议增加后断言 400 与明确错误码。

3. **不存在的资源 GET**  
   - GET `/orders/{invalidId}`、`/gl/accounts/{invalidCode}` 等，断言 404 与统一错误结构。

---

## 八、优化建议

### 8.1 性能

- **存储**：当前内存 Store 无法水平扩展且重启丢数据；接入数据库后，对热点表（如 `gl_journal_line`、`ar_invoices`）加索引（tenant_id、日期、状态等），并考虑分表/归档策略。  
- **列表接口**：`/orders`、`/gl/journal-entries` 等建议支持分页（`page`/`pageSize` 或 cursor），避免一次拉全量。  
- **账龄/试算表**：数据量大时可考虑物化视图或定时汇总表，接口读汇总结果。

### 8.2 用户体验与可维护性

- **错误信息**：统一错误体（如 `code`、`message`、`requestId`、`details`），必填项缺失、格式错误、业务规则违反时返回明确错误码与描述。  
- **API 文档**：`api_contract.yaml` 可补充 requestBody schema、响应示例与错误码列表，便于前后端对齐。  
- **版本与变更**：对外 API 建议带版本（如 `/api/v1/erp`），重大变更走新版本或兼容策略。

### 8.3 安全与合规

- **敏感操作**：付款、过账、删除等建议二次确认或审批链；操作写入 `audit_log` 并保留关键请求体哈希。  
- **脱敏**：日志与审计中客户/供应商名称、金额等按策略脱敏。  
- **密钥**：`CELL_SIGNING_SECRET` 仅通过环境变量或密钥管理服务注入，禁止写死在代码或配置文件中。

---

**报告结束。** 建议优先完成：数据库接入、分录借贷平衡与收付款校验/幂等、操作日志落库、外键与软删除；再按业务优先级补流程闭环（采购入库、销售出库、库存、BOM 子件与生产领料/入库）和权限与审批、报表导出等企业特性。

---

## 附录：已实施的优化（v1.2）

在报告基础上，以下项已在本仓库中落地：

| 优化项 | 实施说明 |
|--------|----------|
| 统一错误体 | 所有错误响应统一为 `code/message/details/requestId`，通过 `_err()` 输出 |
| 必填与业务校验 | 新增 `src/validators.py`，对创建类接口做必填校验；GL 分录强制借贷平衡；收付款校验金额 ≤ 待收/待付且 > 0 |
| 收付款幂等 | 收款/付款支持 `X-Request-ID`，同一请求 ID 重复调用返回同一结果且只记一笔 |
| 操作日志落库 | Store 内 `_audit_log` 列表 + `audit_append()`，关键写操作后调用；对接 DB 时可改为写 `audit_log` 表 |
| 软删除 | 各主数据与业务单支持软删除（`deletedAt`），列表与 GET 自动过滤已删除；新增各资源 DELETE 接口 |
| 分页 | 所有列表接口支持 `page`、`pageSize` 查询参数，响应含 `total/page/pageSize` |
| Schema | `database_schema.sql` 增加各表 `deleted_at`、外键（如 gl_journal_line→entry/account、pp_bom_item→bom/material、pp_work_order→bom）、`audit_log.resource_type/resource_id` |

详见：`src/validators.py`、`src/store.py`（audit_append、分页、软删除、收付款幂等）、`src/app.py`（校验与 _err 调用）、`docs/用户手册.md` 与 `docs/部署指南.md`。
