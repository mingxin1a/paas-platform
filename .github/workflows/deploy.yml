# 多环境分级部署：开发/测试/预发布/生产；生产环境需在 GitHub Environments 中配置 Required reviewers 实现人工审批
name: Deploy
on:
  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - staging
          - prod
      version:
        description: '版本号（可选，默认 latest）'
        required: false
        type: string
  workflow_run:
    workflows: [Build and Push]
    types: [completed]
    branches: [main, master]
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  deploy-dev:
    name: 部署到开发环境
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    environment:
      name: development
      url: https://dev.paas.example.com
    steps:
      - uses: actions/checkout@v4
      - name: 部署到开发
        run: |
          echo "Deploy to DEV: 使用 deploy/scripts 或 K8s/Docker 按 deploy/env/.env.dev 配置"
          echo "GATEWAY_URL=${{ vars.DEV_GATEWAY_URL || 'http://localhost:8000' }}"
          echo "VERSION=${{ github.sha }}"
      - name: 验收测试（开发）
        run: |
          echo "Run smoke tests against DEV"
          echo "smoke_done"

  deploy-test:
    name: 部署到测试环境
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    if: success()
    environment:
      name: test
      url: https://test.paas.example.com
    steps:
      - uses: actions/checkout@v4
      - name: 部署到测试
        run: |
          echo "Deploy to TEST: 使用 deploy/env/.env.test"
          echo "VERSION=${{ github.sha }}"
      - name: 验收测试（测试）
        run: |
          echo "Run integration + smoke against TEST"
          echo "acceptance_done"

  deploy-staging:
    name: 部署到预发布环境
    runs-on: ubuntu-latest
    needs: [deploy-test]
    if: success()
    environment:
      name: staging
      url: https://staging.paas.example.com
    steps:
      - uses: actions/checkout@v4
      - name: 部署到预发布
        run: |
          echo "Deploy to STAGING: 使用 deploy/env/.env.staging"
          echo "VERSION=${{ github.sha }}"
      - name: 验收测试（预发布）
        run: |
          echo "Run full acceptance against STAGING"
          echo "acceptance_done"

  deploy-prod:
    name: 部署到生产环境
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: success()
    environment:
      name: production
      url: https://paas.example.com
    steps:
      - uses: actions/checkout@v4
      - name: 部署到生产
        run: |
          echo "Deploy to PROD: 使用 deploy/env/.env.prod，需人工审批后执行"
          echo "VERSION=${{ github.sha }}"
      - name: 生产验收
        run: |
          echo "Run smoke against PROD"
          echo "prod_acceptance_done"
