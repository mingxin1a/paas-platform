# 智能制造全场景业务联动手册

**版本**：1.0  
**适用范围**：批次1（CRM/ERP/OA/SRM）+ 批次2（MES/WMS/TMS）全流程联动  
**原则**：所有联动仅通过 PaaS 层标准化接口与事件总线实现，模块间零代码耦合，严格解耦。

---

## 一、联动架构概览

```
                    ┌─────────────────────────────────────────────────────────────────┐
                    │              事件总线 (POST/GET /api/events)                       │
                    └─────────────────────────────────────────────────────────────────┘
                      ▲ 发布事件                    │ 轮询消费
        ┌─────────────┼─────────────┬───────────────┼───────────────┬─────────────┐
        │             │             │               │               │             │
   ERP 订单创建   MES 生产订单   MES 生产完成   WMS 入库/出库完成   TMS 签收完成   (其他)
        │             │             │               │               │             │
        └─────────────┴─────────────┴───────────────┴───────────────┴─────────────┘
                                        │
                                        ▼
                    ┌─────────────────────────────────────────────────────────────────┐
                    │           联动 Worker (platform_core/sync_worker)                 │
                    │  按事件类型调用：网关 /api/v1/<cell>/<path>，不直连任何细胞        │
                    └─────────────────────────────────────────────────────────────────┘
```

- **细胞**：仅向网关 `POST /api/events` 发布领域事件，不直接调用其他细胞。
- **联动 Worker**：独立进程，轮询 `GET /api/events`，根据事件类型通过网关代理调用各细胞 API。

---

## 二、业务流程与对接说明

### 2.1 ERP → MES → WMS 全流程（生产链路）

| 步骤 | 触发 | 事件类型 | Worker 动作 | 说明 |
|------|------|----------|-------------|------|
| 1 | ERP 销售订单创建（含 orderLines 时） | `erp.order.created` | 调用 MES `POST /production-plans`、`POST /production-orders` | 按订单行生成生产计划与生产订单，orderNo=ERP orderId |
| 2 | MES 生产订单创建 | `mes.production_order.created` | 调用 `GET /production-orders/<id>/material-requirements` 获取 BOM 物料需求，再调用 WMS `POST /outbound-orders`（typeCode=picking）、`POST /outbound-orders/<id>/lines` | 根据 BOM 生成 WMS 生产备料/领料出库单 |
| 3 | 仓库执行领料出库 | （人工/扫码） | WMS `POST /outbound-orders/<id>/ship` | 生产领料出库，扣减库存 |
| 4 | MES 生产完成 | `mes.production_order.completed` | 调用 WMS `POST /inbound-orders`（typeCode=production，sourceOrderId=mesOrderId，erpOrderId=orderNo）、`POST /inbound-orders/<id>/lines` | 生成 WMS 生产入库单 |
| 5 | 仓库执行生产入库 | （人工/扫码） | WMS `POST /inbound-orders/<id>/receive` | 生产入库，增加库存 |
| 6 | WMS 生产入库完成 | `wms.inbound.completed`（typeCode=production） | 调用 ERP `PATCH /orders/<erpOrderId>`，body `{ "orderStatus": 3 }` | 回传 ERP 更新订单状态为「生产完成」、更新库存视角 |

**ERP 销售订单扩展（智能制造）**  
- 创建订单时可传 `orderLines`：`[{ "productSku": "SKU001", "quantity": 10 }]`，用于驱动 MES 按行生成生产订单。  
- 未传 `orderLines` 时，Worker 按单行默认产品（PROD-DEFAULT、数量 1）生成一条 MES 生产订单。  
- **订单状态约定**：1=待审，2=已审，3=生产完成，4=已送达。

**MES 接口要点**  
- `POST /production-plans`：planNo、productSku、plannedQty、planDate。  
- `POST /production-orders`：workshopId、orderNo（建议=ERP orderId）、productSku、quantity、planId。  
- `GET /production-orders/<orderId>/material-requirements`：返回 BOM 展开的 requirements（materialSku、requiredQuantity）。  
- 生产订单状态 2 时发布 `mes.production_order.completed`，payload 含 orderNo（即 ERP 订单 ID）、productSku、quantity。

**WMS 接口要点**  
- 生产备料：`POST /outbound-orders`，typeCode=picking，sourceOrderId=MES 生产订单 ID；再按物料需求逐行 `POST /outbound-orders/<id>/lines`。  
- 生产入库：`POST /inbound-orders`，typeCode=production，sourceOrderId=MES 订单 ID，erpOrderId=ERP 订单 ID；再 `POST /inbound-orders/<id>/lines` 成品行。  
- 入库完成后事件 payload 需带 typeCode、erpOrderId，供 Worker 回写 ERP。

### 2.2 WMS → TMS 联动（销售出库与运输）

| 步骤 | 触发 | 事件类型 | Worker 动作 | 说明 |
|------|------|----------|-------------|------|
| 1 | 创建销售出库单 | （业务侧） | WMS `POST /outbound-orders`，typeCode=sales，**建议传 erpOrderId** | 与 ERP 订单关联，便于签收回写 |
| 2 | 仓库执行销售出库 | （人工/扫码） | WMS `POST /outbound-orders/<id>/ship` | 销售出库 |
| 3 | WMS 销售出库完成 | `wms.outbound.completed`（typeCode=sales） | 调用 TMS `POST /shipments`，body 含 origin、destination、**wmsOutboundOrderId**、**erpOrderId** | 自动生成运输订单 |
| 4 | TMS 签收 | （人工） | TMS `POST /delivery-confirm`，shipmentId | 到货确认 |
| 5 | TMS 签收完成 | `tms.shipment.delivered` | Worker 调用 WMS `PATCH /outbound-orders/<wmsOutboundOrderId>`（status=3）、ERP `PATCH /orders/<erpOrderId>`（orderStatus=4） | 回传 WMS 出库单「已签收」、ERP 订单「已送达」 |

**TMS 运单扩展**  
- `POST /shipments` 支持 body 字段：wmsOutboundOrderId、erpOrderId。  
- 签收后发布 `tms.shipment.delivered` 时 payload 带 shipmentId、wmsOutboundOrderId、erpOrderId，供 Worker 回写 WMS/ERP。

**WMS 出库单状态**  
- 支持 `PATCH /outbound-orders/<orderId>`，body `{ "status": 2|3 }`（2=已发货，3=已签收），供 TMS 签收完成后回写。

### 2.3 全流程数据追溯（批次/序列号）

实现从 **供应商 → 采购入库 → 生产领料 → 生产加工 → 成品入库 → 销售出库 → 客户** 的全链路追溯，符合工业产品追溯要求。

- **采购入库**：WMS 入库单行支持 lotNumber、serialNumbers；入库收货时写入批次/序列号。  
- **生产领料**：WMS 出库（typeCode=picking）扣减库存时关联批次（如 FIFO）；MES 领料记录可带批次。  
- **生产加工**：MES 报工、生产入库时传递 lotNumber、serialNumbers（见 MES `POST /production-inbounds`）。  
- **成品入库**：WMS 生产入库收货时写入成品批次/序列号，与 MES 生产入库单一致。  
- **销售出库**：WMS 出库时带出批次/序列号，便于下游 TMS/客户追溯。  

**追溯查询（PaaS 标准化接口）**  
- MES：`GET /trace/lot/<lot_number>`、`GET /trace/order/<order_id>`、`GET /trace/serial/<serial_number>`。  
- WMS：`GET /trace/serial/<serial_number>`、批次/库位查询。  
- 跨系统追溯：通过 event 与单号关联（erpOrderId、sourceOrderId、wmsOutboundOrderId 等）在各自系统按单号/批次/序列号查询后拼接链路。

---

## 三、流程配置与开关

联动由 **环境变量** 控制，在启动 **联动 Worker** 时生效（不影响细胞本身）。

| 变量名 | 含义 | 默认值 | 说明 |
|--------|------|--------|------|
| `LINK_ERP_TO_MES` | ERP→MES 联动 | `1` | 销售订单自动生成 MES 生产计划与生产订单 |
| `LINK_MES_TO_WMS` | MES→WMS 联动 | `1` | 生产订单创建时生成 WMS 备料出库单；生产完成时生成 WMS 生产入库单 |
| `LINK_WMS_TO_TMS` | WMS→TMS 联动 | `1` | 销售出库完成时自动生成 TMS 运输订单 |
| `SMART_MFG_DEFAULT_WORKSHOP_ID` | 默认车间 ID | `WS01` | 联动创建 MES 生产订单时使用的车间 |
| `SMART_MFG_DEFAULT_WAREHOUSE_ID` | 默认仓库 ID | `WH01` | 联动创建 WMS 出入库单时使用的仓库 |
| `GATEWAY_URL` | 网关地址 | `http://localhost:8000` | Worker 调用细胞 API 与事件拉取均经网关 |
| `EVENT_BUS_TOKEN` / `GATEWAY_TOKEN` | 鉴权 Token | `smoke-test` | 调用网关时的 Bearer Token |
| `SYNC_WORKER_POLL_INTERVAL_SEC` | 轮询间隔（秒） | `5` | 事件拉取间隔 |

**启动 Worker 示例**（项目根或 deploy 目录）：

```bash
# 仅开启智能制造链路，关闭 OA/数据湖
export LINK_ALL_TO_OA=0
export LINK_ALL_TO_DATALAKE=0
export LINK_ERP_TO_MES=1
export LINK_MES_TO_WMS=1
export LINK_WMS_TO_TMS=1
export GATEWAY_URL=http://localhost:8000
export SMART_MFG_DEFAULT_WORKSHOP_ID=WS01
export SMART_MFG_DEFAULT_WAREHOUSE_ID=WH01
python -m platform_core.sync_worker.worker
# 或：python deploy/run_sync_worker.py（若存在）
```

---

## 四、事件类型与 Payload 速查

| 事件类型 | 主要 Payload 字段 | 发布方 |
|----------|-------------------|--------|
| `erp.order.created` | orderId, tenantId, customerId, totalAmountCents, currency, **orderLines**（可选） | ERP |
| `mes.production_order.created` | orderId, tenantId, orderNo, productSku, quantity, planId, workshopId | MES |
| `mes.production_order.completed` | orderId, tenantId, orderNo, productSku, quantity | MES |
| `wms.inbound.completed` | orderId, tenantId, warehouseId, typeCode, **sourceOrderId**, **erpOrderId**（生产入库时） | WMS |
| `wms.outbound.completed` | orderId, tenantId, warehouseId, typeCode, **erpOrderId**, **sourceOrderId** | WMS |
| `tms.shipment.delivered` | shipmentId, tenantId, confirmId, **wmsOutboundOrderId**, **erpOrderId** | TMS |

---

## 五、异常处理方案

### 5.1 事件发布失败（细胞侧）

- 细胞内 `event_publisher.publish()` 为**非阻塞**：失败仅写日志，不影响主流程。  
- 建议：生产环境保证 `GATEWAY_URL` 可用；网关不可用时事件不落总线，对应联动本周期不执行，可后续通过业务补偿（如手工在 MES 补录生产订单、在 WMS 补录出库单）或重试发布解决。

### 5.2 Worker 调用下游失败

- Worker 对单条事件处理**不重试**（当前实现）：某次 HTTP 调用失败只记日志，不将事件重新入队。  
- **建议**：  
  - 生产可将事件总线替换为 Kafka/RabbitMQ，由 MQ 做重试与死信；  
  - 或定期通过 `GET /api/admin/events/dlq` 查看死信，人工/脚本补偿。

### 5.3 MES 无 BOM 导致无物料需求

- 若生产订单对应产品无 BOM 或 BOM 无行，`GET /production-orders/<id>/material-requirements` 返回 requirements 为空，Worker 不创建 WMS 备料出库单。  
- **建议**：在 MES 维护产品 BOM；或对无需备料的订单忽略该步骤，仅做生产入库与 ERP 回写。

### 5.4 WMS 库存不足导致领料/出库失败

- 生产备料出库单创建后，若仓库执行 `ship` 时库存不足会返回业务错误。  
- **建议**：保证采购入库或调拨先于生产领料；或通过安全库存与预警（WMS 提供）提前补货。

### 5.5 生产入库/销售出库回写 ERP 失败

- 若 Worker 的 PATCH ERP 请求失败（网络/4xx/5xx），当前不会重试。  
- **建议**：在 WMS 入库单/出库单上保留 erpOrderId；运维可根据 WMS 记录人工在 ERP 更新订单状态，或通过脚本调用 PATCH 接口补写。

### 5.6 幂等与重复事件

- 事件总线按 `eventId` 幂等接收；同一 eventId 不会重复入库。  
- 下游细胞接口应尽量支持幂等（如创建类接口使用 X-Request-ID），避免 Worker 重试或重复消费导致重复单据。

---

## 六、部署与依赖

- **网关**：必须先启动并可访问（`GATEWAY_URL`），提供 `POST /api/events`、`GET /api/events` 及 `/api/v1/<cell>/<path>` 代理。  
- **细胞**：ERP、MES、WMS、TMS 需已注册并可由网关转发。  
- **联动 Worker**：单独进程运行 `python -m platform_core.sync_worker.worker`，无需与网关同机；多实例时注意事件总线的消费语义（当前为内存队列时，多实例会各自拉取到相同事件，建议单实例 Worker）。

---

## 七、与批次1联动的关系

- 批次1 联动（CRM→ERP、ERP↔SRM、全模块→OA、全模块→数据湖）仍由同一 Worker 处理，与智能制造联动**并存**。  
- 可通过 `LINK_CRM_TO_ERP`、`LINK_ERP_TO_SRM`、`LINK_ALL_TO_OA`、`LINK_ALL_TO_DATALAKE` 独立开关批次1 逻辑；  
- `LINK_ERP_TO_MES`、`LINK_MES_TO_WMS`、`LINK_WMS_TO_TMS` 独立开关智能制造逻辑。

---

**文档归属**：PaaS 智能制造全场景业务联动  
**关联**：《模块间业务联动配置手册》《事件总线与跨细胞异步规范》《MES与ERP对接手册》
