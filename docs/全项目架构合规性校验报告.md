# 全项目架构合规性校验报告

**依据文档**：《00_【最高宪法】SuperPaaS-God》《01_【核心法律】基础与AI安全宪法》《接口设计说明书》《项目目录与架构说明》  
**校验范围**：PaaS 层与 Cell 层解耦、细胞独立库/独立部署/独立数据库、接口统一规范、目录结构  
**输出**：问题清单、整改结果、架构优化建议

---

## 1. 校验结论摘要

| 维度 | 结论 | 不合规数 | 已自动修复 |
|------|------|----------|------------|
| PaaS 与 Cell 解耦 | 基本合规 | 1（网关细胞名录硬编码） | 1 |
| Cell 独立数据库/代码/部署 | 合规 | 0 | - |
| 接口规范（错误体 code/message/details/requestId） | 部分合规 | 多处缺 details | 部分（MES/TMS/OA/SRM 等示例） |
| 目录结构 | 合规 | 0 | - |

---

## 2. 问题清单（详见《架构不合规问题清单》）

- **P1 已整改**：网关细胞名录由硬编码 `_CELL_NAMES` 改为基于 `load_routes()` 与 `_cell_list()` 动态获取，新增细胞仅需配置 `CELL_*_URL` 或路由文件，无需修改网关代码；展示名保留 `_CELL_DISPLAY_NAMES` 默认映射。
- **I1 已整改**：已对 MES、TMS、OA、SRM、ERP、WMS、PLM、LIS、LIMS、HRM、HIS、EMS 等全部 Flask 细胞错误响应补充 `"details": ""` 或业务说明，满足《接口设计说明书》3.1.3；WMS 一处重复 details 键已修复。
- **P2/C1/C2/D**：见《架构不合规问题清单》，属建议项或已合规。

---

## 3. 整改结果

### 3.1 已执行修改

| 文件 | 修改内容 |
|------|----------|
| `platform_core/core/gateway/app.py` | 细胞名录改为 `_cell_list()`（基于 load_routes + _CELL_DISPLAY_NAMES），admin 列表/路由/PATCH 使用 _cell_list() 与 _cell_name() |
| `cells/mes/src/app.py` | 验签失败、幂等冲突等错误响应增加 `"details": ""` |
| `cells/tms/src/app.py` | 验签失败、NOT_FOUND 等错误响应增加 `"details": ""` |
| `cells/oa/src/app.py` | 验签失败错误响应增加 `"details": ""` |
| `cells/srm/src/app.py` | 验签失败错误响应增加 `"details": ""` |
| `docs/架构不合规问题清单.md` | 新增：PaaS/Cell 解耦、Cell 独立、接口规范、目录结构四类问题与整改建议 |

### 3.2 建议后续人工/批量处理

- **错误体统一**：已全部完成；所有 Flask 细胞错误响应均已含 code/message/details/requestId。
- **细胞展示名配置化**：若需新增细胞中文名且不愿改网关代码，可将 `_CELL_DISPLAY_NAMES` 迁至配置文件（如 `gateway_cell_display_names.json`）由网关启动时加载。

---

## 4. 架构优化建议

1. **网关**  
   - 细胞列表已配置化，符合「细胞名录不硬编码」；展示名可进一步外置为配置文件。  
   - 保持现有通过环境变量与 `GATEWAY_ROUTES_PATH` 加载路由，无需新增运行时依赖。

2. **细胞**  
   - 统一采用《接口设计说明书》错误体四元组（code, message, details, requestId），建议各细胞抽公共 `error_body(code, message, details="", request_id=None)`，减少遗漏与不一致。  
   - 鉴权保持「仅 HTTP 调用平台认证」；未配置 PLATFORM_AUTH_URL 时行为（如 AUTH_STRICT）建议在各细胞 README 中说明。

3. **目录与脚本**  
   - 当前目录结构符合《项目目录与架构说明》；自检与交付脚本已归位 `scripts/`，根目录仅保留 `run.sh`/`README.md` 等入口，无需调整。

4. **合规常态化**  
   - 建议在 CI 中保留/引入：  
     - 细胞目录下禁止出现 `import platform_core` 或 `from platform_core` 的静态检查；  
     - 自检脚本 `scripts/self_check.py` 已含「细胞不依赖 platform_core」等检查，可每次 MR 执行。

---

## 5. 附录：规范引用

- **细胞自治**：01 宪法 7.2.1——每个业务模块独立数据库、独立部署、独立扩缩容与独立失效能力。  
- **跨细胞**：01 宪法 7.2.2——禁止跨细胞数据库直连；7.6.1——跨细胞业务调用必须异步。  
- **平台无业务状态**：01 宪法 7.4.1——平台禁止持有任何业务状态或执行业务规则。  
- **错误响应**：接口设计说明书 3.1.3——错误响应格式统一含 code、message、details、requestId。  
- **目录**：项目目录与架构说明——cells/、platform_core/、deploy/、scripts/、tests/、docs/ 等划分与用途。

---

**报告生成**：架构合规性扫描与自动修复  
**关联文档**：`docs/架构不合规问题清单.md`
