# 整体检验程序说明

**目的**：统一入口覆盖交付校验、每细胞健康与契约测试、冒烟测试，补全程序缺口并包括每个细胞。

---

## 1. 检验层次

| 层次 | 程序 | 说明 |
|------|------|------|
| **交付校验** | `verify_delivery` / `verify_all_cells` | 检查每个细胞：delivery.package、completion.manifest、cell_profile、api_contract、auto_healing、**src/app.py**、可选 Dockerfile/README/dist |
| **每细胞健康与契约** | `tests/test_all_cells_health.py` | 对每个细胞加载 app，请求 `/health` 及契约主列表 GET，不依赖网关 |
| **E2E/网关** | `tests/e2e/crm_integration_test.py` 等 | 经网关访问细胞（当前以 CRM 为主） |
| **冒烟** | `deploy/smoke_test.py` | 对已部署网关做健康检查；可选 `USE_ALL_CELLS=1` 或 `--all` 覆盖全部细胞路径 |
| **架构解耦校验** | `tests/test_architecture_decoupling.py` | 细胞无 platform_core 依赖；网关细胞名录配置化（可选，未完成时 skip） |

---

## 2. 入口与用法

### 2.1 一键整体检验（推荐）

```bash
python scripts/run_full_verification.py
```

执行顺序：  
1）全细胞交付校验 `evolution_engine/verify_all_cells.py`  
2）`pytest tests/`（含 `test_all_cells_health.py` 及 CRM/ERP/WMS 等既有测试）

- 仅跳过交付校验：`python scripts/run_full_verification.py --no-verify`
- 仅跳过测试：`python scripts/run_full_verification.py --no-tests`

### 2.2 仅交付校验

- **全细胞**（推荐）  
  ```bash
  python evolution_engine/verify_all_cells.py
  ```
- **单个细胞**  
  ```bash
  python evolution_engine/verify_delivery.py <CELL_NAME>
  # 或
  ./run.sh verify <CELL_NAME>
  # 或 ./scripts/verify_delivery.sh <CELL_NAME>
  ```
- 列出参与校验的细胞：  
  `python evolution_engine/verify_all_cells.py --list`

### 2.3 仅运行测试

```bash
python -m pytest tests/ -v --tb=short
```

其中 `tests/test_all_cells_health.py` 会为每个细胞执行：  
- `test_cell_health`：GET `/health` 返回 200 且含 `status=up`、`cell=<name>`  
- `test_cell_main_list_contract`：契约主列表 GET（带 X-Tenant-Id）返回 200 且为列表形态

### 2.4 冒烟测试（需网关与细胞已部署）

- 默认（网关 + CRM）：  
  ```bash
  python deploy/smoke_test.py
  ```
- 全部细胞（需网关配置并转发各细胞）：  
  ```bash
  USE_ALL_CELLS=1 python deploy/smoke_test.py
  # 或
  python deploy/smoke_test.py --all
  ```

---

## 3. verify_delivery 检查项（含可运行性）

- delivery.package  
- completion.manifest  
- cell_profile.md、api_contract.yaml  
- auto_healing.yaml  
- **src/app.py**（必须，可运行性）  
- 可选：Dockerfile、README.md、dist/PACKAGE.md（缺失时仅告警）

---

## 4. 覆盖的细胞

交付校验与 `test_all_cells_health` 自动发现 `cells/` 下所有子目录；主列表契约与冒烟使用下表路径：

| 细胞 | 主列表路径（契约/冒烟） |
|------|-------------------------|
| crm | /customers, /api/v1/crm/customers |
| erp | /orders, /api/v1/erp/orders |
| wms | /inventory, /api/v1/wms/inventory |
| hrm | /employees, /api/v1/hrm/employees |
| oa | /tasks, /api/v1/oa/tasks |
| mes | /work-orders, /api/v1/mes/work-orders |
| tms | /shipments, /api/v1/tms/shipments |
| srm | /suppliers, /api/v1/srm/suppliers |
| plm | /products, /api/v1/plm/products |
| ems | /consumption-records, /api/v1/ems/consumption-records |
| his | /patients, /api/v1/his/patients |
| lis | /samples, /api/v1/lis/samples |
| lims | /samples, /api/v1/lims/samples |

---

## 5. 与 self_check 的关系

`python scripts/self_check.py` 仅运行 `pytest tests/` 并生成健康报告，不执行 `verify_all_cells`。  
完整检验请使用 `python scripts/run_full_verification.py`。

---

**文档状态**：与当前脚本一致；新增或调整细胞时同步更新本文档与 `CELL_MAIN_GET`/`CELL_PATHS` 配置。
