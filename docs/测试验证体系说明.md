# 全平台测试验证体系说明

**原则**：细胞独立测试，无跨细胞耦合；平台层仅做集成与 E2E 编排。

**扩展说明**：全项目测试体系（PaaS 单元、Cell store 测试、集成、边界、E2E、一键执行与 CI 集成）见 **《全项目测试体系说明》**（`docs/全项目测试体系说明.md`）。

---

## 1. 覆盖率目标

| 批次 | 细胞 | 目标 |
|------|------|------|
| 批次1 | CRM、ERP、OA、SRM | ≥85% |
| 批次2 | MES、WMS、TMS | ≥70% |
| 批次3 | EMS、PLM、HIS、LIS、LIMS | 基础接口测试覆盖 |

各细胞在各自目录执行：`python -m pytest tests/ --cov=src --cov-report=term-missing`。  
覆盖率排除：`signing_verify.py`、`tests/`。

---

## 2. 测试分层

- **细胞单元/验收**：`cells/<cell>/tests/unit/`、`cells/<cell>/tests/acceptance/`，直接调用细胞 app，不经过网关。
- **PaaS 核心集成**：`tests/integration/test_paas_core.py`，需 `USE_REAL_GATEWAY=1` 与网关运行，验证健康、登录、代理。
- **全链路 E2E**：`deploy/core_business_flow_tests.py` 或 `tests/e2e/test_core_business_full_flow.py`（设 `E2E_FULL_FLOW=1`），经网关执行 CRM/ERP/WMS 等核心流程。

---

## 3. CI 中执行

- **GitHub Actions**：`.github/workflows/ci.yml`，对批次1/2/3 细胞依次执行 pytest。
- **GitLab CI**：`.gitlab-ci.yml`，`test:cells`、`test:platform` 阶段执行细胞与平台测试；`deploy:canary` 为手动灰度占位。

---

## 4. 本地全量

```bash
# 细胞单元测试（以 CRM 为例）
cd cells/crm && python -m pytest tests/ --cov=src

# 平台集成（需先启动网关）
USE_REAL_GATEWAY=1 GATEWAY_URL=http://localhost:8000 python -m pytest tests/integration/ -v

# 核心业务全链路（需网关与细胞运行）
E2E_FULL_FLOW=1 python -m pytest tests/e2e/test_core_business_full_flow.py -v
```
