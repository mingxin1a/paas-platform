# 全项目测试体系说明

## 1. 测试分层与覆盖率目标

| 层级 | 目录/范围 | 覆盖率目标 | 说明 |
|------|-----------|------------|------|
| PaaS 核心层 | `tests/unit_platform/`、`platform_core/` | ≥90% | 网关、熔断、配置、Sync Worker、租户 |
| 业务 Cell 层 | `cells/<cell>/tests/`、`cells/<cell>/src/` | ≥85% | 各细胞单元测试 + store 测试 |
| 集成测试 | `tests/integration/` | 核心场景覆盖 | ERP→MES→WMS、WMS→TMS 联动 |
| 边界测试 | `tests/boundary/` | 异常/404/409/429 | 错误响应、幂等、压力占位 |
| E2E | `tests/e2e_playwright/` | 主流程 | 网关健康、登录（需服务运行） |

## 2. 目录结构

```
tests/
├── unit_platform/          # PaaS 核心层单元测试
│   ├── test_gateway.py
│   ├── test_circuit_breaker.py
│   ├── test_gateway_config.py
│   ├── test_tenant_store.py
│   ├── test_session_store.py
│   └── test_sync_worker.py
├── integration/            # 集成测试
│   ├── test_paas_core.py   # 需 USE_REAL_GATEWAY=1
│   ├── test_erp_mes_wms_flow.py
│   └── test_wms_tms_flow.py
├── boundary/               # 边界与异常
│   ├── test_error_responses.py
│   └── test_stress_placeholder.py
├── e2e_playwright/         # Playwright E2E（可选）
│   └── test_login_and_health_flow.py
├── acceptance/             # 批次商用验收
└── test_all_cells_health.py
cells/<cell>/tests/
├── unit/                   # 细胞单元测试 + store 测试
│   ├── test_*_app.py
│   └── test_*_store.py
└── acceptance/
```

## 3. 一键执行

```bash
# 项目根目录执行：全量测试（含 PaaS 单元、各 Cell 单元、集成、边界）
python scripts/run_all_tests.py

# 仅 PaaS + 平台通用 + 集成 + 边界，不跑各 Cell
python scripts/run_all_tests.py --no-cells

# 含 Playwright E2E（需 pip install pytest-playwright && playwright install chromium）
python scripts/run_all_tests.py --e2e

# 指定报告目录
python scripts/run_all_tests.py --report-dir ./test-reports
```

或分步执行：

```bash
# PaaS 核心层单元测试 + 覆盖率
python -m pytest tests/unit_platform/ -v --cov=platform_core --cov-report=term-missing --cov-report=html:test-reports/coverage_platform

# 单个 Cell（以 ERP 为例）
cd cells/erp && python -m pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml

# 集成测试
python -m pytest tests/integration/ -v

# 边界测试
python -m pytest tests/boundary/ -v

# E2E（需网关运行）
GATEWAY_URL=http://localhost:8000 python -m pytest tests/e2e_playwright/ -v
```

## 4. 测试报告与覆盖率

- **PaaS 层覆盖率**：`python -m pytest tests/unit_platform/ --cov=platform_core --cov-report=html --cov-report=xml`，报告输出至 `htmlcov/` 或 `test-reports/coverage_platform/`。
- **Cell 层覆盖率**：在各 `cells/<cell>/` 下执行 `pytest tests/ --cov=src --cov-report=xml`，CI 可合并多份 `coverage.xml` 供 SonarQube 使用。
- **未覆盖场景与风险点**：见本节末尾「未覆盖与风险」表。

### 覆盖率报告解读

- `term-missing`：终端输出未覆盖行号。
- `html`：浏览器打开 `htmlcov/index.html` 查看逐文件覆盖。
- `xml`：供 SonarQube / 质量门禁使用。

### 未覆盖与风险点（示例）

| 场景/模块 | 说明 | 风险 |
|-----------|------|------|
| 网关真实代理转发 | 需启动细胞实例，集成测试用 USE_REAL_GATEWAY=1 | 本地/CI 未启动时跳过 |
| 数据湖 ingest | Sync Worker 中 LINK_ALL_TO_DATALAKE=0 时未测 | 生产开启时需单独验证 |
| Redis 会话存储 | session_store 未配置 Redis 时走内存 | 集群部署需手工或集成验证 |
| E2E 前端页面 | 仅测网关 API，未覆盖前端 SPA 交互 | 需单独前端 E2E 或手工 |

## 5. CI/CD 集成

- **代码提交触发**：push/PR 到 main/master 触发 CI（见 `.github/workflows/ci.yml`）。
- **流水线步骤**：Lint → 单元测试（批次1/2/3 细胞 + 平台）→ SonarQube → 集成测试（可选）。
- **平台单元测试**：CI 中增加对 `tests/unit_platform/` 的 pytest 执行；覆盖率可写入 artifact 并供 Sonar 使用。
- **集成/边界**：同一 workflow 中执行 `tests/integration/`、`tests/boundary/`；E2E 可选单独 job 且需部署网关后再跑。

建议 CI 中增加：

```yaml
- name: PaaS 核心层单元测试
  run: |
    pip install -r tests/requirements.txt
    python -m pytest tests/unit_platform/ -v --cov=platform_core --cov-report=xml -q
- name: 集成与边界测试
  run: python -m pytest tests/integration/ tests/boundary/ -v -q
```

## 6. 故障处理

- **Cell 加载失败**：确保从**项目根**执行 pytest，且已安装对应 cell 的 `requirements.txt`。
- **网关 create_app 失败**：检查 `platform_core` 是否在 `PYTHONPATH` 或从根目录运行。
- **集成测试跳过**：部分用例依赖 `load_cell_app("mes")` 等，若细胞目录或依赖缺失会 skip。
- **E2E 跳过**：未安装 `pytest-playwright` 或未启动网关时，E2E 用例会 `pytest.skip`。
- **覆盖率不足**：优先补全 `tests/unit_platform/` 与各 cell 的 `tests/unit/test_*_store.py`，再补边界与集成。

---

**文档归属**：`docs/`，与《测试验证体系说明》互补；覆盖率目标与 CI 以本说明为准。
