# 细胞模块接入校验报告

**校验依据**：细胞化架构规范、《接口设计说明书_V2.0》  
**校验范围**：cells 下除 _template 外全部业务模块（crm、erp、wms、hrm、oa、mes、tms、srm、plm、ems、his、lis、lims）  
**校验时间**：按扫描时点生成

---

## 一、校验结论汇总

| 模块 | 解耦（无PaaS耦合） | 健康检查 /health | 鉴权（Authorization） | 统一错误格式（code/message/details/requestId） | X-Response-Time | POST 幂等/X-Request-ID | 综合 |
|------|---------------------|-------------------|------------------------|------------------------------------------------|-----------------|-------------------------|------|
| crm  | ✅ 通过             | ✅ 有             | ✅ FastAPI 主入口有；Flask app 无 | ✅ 有（FastAPI 完整；Flask 部分含 details） | ✅ 有           | ✅ 有                   | 通过（建议统一走 FastAPI 入口） |
| erp  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| wms  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ✅ 有                                           | ✅ 有           | ✅ 有                   | 待改进 |
| hrm  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| oa   | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| mes  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| tms  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| srm  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| plm  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| ems  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| his  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| lis  | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |
| lims | ✅ 通过             | ✅ 有             | ⚠️ 缺                 | ⚠️ 部分缺 details                              | ✅ 有           | ✅ 有                   | 待改进 |

---

## 二、解耦校验

### 2.1 结论

- **未发现与 PaaS 层的代码耦合**。各细胞均未 `import` platform_core 或 deploy；仅在本目录内引用（如 `from .store`、`from .signing_verify`）。
- **signing_verify**：ems、his、lis、lims、plm、srm、tms 等模块的 `signing_verify.py` 仅在注释中写明“与 platform_core/core/cell_signing.py 规范实现”，本地实现 HMAC 验签，**无任何对 platform_core 的导入**，视为符合解耦要求。

### 2.2 建议

- 保持现状，不在细胞内引用 platform_core 或网关代码；鉴权通过网关或平台认证 HTTP 接口完成。

---

## 三、接口规范校验（《接口设计说明书》3.1.3）

### 3.1 健康检查

- **结论**：所有模块均提供 `GET /health`，返回 `{"status":"up","cell":"<模块名>"}`，符合网关注册与健康巡检要求。
- **建议**：无。

### 3.2 鉴权能力

- **规范要求**：请求头必须包含 **Authorization**（OAuth 2.0 + JWT）。
- **现状**：
  - **crm（FastAPI 主入口 src/main.py）**：具备 `require_auth` 依赖，校验 Authorization；可选 PLATFORM_AUTH_URL 通过 HTTP 校验。
  - **crm（Flask src/app.py）**、**erp / wms / hrm / oa / mes / tms / srm / plm / ems / his / lis / lims**：均**未**在应用层统一校验 Authorization 头；仅部分具备可选验签（CELL_VERIFY_SIGNATURE）。
- **问题点**：Flask 细胞及 CRM 的 Flask 入口未强制校验 Authorization，与《接口设计说明书》4.1 要求不符。
- **修改建议**：
  1. **方案 A（推荐）**：在网关层统一校验 Authorization，细胞仅信任网关转发的请求；在文档中明确“鉴权由网关/平台完成”，细胞侧不再重复校验。
  2. **方案 B**：在细胞内增加鉴权：在 Flask 的 `before_request` 中校验 `Authorization` 存在且以 `Bearer ` 开头，否则返回 401，body 为 `{"code":"UNAUTHORIZED","message":"缺少 Authorization","details":"","requestId":"..."}`；可选调用 PLATFORM_AUTH_URL 做 Token 校验。

### 3.3 统一错误响应格式

- **规范要求**：`{"code":"ERROR_CODE","message":"错误描述","details":"详细信息","requestId":"请求ID"}`。
- **现状**：多数模块错误响应已包含 `code`、`message`、`requestId`；**部分模块部分接口缺少 `details` 字段**（如 HIS、MES、ERP 等部分 404/400 仅返回 code、message、requestId）。
- **问题点**：缺少 `details` 时，与 3.1.3 不完全一致。
- **修改建议**：所有错误响应统一增加 `details` 字段，可为空字符串。例如：  
  `jsonify({"code":"NOT_FOUND","message":"订单不存在","details":"","requestId": rid}), 404`。

### 3.4 响应头 X-Response-Time

- **结论**：所有模块均在 `after_request` 中设置 `X-Response-Time`，符合要求。
- **建议**：无。

### 3.5 POST/PUT 幂等与 X-Request-ID

- **规范要求**：POST/PUT 必须支持基于 **X-Request-ID** 的幂等；请求头必须包含 X-Request-ID。
- **现状**：各模块均在 POST 创建逻辑中使用 `X-Request-ID` 做幂等（idem_get/idem_set 或等价实现）；部分模块在请求未带 X-Request-ID 时使用 `_req_id()` 自动生成，未强制要求客户端必传。
- **问题点**：《接口设计说明书》要求“必须包含”，细胞层未对 POST/PUT 显式校验“无 X-Request-ID 即 400”。
- **修改建议**：对 POST/PUT 请求在入口处校验：若 `X-Request-ID` 为空，则返回 400，body 为 `{"code":"BAD_REQUEST","message":"POST/PUT 必须包含 X-Request-ID","details":"","requestId":""}`。

---

## 四、问题点与修改建议汇总

| 序号 | 问题类型       | 涉及模块 | 修改建议 |
|------|----------------|----------|----------|
| 1    | 缺少鉴权校验   | 除 crm(FastAPI) 外全部 | 网关统一鉴权并在文档说明，或在细胞 before_request 中校验 Authorization 并可选调用 PLATFORM_AUTH_URL |
| 2    | 错误响应缺 details | erp、wms、hrm、oa、mes、tms、srm、plm、ems、his、lis、lims 等 | 所有错误响应统一增加 `"details":""` 或具体说明 |
| 3    | POST/PUT 未强制 X-Request-ID | 所有 Flask 细胞 | 在 POST/PUT 处理前校验 X-Request-ID 存在，否则返回 400 |

---

## 五、可直接执行的网关路由配置 YAML

以下 YAML 可直接作为网关路由配置使用（如通过 `GATEWAY_ROUTES_PATH` 指向该文件，或与现有 `deploy/gateway_route_spec.yaml` 对齐）。网关实际代理路径为 `/api/v1/<cell>/<path>`，转发到对应 upstream 的 `<path>`。

```yaml
# 网关路由配置 - 细胞模块接入（可直接使用）
# 用法：GATEWAY_ROUTES_PATH 指向本文件，或按 id/upstream 注入环境变量 CELL_*_URL
# 网关代理路径：/api/v1/<cell>/<path> -> upstream/<path>
routes:
  - id: cell-crm
    path_prefix: /api/cells/crm
    upstream: http://crm-cell:8001
  - id: cell-erp
    path_prefix: /api/cells/erp
    upstream: http://erp-cell:8002
  - id: cell-wms
    path_prefix: /api/cells/wms
    upstream: http://wms-cell:8003
  - id: cell-hrm
    path_prefix: /api/cells/hrm
    upstream: http://hrm-cell:8004
  - id: cell-oa
    path_prefix: /api/cells/oa
    upstream: http://oa-cell:8005
  - id: cell-mes
    path_prefix: /api/cells/mes
    upstream: http://mes-cell:8006
  - id: cell-tms
    path_prefix: /api/cells/tms
    upstream: http://tms-cell:8007
  - id: cell-srm
    path_prefix: /api/cells/srm
    upstream: http://srm-cell:8008
  - id: cell-plm
    path_prefix: /api/cells/plm
    upstream: http://plm-cell:8009
  - id: cell-ems
    path_prefix: /api/cells/ems
    upstream: http://ems-cell:8010
  - id: cell-his
    path_prefix: /api/cells/his
    upstream: http://his-cell:8011
  - id: cell-lis
    path_prefix: /api/cells/lis
    upstream: http://lis-cell:8012
  - id: cell-lims
    path_prefix: /api/cells/lims
    upstream: http://lims-cell:8013
```

保存为 `deploy/gateway_route_spec.yaml` 或任意路径，并在网关环境中设置 `GATEWAY_ROUTES_PATH=/path/to/该文件` 即可生效；或继续使用现有 docker-compose 中的 `CELL_*_URL` 环境变量注入方式。

---

## 六、附录：校验方法说明

- **解耦**：在 cells 下全文检索 `platform_core`、`from deploy`、`import.*gateway` 等，确认无代码引用。
- **健康检查**：检索 `/health`、`route.*health`，确认返回 status/cell。
- **鉴权**：检索 `Authorization`、`require_auth`、`before_request` 中鉴权逻辑。
- **错误格式**：检索 `code`、`message`、`requestId`、`details` 在错误响应中的使用。
- **X-Response-Time**：检索 `after_request`、`X-Response-Time`。
- **幂等**：检索 `X-Request-ID`、`idem_get`、`idem_set` 及 POST 处理逻辑。

**报告状态**：已生成，可根据后续代码变更重新扫描更新。
