# 安全合规说明

本文档基于《安全渗透测试报告》与 OWASP Top 10、等保 2.0 相关要求，说明平台已实施的安全防护与合规要点。

## 1. 访问控制

- **管理端越权防护**：网关对所有 `/api/admin/*` 接口校验当前用户 `role=admin`，非管理员 token 返回 403。
- **业务接口**：统一要求 `Authorization` Bearer token；细胞侧按 `X-Tenant-Id` 做租户隔离。
- **生产建议**：开启 `GATEWAY_VALIDATE_TENANT=1` 校验租户有效性与配额。

## 2. 认证与会话

- **生产禁用 Mock 认证**：设置 `GATEWAY_USE_MOCK_AUTH=0`，并对接认证中心；否则禁止使用内置 Mock 账号（admin/admin 等）上线。
- **登录限流**：登录接口按 IP 限流（`GATEWAY_LOGIN_RATE_PER_IP_PER_MIN`，默认 10 次/分钟），降低暴力破解与撞库风险。
- **会话存储**：支持 Redis（`GATEWAY_SESSION_STORE_URL`）多实例共享；TTL 可配（`GATEWAY_SESSION_TTL_SEC`）。

## 3. 安全响应头

网关在全局响应中增加：

- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`

生产环境可在此基础上增加 `Content-Security-Policy`、`Strict-Transport-Security`（HTTPS）等。

## 4. 注入与敏感数据

- **SQL**：细胞层使用参数化查询（? 占位），未发现 SQL 注入风险。
- **敏感信息**：不在响应与日志中输出明文密码、密钥；审计日志需对敏感字段脱敏。

## 5. 依赖与代码安全

- **CI 门禁**：每次提交运行 Bandit（Python SAST，高危及以上阻断）、Safety（依赖漏洞，存在则阻断）。
- **本地扫描**：执行 `./scripts/security_scan.sh` 可复现门禁结果。

## 6. 合规与审计

- **操作审计**：网关与细胞支持审计日志（trace_id、租户、用户、操作），落盘不可删改。
- **加签验签**：网关与细胞支持 `GATEWAY_SIGNING_SECRET` / `CELL_VERIFY_SIGNATURE`，抗抵赖。

## 7. 渗透测试与报告

- 漏洞清单与修复状态见《安全渗透测试报告》。
- 上线前建议再次执行人工渗透与依赖扫描，并确保 `GATEWAY_USE_MOCK_AUTH=0` 且已对接认证中心。
