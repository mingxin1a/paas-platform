# 模块间业务联动配置手册

本文档说明批次1 模块（CRM、ERP、OA、SRM）之间的业务流程联动规则、开启/关闭配置及异常处理方案。**所有联动仅通过 PaaS 层标准化接口与事件总线实现，不产生模块间代码耦合**。

---

## 一、联动架构概览

```
                    ┌─────────────────────────────────────────────────────────┐
                    │                    事件总线 (POST/GET /api/events)        │
                    └─────────────────────────────────────────────────────────┘
                      ▲ 发布事件          │ 轮询消费
        ┌──────────────┼──────────────┬───┴──────────────┬──────────────┐
        │              │              │                  │              │
   CRM 合同签章   ERP 订单/采购单   SRM 报价中标   OA 审批完成    (其他事件)
        │              │              │                  │              │
        └──────────────┴──────────────┴──────────────────┴──────────────┘
                                        │
                                        ▼
                    ┌─────────────────────────────────────────────────────────┐
                    │           联动 Worker (platform_core/sync_worker)        │
                    │  按事件类型调用：网关 /api/v1/<cell>/<path>、数据湖 ingest  │
                    └─────────────────────────────────────────────────────────┘
```

- **细胞**：仅向网关 `POST /api/events` 发布领域事件，不直接调用其他细胞。
- **联动 Worker**：独立进程，轮询 `GET /api/events`，根据事件类型调用网关代理的细胞 API 及数据湖 `POST /api/datalake/ingest`。

---

## 二、联动规则明细

### 2.1 CRM → ERP

| 触发条件 | 事件类型 | Worker 动作 | 说明 |
|----------|----------|-------------|------|
| CRM 合同创建且已填 `signedAt` | `crm.contract.signed` | 调用 `POST /api/v1/erp/orders` 生成销售订单 | 客户合同/销售订单自动同步至 ERP，无需手动录入 |

**请求体示例（Worker 调用 ERP）**：`{ "customerId", "totalAmountCents", "currency": "CNY" }`，来自事件 payload 的 customerId、amountCents、currency。

### 2.2 ERP → SRM

| 触发条件 | 事件类型 | Worker 动作 | 说明 |
|----------|----------|-------------|------|
| ERP 创建采购申请 | `erp.purchase_requisition.created` | 调用 `POST /api/v1/srm/rfqs` 生成询价单 | 采购申请自动同步至 SRM 生成询报价单 |
| SRM 报价中标 | `srm.quote.awarded` | 调用 `POST /api/v1/erp/mm/purchase-orders` 生成采购订单 | 供应商报价完成后回传 ERP 生成采购订单 |

**采购申请**：ERP 提供 `POST /mm/purchase-requisitions`，body `{ "demandDesc", "totalAmountCents" }`，创建后发布 `erp.purchase_requisition.created`。  
**报价中标**：SRM 提供 `POST /quotes/<quote_id>/award`，调用后发布 `srm.quote.awarded`，Worker 据此创建 ERP 采购订单。

### 2.3 全模块 → OA 审批中心

| 触发条件 | 事件类型 | Worker 动作 | 说明 |
|----------|----------|-------------|------|
| CRM 合同签章 | `crm.contract.signed` | 创建 ERP 订单后，再 `POST /api/v1/oa/approvals`（typeCode=contract，formData 含 sourceCell/sourceId/sourceType） | 合同进入 OA 统一审批 |
| ERP 销售订单创建 | `erp.order.created` | `POST /api/v1/oa/approvals`（typeCode=sales_order，formData 含 sourceCell=erp, sourceId=orderId, sourceType=order） | 销售订单审批 |
| ERP 采购订单创建 | `erp.purchase_order.created` | `POST /api/v1/oa/approvals`（typeCode=purchase_order，formData 含 sourceCell/sourceId/sourceType） | 采购订单审批 |

**审批完成后回写**：OA 提供 `POST /approvals/<instance_id>/complete`（body `{ "approved": true|false }`），完成后发布 `oa.approval.completed`。Worker 根据 formData 中的 sourceCell、sourceId、sourceType 回写：

- `sourceCell=erp`, `sourceType=order` → `PATCH /api/v1/erp/orders/<sourceId>`，body `{ "orderStatus": 2 }`
- `sourceCell=erp`, `sourceType=purchase_order` → `PATCH /api/v1/erp/mm/purchase-orders/<sourceId>`，body `{ "status": 2 }`
- `sourceCell=crm`, `sourceType=contract` → `PATCH /api/v1/crm/contracts/<sourceId>`，body `{ "status": 2 }`

OA 审批类型扩展：除原有 purchase、reimburse、leave 外，支持 **contract**、**sales_order**、**purchase_order** 用于联动单据。

### 2.4 全模块 → 数据湖

| 触发条件 | 事件类型 | Worker 动作 | 说明 |
|----------|----------|-------------|------|
| 上述任意业务事件 | 各类 | 调用 `POST /api/datalake/ingest`（tenantId、cellId、table、records） | 业务数据自动入湖，支撑跨模块经营分析（销售业绩、采购成本、审批效率等） |

入湖表名约定：crm→contracts/opportunities；erp→orders、purchase_requisitions、purchase_orders；srm→quotes；其他事件可落 events 表。报表与可视化在数据湖侧配置（见《数据湖使用与对接手册》）。

---

## 三、开启/关闭配置

联动由 **环境变量** 控制，在启动 **联动 Worker** 时生效（不影响细胞本身）。

| 变量名 | 含义 | 默认值 | 说明 |
|--------|------|--------|------|
| `LINK_CRM_TO_ERP` | CRM→ERP 联动 | `1` | 设为 `0` 关闭：合同签章不再自动生成 ERP 销售订单 |
| `LINK_ERP_TO_SRM` | ERP↔SRM 联动 | `1` | 设为 `0` 关闭：采购申请不同步 SRM 询价、报价中标不回传 ERP 采购订单 |
| `LINK_ALL_TO_OA` | 全模块→OA 审批 | `1` | 设为 `0` 关闭：不再自动创建 OA 审批单、不回写审批结果 |
| `LINK_ALL_TO_DATALAKE` | 全模块→数据湖 | `1` | 设为 `0` 关闭：不再向数据湖 ingest |
| `GATEWAY_URL` | 网关地址 | `http://localhost:8000` | Worker 调用细胞 API 与事件拉取均经网关 |
| `DATALAKE_URL` | 数据湖地址 | 空 | 非空时 Worker 将业务数据 POST 至该地址 `/api/datalake/ingest` |
| `EVENT_BUS_TOKEN` / `GATEWAY_TOKEN` | 鉴权 Token | `smoke-test` | 调用网关与数据湖时的 Bearer Token |
| `SYNC_WORKER_POLL_INTERVAL_SEC` | 轮询间隔（秒） | `5` | 越大则延迟越高、负载越低 |

**启动 Worker**（在项目根目录或 deploy 下）：

```bash
# 仅开启 CRM→ERP 与数据湖，关闭 OA 与 ERP↔SRM
export LINK_ERP_TO_SRM=0
export LINK_ALL_TO_OA=0
export GATEWAY_URL=http://localhost:8000
export DATALAKE_URL=http://localhost:8006
python deploy/run_sync_worker.py
```

---

## 四、异常处理方案

### 4.1 事件发布失败（细胞侧）

- 细胞内 `event_publisher.publish()` 为**非阻塞**：失败仅写日志，不影响主流程。
- 建议：生产环境配置 `EVENT_BUS_URL` / `GATEWAY_URL` 为可用网关；网关不可用时事件不落总线，对应联动本周期不会执行，可后续通过业务补偿（如手工在 ERP 补录订单）或重试发布解决。

### 4.2 Worker 调用下游失败

- Worker 对单条事件处理**不重试**（当前实现）：某次 HTTP 调用失败只记日志，不将事件重新入队。
- **建议**：
  - 生产可将事件总线替换为 Kafka/RabbitMQ，由 MQ 做重试与死信；
  - 或定期通过 `GET /api/admin/events/dlq` 查看死信，人工/脚本补偿。

### 4.3 数据湖不可用

- 若 `DATALAKE_URL` 未配置或 ingest 返回非 2xx，Worker 仅记录失败，**不影响** CRM→ERP、ERP→SRM、全模块→OA 的联动。
- 经营分析报表可后续通过数据湖的批量导入或重新同步补齐。

### 4.4 审批回写失败

- OA 审批完成后，Worker 根据 formData 回写 ERP/CRM。若 PATCH 失败（如网络超时、目标细胞返回 4xx/5xx），当前不会重试。
- **建议**：在 OA 审批单 formData 中保留 sourceCell、sourceId、sourceType；运维可根据 OA 审批记录人工在对应模块更新状态，或通过脚本调用 PATCH 接口补写。

### 4.5 幂等与重复事件

- 事件总线按 `eventId` 幂等接收；同一 eventId 不会重复入库。
- 下游细胞接口应尽量支持幂等（如 ERP 订单创建使用 X-Request-ID），避免 Worker 重试或重复消费导致重复单据。

---

## 五、事件类型与 Payload 速查

| 事件类型 | 主要 Payload 字段 | 发布方 |
|----------|-------------------|--------|
| `crm.contract.signed` | contractId, customerId, contractNo, amountCents, currency, tenantId, opportunityId, signedAt | CRM |
| `erp.order.created` | orderId, tenantId, customerId, totalAmountCents, currency | ERP |
| `erp.purchase_requisition.created` | requisitionId, tenantId, demandDesc, totalAmountCents | ERP |
| `erp.purchase_order.created` | poId, tenantId, supplierId, documentNo, totalAmountCents | ERP |
| `srm.quote.awarded` | quoteId, tenantId, rfqId, supplierId, amountCents, currency | SRM |
| `oa.approval.completed` | instanceId, tenantId, status, formData (含 sourceCell, sourceId, sourceType), typeCode | OA |

---

## 六、部署与依赖

- **网关**：必须先启动并可访问（`GATEWAY_URL`），提供 `POST /api/events`、`GET /api/events` 及 ` /api/v1/<cell>/<path>` 代理。
- **数据湖**（可选）：若需入湖，配置 `DATALAKE_URL` 并启动数据湖服务（如 `python deploy/run_datalake.py`）。
- **联动 Worker**：单独进程运行 `python deploy/run_sync_worker.py`，无需与网关同机；可多实例时注意事件总线的消费语义（当前为内存队列，多实例会各自拉取到相同事件，适合单实例 Worker）。

---

**文档归属**：PaaS 批次1 模块间业务联动  
**关联**：《数据湖使用与对接手册》《事件总线与跨细胞异步规范》
