# 全项目依赖与部署清单

**技术栈**：Python 3.11（平台与细胞）、Node.js 20（前端构建）、Docker / Docker Compose、Nginx（前端静态托管）。  
**解耦原则**：平台与细胞依赖分离；各细胞仅持有自身 `requirements.txt` 与 `PORT`，不依赖 PaaS 内部地址。

---

## 一、依赖清单

### 1. platform_core（网关、治理中心、监控、配置加载）

| 文件 | 说明 |
|------|------|
| **platform_core/requirements.txt** | 网关、治理中心、监控中心 Python 依赖 |

**内容**：
```
flask>=2.3.0
psutil>=5.9.0
PyYAML>=6.0
```

- `flask`：网关、监控 HTTP 服务  
- `psutil`：红绿灯 CPU 检测（可选）  
- `PyYAML`：网关路由 YAML 解析（GATEWAY_ROUTES_PATH 指向 .yaml 时）

---

### 2. cells（业务细胞，各模块独立）

| 文件 | 说明 |
|------|------|
| **cells/requirements.txt** | 细胞通用依赖（与各细胞 requirements.txt 一致） |
| **cells/<name>/requirements.txt** | 各细胞独立依赖（不依赖 platform_core） |

**内容（每个细胞）**：
```
flask>=2.3.0
```

各细胞仅需 Flask；验签等为自实现，无 platform_core 引用。

---

### 3. 双端前端（客户端、管理端）

| 文件 | 说明 |
|------|------|
| **frontend/package.json** | 客户端前端依赖 |
| **frontend-admin/package.json** | 管理端前端依赖 |

**主要依赖**（两者一致）：
- `react`、`react-dom`、`react-router-dom`
- `vite`、`@vitejs/plugin-react`、`typescript`

**安装**：`cd frontend && npm install` / `cd frontend-admin && npm install`

---

### 4. 测试与脚本

| 文件 | 说明 |
|------|------|
| **tests/requirements.txt** | 平台测试（pytest、flask） |

---

## 二、Docker 与一键启动

### 1. 统一 docker-compose

| 文件 | 说明 |
|------|------|
| **deploy/docker-compose.yml** | 全平台一键启动：治理中心、网关、监控、13 个细胞、双端前端，同网 `paas-net` |

**服务与端口**：

| 服务 | 宿主机端口 | 说明 |
|------|------------|------|
| governance | 8005 | 治理中心：注册发现、健康巡检、链路与 RED 指标 API，详见 docs/微服务治理与治理中心API.md |
| gateway | 8000 | 统一入口，路由到各细胞（可选从治理中心发现并上报） |
| monitor | 9000 | 监控中心 |
| crm-cell ~ lims-cell | 8001~8013（仅内网） | 13 个细胞，仅暴露于 Docker 网络 |
| frontend | 5173 | 客户端（Nginx 托管构建产物，/api 代理到网关） |
| frontend-admin | 5174 | 管理端（同上） |

### 2. 配置（解耦）

| 文件 | 说明 |
|------|------|
| **deploy/.env.example** | 示例配置：网关端口、各细胞 URL（仅网关使用）、前端端口 |
| **deploy/.env** | 实际使用：复制 .env.example 为 .env 后修改 |

**细胞侧**：各 service 仅注入 `PORT=8xxx`，不注入 `CELL_*_URL`（该配置仅网关使用）。

### 3. 一键启动命令

```bash
# 在项目根目录
cp deploy/.env.example deploy/.env
# 按需修改 deploy/.env 后：
docker compose -f deploy/docker-compose.yml --env-file deploy/.env up -d

# 或在 deploy 目录下
cd deploy
cp .env.example .env
docker compose --env-file .env up -d
```

### 4. 访问

- 网关：http://localhost:8000  
- 客户端：http://localhost:5173（前端请求 /api 会由 Nginx 代理到网关）  
- 管理端：http://localhost:5174  

---

## 三、Dockerfile 一览

| 镜像 | Dockerfile | 构建上下文 |
|------|------------|------------|
| gateway | deploy/Dockerfile.gateway | 项目根 |
| governance | deploy/Dockerfile.governance | 项目根 |
| monitor | deploy/Dockerfile.monitor | 项目根 |
| frontend | deploy/Dockerfile.frontend | 项目根 |
| frontend-admin | deploy/Dockerfile.frontend-admin | 项目根 |
| <cell>-cell | cells/<name>/Dockerfile | cells/<name> |

各细胞 Dockerfile 统一：`COPY requirements.txt` → `pip install -r requirements.txt` → `COPY src/` 等，仅 `ENV PORT` 不同。

---

## 四、配置解耦原则

1. **网关**：通过 `env_file` 或环境变量持有 `CELL_*_URL`，由部署或 .env 提供，不写死在代码中。  
2. **细胞**：仅接收 `PORT`、可选 `CELL_VERIFY_SIGNATURE` / `CELL_SIGNING_SECRET`，不读取网关或其他细胞地址。  
3. **前端**：构建时无后端地址；运行时 Nginx 将 /api 代理到 `gateway:8000`（Docker 网络内服务名）。  

---

**文档状态**：与当前 requirements.txt、package.json、docker-compose 一致。
