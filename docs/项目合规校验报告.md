# 项目合规校验报告

**依据文档**：《00_【最高宪法】SuperPaaS-God.md》《02_概要设计说明书.md》《接口设计说明书.md》《01_【核心法律】基础与AI安全宪法》  
**校验范围**：PaaS 地基与 SaaS 细胞解耦、平台无业务状态、细胞独立隔离、乐高原则（独立安装/卸载）  
**校验时间**：基于当前代码与配置的全量扫描  
**结论**：平台层与细胞层在**运行时无代码级耦合**（细胞未依赖 platform_core），但**平台与部署/前端存在多处与“细胞名录”的硬编码耦合**，新增细胞需改平台或配置多处，不符合「乐高原则」与「平台无业务状态」的严格解读。以下按优先级从高到低列出不符合项及修改建议。

---

## 一、合规原则摘要（依据文档）

| 来源 | 核心条款 |
|------|----------|
| **00 宪法** | 元规则 #7 集装箱原则：接口是神圣契约；#11 乐高原则：功能模块必须能独立安装、卸载、计费；#10 生物学原则：服务是细胞，细胞可死、神经须通。 |
| **01 核心法律 7.2** | 细胞自治：每个业务模块必须具备独立数据库、独立部署、独立扩缩容与独立失效能力。 |
| **01 核心法律 7.4** | 平台无业务状态原则：平台禁止持有任何业务状态或执行业务规则。 |
| **02 概要设计** | 细胞化架构：每个功能模块都是独立的“细胞”，具有自治能力；细胞间通过标准事件通信；支持热插拔和独立扩展。 |
| **接口设计说明书** | 2.1 集装箱原则：接口必须有严格契约；物理隔离确保故障不扩散。 |

**解耦与隔离的判定标准**：  
- PaaS 层不得硬编码“有哪些业务细胞”及其业务含义（名称、路径、权限等）；细胞名录与元数据应由配置或注册发现。  
- 业务细胞不得依赖 platform_core 的代码或包；细胞仅通过标准 HTTP/事件与网关/其他细胞交互。

---

## 二、不符合项清单（按优先级排序）

### P0（高）：平台层硬编码细胞名录与权限，违反「平台无业务状态」与「乐高原则」

#### 1. 网关硬编码细胞 ID 与显示名称

| 项目 | 内容 |
|------|------|
| **文件** | `platform_core/core/gateway/app.py` |
| **位置** | 约 119–124 行 |
| **问题** | `_CELL_NAMES` 字典硬编码 13 个细胞 id 与中文名（如 `"crm": "客户关系"`）。`admin_cells_list()` 仅遍历该字典；`admin_cells_patch(cell_id)` 校验 `cell_id not in _CELL_NAMES`，导致仅此列表内细胞可被启用/停用。新增细胞必须修改平台代码。 |
| **违反** | 01 7.4 平台无业务状态；00 #11 乐高原则（独立安装需改平台代码）。 |
| **修改建议** | 细胞名录与显示名改为配置驱动：从环境变量、配置文件或注册中心（如 `load_routes()` 的 keys + 可选 `CELL_DISPLAY_NAMES` 或 YAML 中的 `name`）动态获取；`admin_cells_patch` 仅校验“该 cell 是否在路由/注册表中存在”，不依赖硬编码名单。 |

#### 2. 网关硬编码用户与细胞权限

| 项目 | 内容 |
|------|------|
| **文件** | `platform_core/core/gateway/app.py` |
| **位置** | 约 114–118 行 |
| **问题** | `_MOCK_USERS` 中每个用户的 `allowedCells` 为固定列表（如 `["crm", "erp", "wms", "hrm", "oa"]`）。用户权限与“细胞 id 列表”强耦合，且写在平台代码中。 |
| **违反** | 01 7.4 平台无业务状态（将“谁可访问哪些细胞”视为权限数据，应由认证/权限服务或配置提供，而非平台写死）。 |
| **修改建议** | 将 Mock 用户与 allowedCells 移至配置文件或环境变量；中长期由认证/权限服务（如 platform-auth）或目录服务返回“用户可访问的细胞列表”，网关仅做透传与校验，不维护业务侧权限名单。 |

---

### P1（中）：平台/部署/前端多处与细胞列表或路径耦合

#### 3. 演示页硬编码细胞列表

| 项目 | 内容 |
|------|------|
| **文件** | `platform_core/core/gateway/demo_cells.html` |
| **位置** | 约 26 行 |
| **问题** | `var CELLS = ['crm','erp','wms', ...]` 与 `app.py` 中 _CELL_NAMES 重复；新增细胞需同时改两处。 |
| **违反** | 乐高原则；单一事实来源（细胞列表应来自一处）。 |
| **修改建议** | 演示页通过网关现有接口获取细胞列表：例如请求 `/api/admin/cells`（需携带 Authorization），用返回的 `data[].id` 渲染；或由服务端渲染时注入从 `load_routes()` 得到的 cell id 列表，避免前端/静态页硬编码。 |

#### 4. 客户端前端硬编码细胞配置

| 项目 | 内容 |
|------|------|
| **文件** | `frontend/src/config/cells.ts` |
| **位置** | 全文 `CELLS` 数组 |
| **问题** | 所有细胞的 id、name、description、path、listKey、idKey、labelMap 等均硬编码。新增细胞或修改展示需改前端代码；且与网关/目录的“细胞列表”不一致时易脱节。 |
| **违反** | 乐高原则（独立安装时前端应能自动展示新细胞）；02 细胞化与热插拔。 |
| **修改建议** | 细胞基础列表从网关/目录 API 获取（如 `/api/admin/cells` 或未来 `/api/v1/catalog/cells`），前端仅保留“展示增强”（如 labelMap、默认 path）的本地配置或由细胞自描述（如 api_contract 中的 info）提供；未配置的细胞使用默认展示（id + name）。 |

#### 5. 冒烟测试硬编码细胞路径

| 项目 | 内容 |
|------|------|
| **文件** | `deploy/smoke_test.py` |
| **位置** | 约 12–26 行 `CELL_PATHS` |
| **问题** | 每个细胞的网关路径（如 `/api/v1/crm/customers`）硬编码；新增细胞需改冒烟脚本。 |
| **违反** | 乐高原则；部署/测试与细胞名录耦合。 |
| **修改建议** | 从网关 `/api/admin/cells` 获取细胞 id 列表，再按约定规则（如 `/api/v1/{cell_id}/health` 或从细胞 api_contract 中读取主路径）生成待测路径；或由各细胞在交付物中声明“冒烟路径”，脚本读取 cells 目录下各细胞 manifest 汇总后请求。 |

#### 6. 平台测试硬编码细胞主列表路径

| 项目 | 内容 |
|------|------|
| **文件** | `tests/test_all_cells_health.py` |
| **位置** | 约 14–28 行 `CELL_MAIN_GET` |
| **问题** | 每个细胞的主列表 GET 路径（如 crm→/customers）硬编码；新增细胞需改测试。 |
| **违反** | 乐高原则；测试与细胞契约应来自细胞自身描述。 |
| **修改建议** | 从各细胞 `api_contract.yaml` 或 `completion.manifest` 中解析“主列表路径”（如首个 list 类 GET path），或约定细胞在交付物中声明 `smoke_or_main_path`；测试发现细胞后动态解析，避免平台测试维护细胞路径表。 |

#### 7. 部署与路由配置仅包含部分细胞

| 项目 | 内容 |
|------|------|
| **文件** | `deploy/docker-compose.yml`、`deploy/gateway_route_spec.yaml` |
| **位置** | 服务定义与 routes 数组 |
| **问题** | docker-compose 仅定义 gateway + crm/erp/wms/hrm 四细胞；gateway_route_spec.yaml 仅 4 条路由。其余细胞（oa、mes、tms 等）未在默认部署与路由中，新增细胞需改部署与路由文件。 |
| **违反** | 乐高原则（期望“独立安装”即可接入）；与“细胞名录由配置驱动”一致性问题。 |
| **修改建议** | 视为“当前部署包含哪些细胞”的部署时配置，可保留；但建议：① 网关不依赖硬编码 _CELL_NAMES（见 P0-1）；② 提供“按 cells 目录或 manifest 批量生成 docker-compose 片段 / gateway_route_spec”的脚本或文档，使新增细胞时仅需加配置或跑脚本，无需手改多文件。 |

---

### P2（低）：文档/注释与规范引用，无运行时耦合

#### 8. 细胞内注释引用 platform_core 规范

| 项目 | 内容 |
|------|------|
| **文件** | 多个 `cells/*/src/signing_verify.py` 首行注释 |
| **问题** | 注释写“platform_core/core/cell_signing.py 规范实现”，仅为说明与平台规范一致，无 import 或运行时依赖。 |
| **合规** | 符合「细胞不依赖 platform_core 代码」；各细胞自实现验签，与平台规范文档对齐。 |
| **建议** | 保持现状；若需进一步隔离观感，可改为“与《接口设计说明书》及 00 修正案 #5 验签规范一致”，不写具体平台路径。 |

#### 9. 细胞文档中的架构描述

| 项目 | 内容 |
|------|------|
| **文件** | 如 `cells/crm/crm_自主产品规格说明书.md` |
| **问题** | 文档中写“后端仅通过 platform_core/core/gateway（PaaS 网关）暴露”，为架构说明，非代码依赖。 |
| **合规** | 无运行时耦合。 |
| **建议** | 无需修改。 |

#### 10. platform_core 中 cell_signing 的“引用”说明

| 项目 | 内容 |
|------|------|
| **文件** | `platform_core/core/cell_signing.py` 文档字符串 |
| **问题** | 写明“各细胞可将本文件复制为 src/signing_verify.py，或通过依赖 platform_core 引用”。若细胞采用“依赖 platform_core 引用”，将形成对 platform_core 的代码依赖。 |
| **当前** | 各细胞均为“复制实现”，未依赖 platform_core，故当前合规。 |
| **建议** | 若坚持「细胞零依赖 platform_core」，在文档中明确推荐“仅复制实现、不依赖 platform_core 包”；或将验签规范抽成独立规范库（与 platform_core 解耦），细胞依赖该规范库。 |

---

## 三、业务细胞模块（cells 目录）隔离性结论

| 检查项 | 结果 | 说明 |
|--------|------|------|
| **是否 import platform_core** | 通过 | 全量扫描 cells 下所有 .py：无 `from platform_core` 或 `import platform_core`。 |
| **是否依赖 platform 包/路径** | 通过 | 无对 platform_core 的依赖声明；各细胞仅使用 stdlib、Flask、本地 `store`/`signing_verify`。 |
| **signing_verify 实现方式** | 通过 | 各细胞自带 `src/signing_verify.py`，与 platform_core/core/cell_signing.py 算法一致，为“复制实现”，无运行时依赖。 |
| **测试的 sys.path** | 通过 | 如 cells/crm/tests、cells/wms/tests 等仅将**本细胞目录**加入 sys.path（如 `parent.parent.parent` 指向 cells/crm 或 cells/wms），用于加载本细胞 `src.app`，未引入平台。 |

**结论**：当前所有业务细胞模块满足**独立隔离、不依赖 platform_core 代码**的要求；PaaS 与细胞的**代码边界**清晰。需改进的是**平台与部署/前端的“细胞名录与路径”配置化**，避免硬编码导致违反乐高原则与平台无业务状态。

---

## 四、修改建议优先级汇总

| 优先级 | 序号 | 文件 | 问题简述 | 建议动作 |
|--------|------|------|----------|----------|
| **P0** | 1 | platform_core/core/gateway/app.py | 硬编码 _CELL_NAMES | 细胞名录与显示名改为配置/注册驱动 |
| **P0** | 2 | platform_core/core/gateway/app.py | 硬编码 _MOCK_USERS.allowedCells | 用户与细胞权限改为配置或认证服务 |
| **P1** | 3 | platform_core/core/gateway/demo_cells.html | 硬编码 CELLS 数组 | 从 /api/admin/cells 或服务端注入获取 |
| **P1** | 4 | frontend/src/config/cells.ts | 硬编码 CELLS 全量配置 | 基础列表从 API 获取，前端仅保留展示增强 |
| **P1** | 5 | deploy/smoke_test.py | 硬编码 CELL_PATHS | 从网关或细胞 manifest 动态生成路径 |
| **P1** | 6 | tests/test_all_cells_health.py | 硬编码 CELL_MAIN_GET | 从 api_contract/manifest 解析主路径 |
| **P1** | 7 | deploy/docker-compose.yml、gateway_route_spec.yaml | 仅 4 细胞 | 提供脚本/文档支持按目录或 manifest 扩展 |
| **P2** | 8–10 | 多处注释与文档 | 规范引用或“可引用 platform_core” | 可选：统一为“规范一致”表述；明确不推荐细胞依赖 platform_core |

---

## 五、合规符合项（无需修改）

- **细胞自治**：各细胞独立目录、独立端口、独立 Docker 服务、独立存储（store），无跨细胞库直连。  
- **跨细胞仅事件/接口**：细胞间经网关或事件交互，无跨细胞 DB 直连。  
- **平台无业务数据**：网关不存储订单/客户等业务数据，仅做路由、鉴权、透传。  
- **细胞无 platform_core 依赖**：所有细胞未 import platform_core，验签为自实现副本。  
- **接口契约**：各细胞具备 api_contract.yaml、统一响应与错误码，符合集装箱原则。  
- **trace_id / 请求头**：网关与细胞支持 X-Request-ID、X-Tenant-Id、X-Trace-Id 透传，符合接口设计说明书与 CT 扫描原则。

---

**报告编制**：基于《00_【最高宪法】SuperPaaS-God》《02_概要设计说明书》《接口设计说明书》及《01_核心法律》7.2、7.4 等条款。  
**维护建议**：P0 项建议在下一迭代优先落地；P1 可与“细胞目录/注册发现”能力一并改造；P2 可按文档规范统一时顺带调整。
