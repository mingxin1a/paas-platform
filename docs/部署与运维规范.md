# 部署与运维规范（待补充项 §12、§13）

**依据**：01 5.2 不可抵赖与告警；00 #5 抗抵赖；待补充项清单 §12 告警联动、§13 签名/验签策略。

---

## 1. 告警与安全审计联动（§12）

验签失败、红绿灯拒绝、熔断打开等已通过以下方式输出，部署时须与告警通道联动：

| 事件 | 输出位置 | 建议告警规则 |
|------|----------|----------------|
| 验签失败 | `CELL_SECURITY_AUDIT_PATH` 文件或 logger `security_audit`；网关/细胞 WARNING 日志 | 同一 cell 5 分钟内 ≥3 次验签失败 → 告警（邮件/钉钉/短信） |
| 红绿灯拒绝 | gateway logger `gateway`，message=red_light_reject | 出现 red_light_reject → 告警（负载高） |
| 熔断打开 | gateway 返回 503 CIRCUIT_OPEN，_json_log warn circuit_open | 503 且 code=CIRCUIT_OPEN → 告警 |

**实施**：在日志采集侧（如 ELK、Loki）或 APM 中配置上述规则，并对接告警通道（邮件/钉钉/企业微信/短信）。

---

## 2. 签名/验签强制策略（§13）

- **当前**：验签为可选。网关仅在配置 `GATEWAY_SIGNING_SECRET` 时加签；细胞仅在 `CELL_VERIFY_SIGNATURE=1` 且 `CELL_SIGNING_SECRET` 时验签。
- **生产环境建议**：为满足 00 #5 / 01 5.2 抗抵赖，**生产环境应强制启用**：
  - 网关：必须配置 `GATEWAY_SIGNING_SECRET`（与细胞共享密钥，建议 KMS 或密钥管理服务注入）。
  - 细胞：必须配置 `CELL_VERIFY_SIGNATURE=1` 与 `CELL_SIGNING_SECRET`（与网关一致）。
- **密钥管理**：禁止明文写在代码或普通配置文件中；使用环境变量或云厂商/KMS 注入，定期轮换。
- **细胞验签实现单源**：细胞侧验签逻辑以 **platform_core/core/cell_signing.py** 为规范实现（与网关 signing 算法一致）。各细胞可复制该文件为 `src/signing_verify.py`，或通过依赖 platform_core 引用，以避免实现漂移。

---

## 3. 其他

- 红绿灯：生产可调 `GATEWAY_CPU_THRESHOLD`（默认 80）、`GATEWAY_TRAFFIC_LIGHT_ENABLED=1`。
- 日志：保证 JSON 日志与 trace_id 可被采集，便于 CT 扫描（3 分钟内定位）。

---

**文档状态**：与 00/01 及待补充项一致；部署时按本规范执行。
