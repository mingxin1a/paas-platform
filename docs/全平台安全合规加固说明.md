# 全平台安全合规加固说明

**依据**：《01_核心法律》基础与AI安全宪法、《敏感数据加密与脱敏规范》。  
**原则**：不破坏细胞化架构、不修改细胞核心业务逻辑；通过网关与平台能力叠加实现。

---

## 1. 敏感字段全链路

| 环节 | 要求 | 实现 |
|------|------|------|
| **传输** | HTTPS | 由部署层保证（Nginx/Ingress TLS、GATEWAY 仅内网时可由上游终止 TLS）。生产必须 HTTPS。 |
| **存储** | AES 加密 | 平台提供 `platform_core.core.sensitive`：`encrypt_at_rest` / `decrypt_at_rest`，密钥由 `SENSITIVE_AES_KEY` 或 KMS 注入。细胞可选用。 |
| **展示** | 脱敏 | 同上：`mask_phone`、`mask_id_no`、`mask_email`、`mask_contract_no`、`mask_amount_cents`。CRM/TMS/HIS 等已对手机/身份证/金额做展示脱敏。 |

---

## 2. 接口防护

| 能力 | 说明 |
|------|------|
| **防刷/限流** | 网关 `platform_core.core.gateway.rate_limit`：按 IP、按 Token 双维度，滑动窗口。环境变量：`GATEWAY_RATE_LIMIT_ENABLED=1`、`GATEWAY_RATE_LIMIT_IP_PER_MIN=120`、`GATEWAY_RATE_LIMIT_TOKEN_PER_MIN=200`。超限返回 **429 RATE_LIMIT**。 |
| **签名验证** | 网关与细胞间 HMAC-SHA256 签名（`GATEWAY_SIGNING_SECRET` / `CELL_SIGNING_SECRET`），细胞 `CELL_VERIFY_SIGNATURE=1` 时验签。 |
| **SQL 注入** | 细胞使用参数化查询或 ORM；内存版无 SQL。接入真实 DB 时严禁拼接 SQL。 |
| **XSS** | 前端对用户输入做转义；接口返回 JSON 不执行。 |
| **CSRF** | 生产环境建议：敏感操作需 Cookie + SameSite=Strict；或接口要求 `X-CSRF-Token`（由登录接口下发）。 |

---

## 3. 操作审计日志

- **落盘即不可删改**：网关每次请求后向 `glass_house/operation_audit.log` **仅追加**写入一条 JSON，不提供删除/覆盖接口。
- **检索**：`GET /api/admin/audit-logs?since=&to=&traceId=&tenantId=&cell=&limit=`（需 Authorization）。
- **导出**：`GET /api/admin/audit-logs/export` 下载 `operation_audit.log` 文件。
- 环境变量 `SUPERPAAS_ROOT` 指向项目根目录时，`glass_house` 位于其下。

---

## 4. 细胞接入双认证

- **Token**：登录后 `Authorization: Bearer <token>`，网关校验 `_TOKEN_USER`（生产对接认证服务）。
- **应用密钥（可选）**：`X-App-Key` + 环境变量 `GATEWAY_APP_KEYS`（如 `crm:key1,wms:key2`）或 `GATEWAY_APP_KEY`（单密钥）。配置后，带 `X-App-Key` 的请求必须密钥合法，否则 401 INVALID_APP_KEY。

---

## 5. 错误码

统一见《错误码规范》及 `docs/api/错误码表.md`；网关返回格式：`{ "code": "XXX", "message": "...", "details": "...", "requestId": "..." }`。
