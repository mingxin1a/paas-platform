# 生产级部署运维手册

**版本**：1.0  
**适用范围**：SuperPaaS 单机 Docker 与 K8s 集群部署、多环境配置、版本更新与故障处理。

---

## 一、部署体系概览

| 维度 | 单机 Docker | K8s 集群 |
|------|-------------|----------|
| 编排 | docker-compose.yml | Namespace + Deployment/StatefulSet + Service + Ingress + HPA |
| 配置 | deploy/.env、deploy/env/.env.\{dev,test,staging,prod} | ConfigMap、Secret、Kustomize overlay |
| 一键部署 | deploy/deploy.sh | deploy/scripts/k8s_apply_all.sh |
| 增量更新 | deploy.sh --only=SERVICE | kubectl set image / rollout restart |
| 回滚 | deploy/scripts/deploy_rollback.sh docker | deploy_rollback.sh k8s / kubectl rollout undo |
| 启停 | deploy/scripts/service_control.sh docker | service_control.sh k8s |
| 环境检查 | deploy/scripts/env_check.sh docker | env_check.sh k8s |

---

## 二、单机 Docker 部署

### 2.1 前置条件

- Docker、Docker Compose（或 `docker compose`）已安装
- 如需环境检查：`./deploy/scripts/env_check.sh docker` 或 `./deploy/scripts/env_check.sh`（同时检查 .env）

### 2.2 一键全量部署

```bash
# 从项目根执行
cp deploy/.env.example deploy/.env
# 按需编辑 deploy/.env（端口、GATEWAY_URL 等）
./deploy/deploy.sh
```

执行流程：环境检查 → 依赖就绪 → PaaS 核心（governance、monitor、gateway）→ 细胞批量 → 双端前端 → 冒烟测试。任一步失败且未加 `--no-rollback` 时，将自动停止本次已启动的服务并写日志到 `deploy/deploy.log`。

### 2.3 多环境切换（开发/测试/预发布/生产）

四套环境配置位于 `deploy/env/`：

- `deploy/env/.env.dev` — 开发
- `deploy/env/.env.test` — 测试
- `deploy/env/.env.staging` — 预发布
- `deploy/env/.env.prod` — 生产

一键使用某环境部署：

```bash
./deploy/deploy.sh --env=dev
./deploy/deploy.sh --env=prod
```

脚本将使用对应 `.env.<env>` 作为本次部署的环境变量来源，不覆盖 `deploy/.env`。

### 2.4 增量更新（仅重启/重建指定服务）

```bash
./deploy/deploy.sh --only=gateway,crm-cell
./deploy/deploy.sh --only=frontend,frontend-admin --skip-build
```

- `--only=SERVICE1,SERVICE2`：只启动或更新这些服务  
- `--skip-build`：不重新构建镜像，仅拉取并启动/重启容器  

### 2.5 可选组件：Redis、联动 Worker

- **Redis**（会话共享）：  
  `docker compose -f deploy/docker-compose.yml --env-file deploy/.env --profile with-redis up -d`

- **联动 Worker**（ERP→MES→WMS→TMS 等）：  
  `docker compose -f deploy/docker-compose.yml --env-file deploy/.env --profile with-sync-worker up -d`

- 同时启用：`--profile with-redis --profile with-sync-worker`

### 2.6 版本回滚（Docker）

```bash
# 回滚全部服务（拉取当前镜像并重启，无版本标签时相当于重启）
./deploy/scripts/deploy_rollback.sh docker
# 回滚指定服务
./deploy/scripts/deploy_rollback.sh docker gateway
```

### 2.7 服务启停（Docker）

```bash
./deploy/scripts/service_control.sh docker stop
./deploy/scripts/service_control.sh docker start
./deploy/scripts/service_control.sh docker restart gateway
```

### 2.8 统一环境变量与失败重试

- 所有服务通过 `env_file: .env` 注入环境变量；端口、GATEWAY_URL 等均在 `.env` 或 `deploy/env/.env.<env>` 中配置。
- 容器配置 `restart: on-failure`，进程异常退出时由 Docker 自动重启。
- 部署脚本失败时会自动回滚本次启动的服务（可通过 `--no-rollback` 关闭）。

---

## 三、K8s 集群部署

### 3.1 前置条件

- kubectl 已配置且可访问目标集群
- 镜像已构建并推送到集群可访问的仓库（如 superpaas/gateway:latest、superpaas/cell-crm:latest 等）
- 可选：Ingress Controller（如 nginx-ingress）、metrics-server（用于 HPA）

### 3.2 资源清单说明

| 文件 | 说明 |
|------|------|
| 00-namespace.yaml | Namespace `paas` |
| 01-configmap.yaml | 非敏感环境变量（细胞 URL、端口等） |
| 02-secret.yaml | 敏感配置（Token 等），**部署前务必修改** |
| 10-redis-statefulset.yaml | Redis StatefulSet + Headless Service（可选） |
| 20-paas-core.yaml | 治理中心、网关、监控 Deployment + Service |
| 30-cells.yaml | 全部 13 细胞 Deployment + Service |
| 40-frontend.yaml | 客户端/管理端前端 Deployment + Service |
| 50-ingress.yaml | Ingress 统一入口 |
| 60-hpa.yaml | HPA（gateway、governance） |

### 3.3 一键部署

```bash
# 从项目根执行
./deploy/scripts/k8s_apply_all.sh
```

可选参数：

- `--no-redis`：不部署 Redis  
- `--no-ingress`：不部署 Ingress  
- `--no-hpa`：不部署 HPA  

### 3.4 分步部署（便于排查）

```bash
kubectl apply -f deploy/k8s/00-namespace.yaml
kubectl apply -f deploy/k8s/01-configmap.yaml
kubectl apply -f deploy/k8s/02-secret.yaml
kubectl apply -f deploy/k8s/10-redis-statefulset.yaml   # 可选
kubectl apply -f deploy/k8s/20-paas-core.yaml
kubectl apply -f deploy/k8s/30-cells.yaml
kubectl apply -f deploy/k8s/40-frontend.yaml
kubectl apply -f deploy/k8s/50-ingress.yaml
kubectl apply -f deploy/k8s/60-hpa.yaml
```

### 3.5 多环境（K8s）

- 通过 Kustomize overlay 或不同 ConfigMap/Secret 区分 dev/test/staging/prod（副本数、镜像 tag、资源限制等）。
- 或为不同环境使用不同 namespace（如 paas-dev、paas-prod），并 apply 同一套 YAML 到对应 namespace。

### 3.6 版本更新与回滚

- **更新镜像**：  
  `kubectl set image deployment/gateway gateway=superpaas/gateway:v2 -n paas`  
  然后：  
  `kubectl rollout status deployment/gateway -n paas`

- **回滚到上一版本**：  
  `./deploy/scripts/deploy_rollback.sh k8s gateway`  
  或：  
  `kubectl rollout undo deployment/gateway -n paas`

- **回滚到指定 Revision**：  
  `kubectl rollout history deployment/gateway -n paas`  
  `kubectl rollout undo deployment/gateway -n paas --to-revision=2`

### 3.7 服务启停（K8s 缩容/扩容）

```bash
# 停止：将核心与细胞 scale 到 0
./deploy/scripts/service_control.sh k8s stop
# 启动：恢复副本数
./deploy/scripts/service_control.sh k8s start
# 仅操作指定 Deployment
./deploy/scripts/service_control.sh k8s stop gateway,governance
./deploy/scripts/service_control.sh k8s start gateway,governance
```

### 3.8 集群高可用要点

- 网关、细胞等采用多副本（replicas≥2），由 Service 负载均衡。
- HPA 根据 CPU/内存自动扩缩容 gateway、governance。
- 生产建议：为网关配置 PodDisruptionBudget、合理 resource requests/limits；Ingress 配置 TLS；Secret 使用外部密管（如 sealed-secrets）。

---

## 四、环境配置说明

### 4.1 单机环境变量（.env）

| 变量 | 说明 | 示例 |
|------|------|------|
| GATEWAY_PORT | 网关宿主机端口 | 8000 |
| GOVERNANCE_PORT | 治理中心端口 | 8005 |
| MONITOR_PORT | 监控中心端口 | 9000 |
| FRONTEND_PORT / FRONTEND_ADMIN_PORT | 双端前端端口 | 5173 / 5174 |
| GATEWAY_URL | 对外访问网关地址（冒烟/E2E） | http://localhost:8000 |
| DEPLOY_ENV | 环境标识（dev/test/staging/prod） | 由 --env 注入 |
| GATEWAY_SESSION_STORE_URL | Redis 会话（可选） | redis://redis:6379/0 |

更多见 `deploy/.env.example`。

### 4.2 K8s ConfigMap / Secret

- 非敏感项：`deploy/k8s/01-configmap.yaml`（细胞 URL、端口等）。
- 敏感项：`deploy/k8s/02-secret.yaml`（GATEWAY_TOKEN、EVENT_BUS_TOKEN 等），生产务必替换为实际值并避免提交明文。

---

## 五、版本更新流程

### 5.1 Docker 单机

1. 拉取新镜像或重新构建：  
   `docker compose -f deploy/docker-compose.yml --env-file deploy/.env build --pull gateway`  
   `docker compose -f deploy/docker-compose.yml --env-file deploy/.env up -d gateway`
2. 验证：访问 http://localhost:8000/health，或执行 `python deploy/smoke_test.py`。
3. 若有问题：执行 `./deploy/scripts/deploy_rollback.sh docker gateway` 或全量回滚。

### 5.2 K8s

1. 更新镜像：  
   `kubectl set image deployment/gateway gateway=superpaas/gateway:v2 -n paas`
2. 观察发布：  
   `kubectl rollout status deployment/gateway -n paas`
3. 若有问题：  
   `kubectl rollout undo deployment/gateway -n paas`

---

## 六、故障处理

### 6.1 网关/细胞无法访问

- **Docker**：  
  `docker compose -f deploy/docker-compose.yml --env-file deploy/.env ps`  
  查看对应服务是否 Up；`docker compose logs gateway` 查看日志；确认宿主机端口未被占用。
- **K8s**：  
  `kubectl get pods -n paas`、`kubectl describe pod <name> -n paas`、`kubectl logs deployment/gateway -n paas`。

### 6.2 部署脚本报错

- 查看详细日志：`deploy/deploy.log`。
- 环境检查：`./deploy/scripts/env_check.sh`（docker 与 .env）或 `./deploy/scripts/env_check.sh k8s`。
- 若为 Docker 构建失败：检查 Dockerfile 与上下文路径；必要时 `--no-rollback` 保留已启动服务便于排查。

### 6.3 冒烟测试不通过

- 确认 GATEWAY_URL 与 .env 中一致（单机一般为 http://localhost:8000）。
- 确认网关已 healthy：Docker 下 `docker compose ps`，K8s 下 `kubectl get pods -n paas`。
- 使用 `--no-smoke` 先完成部署，再手动执行 `python deploy/smoke_test.py` 或 curl 检查。

### 6.4 K8s 镜像拉取失败

- 检查 imagePullSecrets（若为私有仓库）、镜像名与 tag、网络策略。
- 若使用本地镜像：确保节点已构建并打 tag（如 superpaas/gateway:latest）。

### 6.5 回滚后仍异常

- 清理状态：Docker 可 `docker compose down` 后重新 `deploy.sh`；K8s 可删除 Pod 让其重建，或再次 `rollout undo` 到更早 Revision。
- 检查 ConfigMap/Secret 与 .env 是否在回滚后仍指向错误配置。

---

## 七、日志与监控

- **部署日志**：单机部署写 `deploy/deploy.log`，标注各步骤 [OK]/[FAIL]。
- **环境检查日志**：`deploy/env_check.log`。
- **监控中心**：单机默认 http://localhost:9000；K8s 通过 Ingress 或 Service 暴露 monitor。
- 生产建议：将应用日志与指标接入集中日志与监控（如 Prometheus + Grafana），参见 `deploy/monitoring/` 与 `deploy/docs/监控与告警说明.md`。

---

## 八、附录：脚本速查

| 脚本 | 用途 |
|------|------|
| deploy/deploy.sh | 单机一键/增量部署，支持 --env、--only、--skip-build、--no-smoke、--no-rollback |
| deploy/scripts/env_check.sh [docker\|k8s] | 环境检查 |
| deploy/scripts/deploy_rollback.sh docker [SERVICE] | Docker 回滚 |
| deploy/scripts/deploy_rollback.sh k8s [DEPLOYMENT] | K8s 回滚 |
| deploy/scripts/service_control.sh docker start\|stop\|restart [SERVICE...] | Docker 启停 |
| deploy/scripts/service_control.sh k8s start\|stop [DEPLOYMENT...] | K8s 扩缩容 |
| deploy/scripts/k8s_apply_all.sh [--no-redis] [--no-ingress] [--no-hpa] | K8s 一键部署 |

---

**文档归属**：PaaS 生产级部署运维  
**关联**：deploy/README.md、deploy/k8s/README.md、docs/依赖与部署清单.md
