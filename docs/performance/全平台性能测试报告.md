# 全平台性能测试报告

## 1. 测试概述

| 项目 | 说明 |
|------|------|
| 测试时间 | _填写执行日期_ |
| 测试环境 | _如：4C8G × 2，网关+细胞同机/分机_ |
| 网关地址 | _GATEWAY_URL_ |
| 工具 | Locust / JMeter |
| 测试类型 | 基准 / 负载 / 压力 / 稳定性 |

## 2. 核心性能指标（KPI）达成情况

| 指标 | 目标 | 实测（优化前） | 实测（优化后） | 是否达标 |
|------|------|----------------|----------------|----------|
| 核心接口 P95 响应时间 | ≤ 300ms | _ms | _ms | 是/否 |
| 支持并发用户数 | ≥ 500 | _ | _ | 是/否 |
| 系统可用性（成功率） | ≥ 99.9% | _% | _% | 是/否 |
| 错误率 | < 0.1% | _% | _% | 是/否 |

## 3. 测试结果详情

### 3.1 基准测试（10 用户，5 分钟）

- **聚合统计**：总请求数、TPS、平均响应时间、P95、P99、失败数。
- **按接口**：/health、/api/auth/login、/api/v1/[cell]/xxx 的响应时间分布。
- **结论**：_达标 / 未达标及原因_。

### 3.2 负载测试（100 → 300 → 500 用户阶梯）

- 各阶梯 TPS、P95、错误率、资源占用（CPU/内存）。
- 瓶颈出现阶梯：_例如 500 用户时 P95 超 300ms_。

### 3.3 压力测试（找拐点）

- 拐点并发数：_例如 800 用户时错误率明显上升_。
- 主要现象：超时、5xx、网关/细胞 CPU 打满等。

### 3.4 稳定性测试（72 小时，200 并发）

- 全程成功率、平均响应时间趋势、内存/CPU 趋势。
- 是否出现内存泄漏、响应时间持续劣化：_是/否_。

## 4. 性能瓶颈分析

| 瓶颈点 | 现象 | 可能原因 |
|--------|------|----------|
| 网关转发延迟高 | P95 > 300ms | 连接未复用、未开 GET 缓存、下游细胞慢 |
| 高并发下 502/503 | 随并发上升 | 连接池过小、细胞实例数不足、熔断触发 |
| 数据库/存储 | 细胞接口慢 | 缺索引、大查询、锁竞争 |
| CPU/内存 | 资源打满 | 单机瓶颈，需水平扩展或限流 |

## 5. 优化建议与实施情况

### 5.1 网关层

- **连接池**：增大 `GATEWAY_POOL_NUM_POOLS`、`GATEWAY_POOL_MAXSIZE`（见《优化方案》）。
- **GET 缓存**：对读多写少接口开启 `GATEWAY_GET_CACHE_TTL_SEC`，降低细胞穿透。
- **超时与重试**：`GATEWAY_PROXY_TIMEOUT_SEC`、`GATEWAY_PROXY_RETRY_COUNT` 按业务调整。

### 5.2 细胞与数据层

- **索引优化**：对列表查询、筛选条件、外键建索引。
- **缓存**：热点数据（如配置、字典）使用 Redis 或本地缓存。
- **异步与批处理**：非实时路径异步化，减少同步等待。

### 5.3 部署与资源

- **水平扩展**：网关与细胞多实例 + 负载均衡。
- **资源限制**：合理设置 CPU/内存 limit，避免单进程占满。
- **限流与熔断**：已配置熔断；可对租户/接口做限流保护。

## 6. 优化前后对比

| 场景 | 指标 | 优化前 | 优化后 | 变化 |
|------|------|--------|--------|------|
| 基准 10 用户 | P95 (ms) | _ | _ | _ |
| 负载 500 用户 | P95 (ms) | _ | _ | _ |
| 负载 500 用户 | 成功率 (%) | _ | _ | _ |
| 压力拐点 | 并发数 | _ | _ | _ |

## 7. 结论与后续

- **结论**：当前版本是否满足「核心接口 P95 ≤ 300ms、500 并发、可用性 ≥ 99.9%」_是/否_。
- **后续**：_如增加监控告警、定期回归压测、数据库慢查询治理等_。
