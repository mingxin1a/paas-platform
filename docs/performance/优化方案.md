# 全平台性能优化方案

基于性能测试计划与测试报告中的瓶颈分析，实施以下优化，使核心接口 P95 ≤ 300ms、支持 500+ 并发、可用性 ≥ 99.9%。

## 1. 网关层优化

### 1.1 连接池（已实现，需配置）

- **位置**：`platform_core/core/gateway/http_client.py`
- **环境变量**：
  - `GATEWAY_POOL_NUM_POOLS`：连接池数量，建议 **64**（高并发时）
  - `GATEWAY_POOL_MAXSIZE`：每池最大连接数，建议 **16**
- **效果**：复用 TCP 连接，降低转发延迟与 TIME_WAIT。

### 1.2 GET 缓存（已实现，需开启）

- **环境变量**：
  - `GATEWAY_GET_CACHE_TTL_SEC`：GET 响应缓存 TTL（秒），**10** 表示 10 秒内相同请求直接命中缓存
  - `GATEWAY_GET_CACHE_MAX`：最大缓存条数，默认 500
- **适用**：读多写少的接口（如列表、健康检查）。写请求不缓存。
- **注意**：细胞数据强一致性要求高时可设为 0 关闭。

### 1.3 超时与重试

- `GATEWAY_PROXY_TIMEOUT_SEC`：下游细胞超时，默认 30s，可按业务调小（如 15s）避免长时间挂起。
- `GATEWAY_PROXY_RETRY_COUNT`：重试次数，默认 2，高可用场景可保留。

### 1.4 启用转发与连接池

- 部署时必须设置 `USE_REAL_FORWARD=1`，否则网关不会调用 `http_client.forward_request`（连接池与缓存不生效）。

## 2. 配置优化（推荐生产环境）

在部署网关的 environment 或 .env 中增加：

```bash
# 性能优化
USE_REAL_FORWARD=1
GATEWAY_POOL_NUM_POOLS=64
GATEWAY_POOL_MAXSIZE=16
GATEWAY_GET_CACHE_TTL_SEC=10
GATEWAY_GET_CACHE_MAX=1000
GATEWAY_PROXY_TIMEOUT_SEC=15
```

## 3. 索引与数据层（细胞侧）

- **列表查询**：对 `tenant_id`、`created_at`、状态字段建复合索引，避免全表扫描。
- **详情查询**：主键或业务 ID 建唯一索引。
- **审计/日志表**：按时间分区或按 trace_id 建索引，便于检索且控制单表大小。

## 4. 缓存优化（细胞/平台）

- **配置与字典**：可缓存到 Redis 或本地，减少 DB 访问。
- **健康检查**：细胞 `/health` 可做短时缓存（如 5s），降低 DB/外部依赖调用频率。

## 5. 部署与资源

- **水平扩展**：网关与各细胞多实例 + 负载均衡，满足 500+ 并发。
- **资源限制**：为网关与细胞设置合理 CPU/内存 request/limit，避免单实例过载或 OOM。
- **限流与熔断**：网关已集成熔断；可根据需要按租户或接口配置限流（rate_limit 模块）。

## 6. 优化前后对比（填写实测）

执行《全平台性能测试报告》中的基准与负载测试后，将优化前后数据填入报告「优化前后对比」一节，并据此迭代（如继续增大连接池、调整缓存 TTL、增加实例数）。
