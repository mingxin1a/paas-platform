# 全平台性能测试计划

## 1. 测试目标

- 验证平台在商用负载下满足核心性能指标。
- 识别性能瓶颈并指导优化，确保上线前达标。

## 2. 核心性能指标（KPI）

| 指标 | 目标 | 说明 |
|------|------|------|
| **核心接口响应时间** | P95 ≤ 300ms | 网关代理、细胞列表/详情、登录、健康检查等核心路径 |
| **并发用户数** | 支持 ≥ 500 并发用户 | 稳态下不出现大量超时或 5xx |
| **系统可用性** | ≥ 99.9% | 按请求成功率统计（成功请求数 / 总请求数） |
| **吞吐量** | 根据业务峰值设定 | 如 1000 req/s 核心接口合计 |
| **错误率** | < 0.1% | 5xx + 超时占比 |

## 3. 测试范围

### 3.1 核心接口清单

- **网关与认证**：`GET /health`、`POST /api/auth/login`、`GET /api/auth/me`
- **细胞代理（读）**：`GET /api/v1/{cell}/health`、`GET /api/v1/crm/customers`、`GET /api/v1/erp/orders`、`GET /api/v1/mes/work-orders`、`GET /api/v1/wms/inbound-orders`、`GET /api/v1/tms/shipments` 等
- **细胞代理（写）**：`POST /api/v1/crm/customers`、`POST /api/v1/erp/orders` 等
- **管理端**：`GET /api/admin/cells`、`GET /api/admin/health-summary`、`GET /api/admin/audit-logs`

### 3.2 核心业务流程（场景）

- **CRM**：登录 → 客户列表 → 创建客户 → 客户列表
- **ERP**：登录 → 订单列表 → 创建订单 → 订单列表
- **MES**：登录 → 工单列表 → 看板
- **WMS**：登录 → 入库单列表 → 库存查询
- **混合场景**：多细胞并发访问，模拟真实用户行为比例

## 4. 测试类型与执行策略

| 类型 | 目的 | 并发/时长 | 通过标准 |
|------|------|------------|----------|
| **基准测试** | 建立基线，单接口/单场景 | 10 用户，5 分钟 | P95 < 300ms，无 5xx |
| **负载测试** | 验证目标负载下性能 | 100 → 300 → 500 用户阶梯，每级 10 分钟 | P95 ≤ 300ms，成功率 ≥ 99.9% |
| **压力测试** | 找到系统拐点 | 500 → 800 → 1000 用户递增至失败 | 记录拐点并发与瓶颈 |
| **稳定性测试** | 长时间运行稳定性 | 200 并发，72 小时 | 成功率 ≥ 99.9%，无内存泄漏、无持续劣化 |

## 5. 环境与数据

- **环境**：与生产尽可能一致（网络、CPU/内存、数据库、缓存）。
- **数据**：预置多租户、多细胞数据，避免冷启动与单库热点。
- **网关配置**：开启 `USE_REAL_FORWARD=1`，连接池与 GET 缓存按《优化方案》配置。

## 6. 工具与脚本

- **Locust**：`deploy/load_test/locustfile.py`，覆盖上述所有核心接口与业务流程。
- **JMeter**（可选）：可依本计划导出 JMeter 场景，或使用 Locust 作为主压测工具。
- **执行入口**：`deploy/load_test/run_performance_tests.sh`（或 `.bat`）及 `run_performance_tests.py`。

## 7. 执行方式

```bash
# 安装依赖
pip install -r deploy/load_test/requirements.txt

# 基准测试（10 用户，5 分钟）
GATEWAY_URL=http://localhost:8000 python deploy/load_test/run_performance_tests.py baseline

# 负载测试（100 用户，10 分钟）
python deploy/load_test/run_performance_tests.py load

# 压力测试（500 用户，15 分钟）
python deploy/load_test/run_performance_tests.py stress

# 稳定性测试（200 用户，72 小时）
python deploy/load_test/run_performance_tests.py stability
```

或使用 Locust Web UI（非 headless）：

```bash
locust -f deploy/load_test/locustfile.py --host=http://localhost:8000
# 浏览器打开 http://localhost:8089 设置用户数、spawn rate、运行时长
```

## 8. 产出物

- 各轮次测试结果（响应时间分布、TPS、错误率、资源占用）。
- 《全平台性能测试报告》：含测试结果、瓶颈分析、优化建议、优化前后对比。
- 性能回归用例（可选）：集成到 CI，在关键代码变更后自动跑基准对比。
