# 事件总线与跨细胞异步规范

**依据**：00 修正案 #6、01 7.6.1；《接口设计说明书》3.2  
**用途**：跨细胞禁止同步强一致，必须通过「消息队列 + 最大努力通知 + 人工对账」；本规范约定平台事件总线接口与细胞发布/订阅契约。

---

## 一、宪法要求

- **00 #6**：禁止同步强一致调用跨系统业务；必须使用「消息队列 + 最大努力通知 + 人工对账」。系统可以暂时不可用，但数据绝对不能错。
- **01 7.6.1**：跨细胞业务调用必须异步，禁止同步强一致。

---

## 二、事件总线接口（平台侧）

平台提供统一事件发布/订阅能力，细胞仅通过 HTTP 或 SDK 与平台交互，不直连 Kafka/RabbitMQ。

### 2.1 发布事件（细胞 → 平台）

- **接口**：`POST /api/events`（网关或独立 event-bus 服务）
- **请求体**（与《接口设计说明书》3.2.2 一致）：
```json
{
  "eventId": "uuid",
  "eventType": "crm.customer.created",
  "timestamp": "2024-01-01T12:00:00Z",
  "source": "crm",
  "traceId": "请求链 trace_id",
  "data": { ... }
}
```
- **约定**：eventType 命名 `[cell].[Entity].[Action]`；data 中不得包含未脱敏个人敏感信息。
- **响应**：202 Accepted（异步持久化）；或 503（总线不可用时，细胞本地持久化后重试）。

### 2.2 订阅/拉取（细胞或平台内消费者）

- **接口**：`GET /api/events?topic=erp.order.created&since=timestamp&limit=100`
- **用途**：消费者按 topic 拉取事件，实现最大努力投递；未 ack 的可重试。
- **可选**：Webhook 推送（平台在事件入队后 POST 到细胞注册的 callback URL），需在平台侧配置订阅关系。

### 2.3 人工对账与最大努力

- 事件投递失败时：写入死信或重试队列，并产生「未对账」清单。
- 运营/运维定期按《运维规范》执行人工对账（如订单与库存一致性核对），与 00 #6 一致。

---

## 三、平台 Stub 与实现路径

| 阶段 | 内容 |
|------|------|
| **当前（Stub）** | 网关提供 `POST /api/events`、`GET /api/events` 占位：接受发布并返回 202；拉取返回空列表或内存中近期事件。满足「接口契约先行」，便于前端/细胞对接。 |
| **P5 落地** | 选型 Kafka/RabbitMQ/NATS，部署事件总线服务；网关或独立 event-bus 将 POST /api/events 转发至 MQ，GET /api/events 从 MQ 按 topic 拉取。 |
| **C6 细胞侧** | 各细胞在业务变更时调用 POST /api/events 发布领域事件；需消费他细胞事件时，通过 GET /api/events 或 Webhook 异步消费，禁止同步强一致。 |

---

## 四、事件语义冻结（01 7.3.1）

- 事件一经发布，其语义永久冻结；语义变更必须通过**新事件类型**实现。
- 事件只描述已发生事实，不得承载决策、预测或建议（01 7.3.2）。

---

## 五、与《待补充项清单》对应

- **P5**：事件总线对接（平台侧 MQ 选型与部署）
- **C6**：细胞事件发布/订阅（各细胞按本规范发布与消费）

---

**文档状态**：事件总线与跨细胞异步规范  
**关联**：《接口设计说明书》3.2、《宪法符合性检查与不符合项清单》不符合项 #2
