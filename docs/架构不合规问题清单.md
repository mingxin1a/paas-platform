# 架构不合规问题清单

**依据**：《00_【最高宪法】》《01_【核心法律】》《接口设计说明书》与《项目目录与架构说明》  
**生成时间**：架构合规性扫描

---

## 一、PaaS 层与 SaaS Cell 层解耦校验

### 1.1 已合规项

| 检查项 | 结果 | 说明 |
|--------|------|------|
| 细胞 import platform_core | 通过 | 全量扫描 cells/ 下无 `from platform_core` / `import platform_core` 代码依赖，仅注释引用规范 |
| 细胞调用平台方式 | 通过 | 认证经 HTTP（PLATFORM_AUTH_URL）、事件经 HTTP（EVENT_BUS_URL/GATEWAY_URL），无直连平台代码 |
| 网关/脚本配置 | 通过 | CELL_*_URL、GATEWAY_URL 等均来自环境变量或 load_routes()，非细胞内硬编码 |

### 1.2 不合规项

| 编号 | 层级 | 问题描述 | 位置 | 整改建议 |
|------|------|----------|------|----------|
| P1 | 平台网关 | 细胞名录硬编码 | `platform_core/core/gateway/app.py` 中 `_CELL_NAMES` 字典 | **已整改**：细胞列表改为 `_cell_list()`（基于 load_routes() 与 _CELL_DISPLAY_NAMES），新增细胞仅需配置 CELL_*_URL |
| P2 | 细胞注释 | 注释中引用 platform_core 路径 | 多个 cells/*/signing_verify.py 首行注释「platform_core/core/cell_signing.py 规范实现」 | 属说明性注释，不构成代码耦合；建议改为「遵循平台《接口设计说明书》验签规范」避免歧义 |

---

## 二、Cell 独立数据库 / 独立代码 / 独立部署校验

### 2.1 已合规项

| 检查项 | 结果 | 说明 |
|--------|------|------|
| 独立代码 | 通过 | 各细胞自有 src/（app/store/signing_verify 等），无跨细胞 import |
| 独立数据库 | 通过 | 各细胞自有 store 或 database 模块，无共享 DB 或跨细胞直连 |
| 独立部署 | 通过 | 各细胞可单独启动（run.py / app.py），网关通过 CELL_*_URL 配置指向 |
| 交付物 | 通过 | 13 个业务细胞均具备 api_contract.yaml、delivery.package |

### 2.2 不合规项与整改方案

| 编号 | 细胞 | 问题描述 | 整改方案 |
|------|------|----------|----------|
| C1 | 部分细胞 | 无独立 requirements.txt 或与平台混用 | 各细胞目录下应保留 requirements.txt，仅列本细胞依赖，不依赖 platform_core |
| C2 | WMS/MES/TMS | event_publisher 使用 GATEWAY_URL 作为事件总线地址 | 已为接口调用，合规；建议优先使用 EVENT_BUS_URL，GATEWAY_URL 仅作回退，并在文档中说明 |

---

## 三、接口规范（请求/响应/错误码/鉴权）校验

### 3.1 统一规范要求（《接口设计说明书》3.1.3）

- 请求头：Content-Type、Authorization、X-Request-ID（POST/PUT/PATCH）
- 响应头：Content-Type、X-Response-Time
- 错误响应体：`{"code","message","details","requestId"}` 四字段必备

### 3.2 不合规项

| 编号 | 位置 | 问题描述 | 整改 |
|------|------|----------|------|
| I1 | 多数 Flask 细胞 | 错误响应缺少 `details` 字段 | 所有 `jsonify({"code":..., "message":..., "requestId":...})` 补充 `"details": ""` 或具体说明 |
| I2 | 部分细胞 | 404/400 等仅返回 message，未统一 code | 已使用 code 的保持不变；未使用的需统一为 BAD_REQUEST/NOT_FOUND 等 |
| I3 | 鉴权 | 细胞内鉴权方式不一（部分 Optional Bearer，部分严格） | 符合「仅通过 HTTP 调用平台认证」即合规；建议在细胞 README 中说明 AUTH_STRICT 与 PLATFORM_AUTH_URL |

### 3.3 已自动修复（示例）

- 见《全项目架构合规性校验报告》§4：已对 MES/TMS/OA/SRM 等部分错误响应补充 `"details": ""`，其余细胞按同一规则批量补充。

---

## 四、目录结构规范校验

### 4.1 规范依据

《项目目录与架构说明》：cells/、platform_core/、frontend/、frontend-admin/、deploy/、evolution_engine/、glass_house/、docs/、scripts/、tests/、README.md、run.sh。

### 4.2 已合规项

- 自检与交付脚本已归位 scripts/（self_check.py、verify_delivery.sh 等）。
- 根目录保留 run.sh、README.md；无多余顶层业务代码。

### 4.3 目录结构调整方案（已执行：无需移动）

- **结论**：当前目录结构已符合《项目目录与架构说明》，无需移动文件。
- **约定**：cells/、platform_core/、frontend/、frontend-admin/、deploy/、evolution_engine/、glass_house/、docs/、scripts/、tests/、README.md、run.sh 保持现状；自检与交付脚本已归位 scripts/，根目录仅保留 run.sh 与 README 等入口。
- **可选**：若需进一步整理文档，可将设计类文档归至 docs/design、运维类至 docs/runbook，非强制。

### 4.4 不合规项（无）

| 编号 | 问题描述 | 调整方案 |
|------|----------|----------|
| D1 | 部分文档在 docs 下分散，商用交付在 docs/commercial_delivery | 保持现状即可，符合「文档在 docs/」 |
| D2 | 根目录无 self_check.py 等（已迁至 scripts/） | 已合规；README 中已说明通过 run.sh 或 scripts/self_check.py 执行 |

---

## 五、汇总

| 类别 | 不合规数量 | 已自动修复 | 待人工确认/整改 |
|------|------------|------------|------------------|
| PaaS/Cell 解耦 | 1（P1 硬编码名录） | 0 | P1：网关细胞列表配置化 |
| Cell 独立 | 0～1（C1 可选） | 0 | C1：各细胞独立 requirements |
| 接口规范 | 多处（I1） | 部分 | I1：全量错误体补全 details |
| 目录结构 | 0 | 0 | 无 |

**下一步**：见《全项目架构合规性校验报告》整改结果与架构优化建议。
