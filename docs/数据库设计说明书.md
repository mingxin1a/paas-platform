数据库设计说明书_V2.0
1. 文档概述
1.1 文档目的
本文档定义了SuperPaaS平台的数据库架构设计，基于"细胞化架构"和"事件溯源"理念，确保数据的高可用性、安全性、可追溯性及扩展性。
1.2 设计原则
•细胞隔离原则：各业务模块数据物理或逻辑隔离
•事件溯源原则：核心业务数据采用事件溯源模式
•不可变性原则：核心数据禁止UPDATE，只允许追加
•安全优先原则：数据加密、脱敏、审计一体化设计
•敏感数据：存储层须 AES-256 或国密 SM4 加密、密钥 KMS 管理；界面与日志须动态脱敏，严禁明文完整展示。详见《敏感数据加密与脱敏规范》。
2. 整体架构设计
2.1 数据库架构图
┌─────────────────────────────────────────────────────┐
│                  应用层                             │
└─────────────────────────────────────────────────────┘
▲
│
┌─────────────────────────────────────────────────────┐
│                  服务层                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐             │
│  │ ERP细胞 │  │ WMS细胞 │  │ TMS细胞 │  ...        │
│  └─────────┘  └─────────┘  └─────────┘             │
└─────────────────────────────────────────────────────┘
▲
│
┌─────────────────────────────────────────────────────┐
│                  数据访问层                         │
│  ┌────────────────────┐ ┌────────────────────┐     │
│  │ 事件存储引擎        │ │ 读模型数据库        │     │
│  │ (Event Store)       │ │ (Read Model DB)     │     │
│  └────────────────────┘ └────────────────────┘     │
└─────────────────────────────────────────────────────┘
▲
│
┌─────────────────────────────────────────────────────┐
│                  基础设施层                         │
└─────────────────────────────────────────────────────┘
2.2 细胞化数据隔离
•物理隔离：核心业务模块（ERP、WMS、TMS）使用独立数据库实例
•逻辑隔离：非核心模块采用Schema隔离，确保数据边界清晰
•访问控制：跨细胞数据访问必须通过事件总线，禁止直接数据库连接

 2.3 事件溯源性能优化（快照机制）
2.3.1 状态快照（State Snapshot）
* 策略：每当事件表（Event Store）累计达到 1000 条记录时，自动触发快照细胞生成当前实体的状态快照。
 * 读取路径：系统读取数据时，优先加载最新快照，再回放快照之后的增量事件，确保加载时间恒定。
 2.3.2 冷热数据归档
 * 热区：最近 12 个月的原始事件数据保留在高性能 SSD 存储中。
  * 冷区：超过 12 个月的事件数据自动归档至低成本对象存储（如 OSS），仅供审计查询，不参与实时业务计算。
> 

3. 核心数据模型设计
3.1 事件溯源设计模式
3.1.1 事件存储表结构
CREATE TABLE event_store (
event_id BIGINT PRIMARY KEY AUTO_INCREMENT,
aggregate_type VARCHAR(50) NOT NULL COMMENT '聚合根类型',
aggregate_id VARCHAR(100) NOT NULL COMMENT '聚合根ID',
event_type VARCHAR(100) NOT NULL COMMENT '事件类型',
event_data JSON NOT NULL COMMENT '事件数据',
event_version INT NOT NULL DEFAULT 1 COMMENT '事件版本',
occurred_on DATETIME(6) NOT NULL COMMENT '发生时间',
recorded_by VARCHAR(100) NOT NULL COMMENT '记录者',
recorded_at DATETIME(6) NOT NULL COMMENT '记录时间',
INDEX idx_aggregate (aggregate_type, aggregate_id),
INDEX idx_type_time (event_type, occurred_on),
INDEX idx_recorded (recorded_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
3.1.2 事件元数据表
CREATE TABLE event_metadata (
metadata_id BIGINT PRIMARY KEY AUTO_INCREMENT,
event_id BIGINT NOT NULL,
metadata_key VARCHAR(100) NOT NULL,
metadata_value TEXT,
UNIQUE KEY uk_event_key (event_id, metadata_key),
FOREIGN KEY (event_id) REFERENCES event_store(event_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
3.2 读模型数据库设计
3.2.1 用户中心读模型
CREATE TABLE user_read_model (
user_id VARCHAR(100) PRIMARY KEY,
username VARCHAR(50) NOT NULL,
real_name VARCHAR(50),
email VARCHAR(100),
phone VARCHAR(20),
status TINYINT NOT NULL DEFAULT 1 COMMENT '状态：1-正常，2-禁用',
last_login_time DATETIME,
last_login_ip VARCHAR(45),
created_at DATETIME NOT NULL,
updated_at DATETIME NOT NULL,
UNIQUE KEY uk_username (username),
UNIQUE KEY uk_email (email),
INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
3.2.2 订单读模型
CREATE TABLE order_read_model (
order_id VARCHAR(100) PRIMARY KEY,
customer_id VARCHAR(100) NOT NULL,
order_status TINYINT NOT NULL COMMENT '订单状态',
total_amount DECIMAL(18,2) NOT NULL,
currency VARCHAR(10) NOT NULL,
created_by VARCHAR(100) NOT NULL,
created_at DATETIME NOT NULL,
updated_at DATETIME NOT NULL,
INDEX idx_customer (customer_id),
INDEX idx_status (order_status),
INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
4. 安全性设计
4.1 数据加密策略
•传输加密：TLS 1.3全链路加密
•存储加密：
◦敏感字段（密码、身份证、银行卡）采用AES-256加密
◦加密密钥由KMS（密钥管理服务）统一管理
•字段级加密：支持按列配置加密策略
4.2 数据脱敏设计
-- 脱敏配置表
CREATE TABLE data_masking_config (
config_id BIGINT PRIMARY KEY AUTO_INCREMENT,
table_name VARCHAR(100) NOT NULL,
column_name VARCHAR(100) NOT NULL,
masking_type TINYINT NOT NULL COMMENT '脱敏类型：1-掩码，2-哈希，3-替换',
masking_rule VARCHAR(200) COMMENT '脱敏规则',
is_enabled TINYINT NOT NULL DEFAULT 1,
UNIQUE KEY uk_table_column (table_name, column_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
4.3 审计日志设计
CREATE TABLE audit_log (
log_id BIGINT PRIMARY KEY AUTO_INCREMENT,
user_id VARCHAR(100) NOT NULL,
operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
operation_content TEXT COMMENT '操作内容',
operation_result TINYINT NOT NULL COMMENT '操作结果：1-成功，2-失败',
client_ip VARCHAR(45),
user_agent VARCHAR(200),
occurred_at DATETIME(6) NOT NULL,
INDEX idx_user_time (user_id, occurred_at),
INDEX idx_operation (operation_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
5. 多租户设计
5.1 租户隔离策略
•数据库级隔离：大客户采用独立数据库实例
•Schema级隔离：中等客户采用独立Schema
•字段级隔离：小客户采用tenant_id字段隔离
5.2 租户信息表
CREATE TABLE tenant_info (
tenant_id VARCHAR(100) PRIMARY KEY,
tenant_name VARCHAR(100) NOT NULL,
contact_person VARCHAR(50),
contact_phone VARCHAR(20),
contact_email VARCHAR(100),
isolation_level TINYINT NOT NULL DEFAULT 1 COMMENT '隔离级别：1-字段级，2-Schema级，3-数据库级',
status TINYINT NOT NULL DEFAULT 1 COMMENT '状态：1-正常，2-停用',
created_at DATETIME NOT NULL,
updated_at DATETIME NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
6. 性能优化设计
6.1 索引优化策略
•覆盖索引：确保常用查询能通过索引直接获取数据
•复合索引：按查询条件顺序创建复合索引
•索引监控：定期分析索引使用情况，清理低效索引
6.2 分库分表策略
•水平分表：大表按时间或ID范围分表
•垂直分库：按业务模块拆分数据库
•分片键选择：选择高基数、查询频繁的字段作为分片键
7. 数据备份与恢复
7.1 备份策略
•全量备份：每日凌晨2点进行全量备份
•增量备份：每小时进行binlog增量备份
•异地备份：跨地域数据中心同步备份
7.2 恢复机制
•点-in-time恢复：支持基于时间点的数据恢复
•沙箱恢复：在隔离环境中验证备份数据完整性
•自动化恢复：提供一键恢复工具
8. 数据库运维管理
8.1 监控指标
•性能指标：QPS、TPS、连接数、慢查询
•资源指标：CPU、内存、磁盘IO、网络流量
•安全指标：异常登录、权限变更、数据访问异常
8.2 自动化运维
•自动扩容：基于负载自动扩展数据库实例
•自动修复：自动处理常见数据库故障
•自动优化：自动调整数据库参数配置
9. 附录
9.1 命名规范
•表名：小写字母，下划线分隔，复数形式（如：users）
•字段名：小写字母，下划线分隔（如：created_at）
•索引名：idx_表名_字段名（如：idx_users_email）
•约束名：fk_表名_字段名（如：fk_orders_user_id）
9.2 数据类型规范
•字符串：使用VARCHAR，避免使用TEXT除非必要
•数字：精确计算使用DECIMAL，统计使用BIGINT
•时间：使用DATETIME(6)支持微秒精度
•布尔值：使用TINYINT(1)，0表示false，1表示true
9.3 字符集设置
•数据库字符集：utf8mb4
•排序规则：utf8mb4_unicode_ci
•连接字符集：统一设置为utf8mb4

文档版本：V2.0
更新时间：2024-01-01
负责人：数据库架构师
审核人：技术总监