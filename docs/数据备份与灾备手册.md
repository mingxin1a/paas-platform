# 数据备份与灾备手册

**版本**：1.0  
**适用范围**：全量/增量备份、多目标存储、一键恢复、备份校验与告警、主备集群与异地灾备。

---

## 一、备份体系概览

### 1.1 备份类型与策略

| 类型 | 说明 | 建议频率 | 保留周期 |
|------|------|----------|----------|
| 全量备份 | 各细胞独立打包（meta + 占位数据），可扩展为 DB dump | 每日 1 次（如 02:00） | 7 天 |
| 增量备份 | 基于上次全量后的变更（当前实现为全量打标，可扩展 DB binlog） | 每 6 小时或按需 | 3 天 |

### 1.2 备份目标

- **本地**：`BACKUP_DIR` 目录，供本地保留与快速恢复。
- **对象存储（S3/OSS）**：通过 `BACKUP_S3_BUCKET`、`BACKUP_S3_PREFIX`、`AWS_*` 上传，支持异地与灾备拉取。
- **NAS**：`BACKUP_NAS_PATH`（挂载点）或 `BACKUP_NAS_RSYNC`（rsync 目标），备份完成后拷贝/同步。

### 1.3 脚本与配置

| 文件 | 说明 |
|------|------|
| `deploy/scripts/backup_config.env.example` | 备份配置示例，复制为 `backup_config.env` 后修改 |
| `deploy/scripts/backup_cells.sh` | 按细胞打包，生成 `cell_<cell>_<date>.tar.gz` |
| `deploy/scripts/backup_runner.sh` | 备份入口：全量/增量、多目标、校验、告警 |
| `deploy/scripts/verify_backup.sh` | 备份后校验：解压、meta.json 存在且含 backed_at |
| `deploy/scripts/alert_on_backup_failure.sh` | 备份/校验失败时告警（Webhook、本地告警日志） |
| `deploy/scripts/cron_backup.example` | 定时任务示例 |

---

## 二、备份配置

### 2.1 配置步骤

1. 复制配置示例并修改：
   ```bash
   cp deploy/scripts/backup_config.env.example deploy/scripts/backup_config.env
   # 编辑 backup_config.env，填写 BACKUP_DIR、BACKUP_TARGETS、S3/NAS 等
   ```

2. 主要变量说明：
   - `BACKUP_TYPE`：`full` 或 `incremental`
   - `BACKUP_TARGETS`：逗号分隔，如 `local,s3,nas`
   - `BACKUP_DIR`：本地目录，如 `/backup/paas`
   - `BACKUP_S3_BUCKET`、`BACKUP_S3_PREFIX`、`AWS_ACCESS_KEY_ID`、`AWS_SECRET_ACCESS_KEY`（可选 `BACKUP_S3_ENDPOINT` 用于 OSS）
   - `BACKUP_NAS_PATH` 或 `BACKUP_NAS_RSYNC`：NAS 目标
   - `BACKUP_ALERT_WEBHOOK`：失败时告警 Webhook（企业微信/钉钉等）
   - `BACKUP_CELLS`：细胞列表，空格分隔

### 2.2 定时自动备份

使用 crontab 调用 `backup_runner.sh`（需加载配置）：

```bash
# 每日 02:00 全量
0 2 * * * . /path/to/paas-platform/deploy/scripts/backup_config.env 2>/dev/null; BACKUP_TYPE=full /path/to/paas-platform/deploy/scripts/backup_runner.sh
```

或使用 `cron_backup.example` 中的示例，按实际路径修改后写入 crontab。

---

## 三、数据恢复

### 3.1 一键恢复脚本

`deploy/scripts/restore_full.sh` 支持：
- **全量恢复**：指定 `RESTORE_DATE`，恢复所有细胞。
- **按时间点恢复**：通过选择不同 `RESTORE_DATE` 对应备份时间点。
- **单细胞恢复**：设置 `RESTORE_CELL=crm` 仅恢复该细胞。
- **恢复前自动备份**：默认先执行一次当前数据备份，避免误操作覆盖；确需跳过时设置 `RESTORE_SKIP_PREBACKUP=1`。

### 3.2 恢复步骤

1. 确定要恢复的时间点（或单细胞）：
   ```bash
   export RESTORE_DATE=20250101_0200
   # 可选：仅恢复 crm
   export RESTORE_CELL=crm
   ```

2. 执行恢复（会先自动备份当前数据）：
   ```bash
   cd /path/to/paas-platform
   ./deploy/scripts/restore_full.sh
   ```

3. 若备份在 S3，脚本会自动从 S3 拉取对应 `RESTORE_DATE` 的包；本地已有则直接解压。

4. 恢复完成后：按需执行各细胞的数据导入钩子（如配置了 `restore_hook_<cell>.sh`），重启相关服务并做健康检查。

### 3.3 单库单表恢复

当前细胞为“单细胞”粒度；若后端为独立数据库，可：
- 使用 `RESTORE_CELL=xxx` 仅恢复该细胞对应备份；
- 在 `restore_hook_<cell>.sh` 中编写“仅导入某库/某表”的逻辑（如 mysql 指定库表）。

---

## 四、备份校验与失败告警

### 4.1 校验内容

`verify_backup.sh` 在每次备份完成后由 `backup_runner.sh` 自动调用，检查：
- **完整性**：备份包可解压、无损坏；
- **可用性**：解压后存在 `meta.json` 且包含 `backed_at` 字段。

校验失败则 `backup_runner.sh` 退出非 0 并调用 `alert_on_backup_failure.sh`。

### 4.2 告警配置

- **Webhook**：在 `backup_config.env` 中设置 `BACKUP_ALERT_WEBHOOK`，失败时 POST 简要信息。
- **本地日志**：告警会追加到 `deploy/backup/backup_alerts.log`，便于日志采集与告警平台消费。

---

## 五、灾备方案

### 5.1 主备集群与异地灾备

- **主站**：日常备份由 `backup_runner.sh` 写入本地并上传 S3/OSS；可选执行 `sync_backup_to_dr.sh` 确保最新备份已同步到对象存储。
- **灾备站**：定期从对象存储拉取最新备份（`sync_backup_to_dr.sh` 设 `DR_PULL_ONLY=1` 或执行 `prepare_dr_site.sh`），恢复后启动网关/治理/细胞，故障时通过 DNS 或 SLB 切流至灾备站。

### 5.2 数据同步方式

- **准实时**：主站备份完成后上传 S3，灾备站定时（如每 15 分钟）执行 `DR_PULL_ONLY=1 sync_backup_to_dr.sh` 拉取，再按需执行 restore。
- **实时**：若使用数据库主从或双写，需在数据库层配置主从复制或同步，本手册不展开。

### 5.3 灾备脚本与部署

| 文件 | 说明 |
|------|------|
| `deploy/scripts/dr_dual_active/prepare_dr_site.sh` | 灾备站点准备：目录、从 S3 拉取备份 |
| `deploy/scripts/dr_dual_active/sync_backup_to_dr.sh` | 主站上传/灾备站拉取（DR_PULL_ONLY=1） |
| `deploy/scripts/dr_dual_active/dr_failover.sh` | 故障切换：写入切换标记，提示 DNS/SLB 切换步骤 |
| `deploy/scripts/dr_dual_active/deploy_standby.yaml.example` | 灾备 K8s 部署示例（namespace/deployment/service） |
| `deploy/scripts/dr_dual_active/env.example` | 站点 ID、S3 等环境变量示例 |

### 5.4 故障切换步骤

1. 确认主站不可用或需要切流。
2. 在灾备节点执行：
   - 拉取最新备份：`DR_PULL_ONLY=1 ./sync_backup_to_dr.sh`
   - 恢复数据：`RESTORE_DATE=<最新备份时间> ./restore_full.sh`
   - 启动服务（Docker/K8s 按实际部署）。
   - 健康检查通过后执行：`DR_SITE_ID=dr ./dr_failover.sh`
3. 将流量切至灾备：修改 DNS 或 SLB/Ingress 指向灾备站网关，记录切换时间并通知运维。

### 5.5 自动切换（可选）

若需“故障自动切换”，可结合监控与编排实现：
- 监控主站网关/治理健康，异常时触发告警或调用脚本；
- 脚本内可调用 `dr_failover.sh` 并配合云厂商 DNS/SLB API 或 K8s 修改 Ingress，实现自动切流（需在运维预案中明确回滚与主站恢复流程）。

---

## 六、故障处理

### 6.1 备份失败

- 查看 `backup_dir/logs/backup_*.log` 定位具体阶段（打包、上传、校验）。
- 若为 S3/NAS 上传失败：检查网络、凭证、权限与端点地址。
- 若为校验失败：检查磁盘空间、是否被其他进程占用；可重新执行一次备份。

### 6.2 恢复失败

- 确认 `RESTORE_DATE` 与备份文件名中的时间戳一致；若从 S3 拉取，确认该时间点备份已存在。
- 单细胞恢复时确认 `RESTORE_CELL` 与备份包中的细胞名一致。
- 恢复前备份失败会中止恢复，需解决备份目录或权限后再执行，或经审批后使用 `RESTORE_SKIP_PREBACKUP=1`。

### 6.3 灾备切换后回切

- 主站恢复后，从主站拉取切换后产生的备份（或主从同步），在主站执行恢复或同步数据。
- 将 DNS/SLB 指回主站，通知业务并观察；灾备站可保留作为冷备或继续定期同步。

---

## 七、快速检查清单

- [ ] 已配置 `backup_config.env`（BACKUP_DIR、TARGETS、S3/NAS、告警）。
- [ ] 定时任务已添加（crontab 或系统任务）。
- [ ] 备份完成后校验通过，失败时能收到告警。
- [ ] 恢复流程已演练（含恢复前自动备份）。
- [ ] 灾备站已配置 prepare_dr_site、sync 与 failover 脚本，并定期拉取备份。
- [ ] 故障切换与回切步骤已文档化并与运维对齐。

---

**文档归属**：SuperPaaS 数据备份与灾备  
**关联**：《生产级部署运维手册》、`deploy/scripts/backup_example.md`、`deploy/scripts/dr_dual_active/README.md`
