# 多租户能力使用手册

本文档说明 PaaS 核心层企业级多租户能力：租户生命周期、权限配置、配额管理、租户级配置中心及数据隔离原则。所有能力严格遵循**数据隔离**，不同租户数据 100% 不互通。

---

## 一、能力总览

| 能力 | 说明 | 入口 |
|------|------|------|
| 租户生命周期 | 创建、启用/禁用、到期回收 | 平台管理员：`/api/admin/tenants` |
| 租户级权限 | 租户管理员、自定义角色、菜单/按钮/数据级权限 | `/api/admin/tenants/<id>/roles` |
| 租户资源隔离 | 接口请求量配额，超配额自动限流；CPU/内存/存储为配置项 | `/api/admin/tenants/<id>/quota` |
| 租户配置中心 | 系统参数、审批流程、界面风格等，不影响平台全局 | `/api/admin/tenants/<id>/config` |
| 数据隔离 | 请求头 `X-Tenant-Id` 透传，网关校验租户有效性与配额 | 网关 + 各细胞按 tenant_id 隔离 |

---

## 二、前置条件

- 网关已开启租户校验（可选）：`GATEWAY_REQUIRE_TENANT_ID=1` 时，业务请求**必须**携带 `X-Tenant-Id`，否则 400。
- 租户校验与配额（可选）：`GATEWAY_VALIDATE_TENANT=1` 时，对携带 `X-Tenant-Id` 的 `/api/v1/*` 请求校验租户是否存在、启用、未到期，并检查请求量配额，超配额返回 429。
- 管理端请求需携带 `Authorization: Bearer <token>`（平台管理员登录后获取）。

---

## 三、租户创建

### 3.1 创建租户

**接口**：`POST /api/admin/tenants`  
**请求体**：

```json
{
  "tenantId": "tenant-001",
  "name": "示例企业A",
  "expireAt": 1893427200
}
```

- `tenantId`：必填，租户唯一标识，创建后不可改。
- `name`：租户展示名称。
- `expireAt`：可选，Unix 时间戳，到期后该租户将被视为无效（网关校验时返回 403）；不传或 null 表示永不过期。

**响应**：201，body 为租户信息 `{ "id", "name", "status", "expire_at", "created_at" }`。

创建成功后，系统会为该租户自动创建「租户管理员」角色（若启用租户角色模块），便于后续分配权限。

### 3.2 查看租户列表

**接口**：`GET /api/admin/tenants`  
**响应**：200，`{ "data": [ { "id", "name", "status", "expire_at", "created_at" }, ... ], "total": N }`。

---

## 四、租户启用/禁用与到期回收

### 4.1 启用/禁用租户

**接口**：`PATCH /api/admin/tenants/<tenant_id>`  
**请求体**：

```json
{
  "status": "disabled"
}
```

- `status`：`enabled` 启用，`disabled` 禁用。禁用后该租户请求在网关校验时返回 403（需 `GATEWAY_VALIDATE_TENANT=1`）。
- 默认租户 `default` 不可禁用。

### 4.2 设置到期时间

**请求体**：

```json
{
  "expireAt": 1893427200
}
```

- `expireAt`：Unix 时间戳；传 `null` 表示永不过期。到期后租户被视为无效，网关返回 403。

### 4.3 到期回收

- 到期后仅表示「租户无效」，网关与细胞不再接受该租户请求。
- 业务数据回收由各细胞按自身策略执行（如归档、清理）；平台层不持有业务数据，仅维护租户元数据。

---

## 五、租户级权限配置

### 5.1 租户管理员与自定义角色

**接口**：`GET /api/admin/tenants/<tenant_id>/roles` 查看当前租户角色列表。

**接口**：`PUT /api/admin/tenants/<tenant_id>/roles` 设置或更新角色。

**请求体示例**：

```json
{
  "code": "tenant_admin",
  "name": "租户管理员",
  "menus": ["*"],
  "buttons": ["*"],
  "dataScope": "all"
}
```

- `code`：角色码，`tenant_admin` 表示租户管理员；自定义角色建议使用 `custom_xxx`。
- `name`：角色展示名。
- `menus`：菜单 ID 列表，`["*"]` 表示全部菜单。
- `buttons`：按钮/操作 ID 列表，`["*"]` 表示全部按钮。
- `dataScope`：数据级权限，`all` 全部数据，`self` 仅本人，`dept` 本部门（具体由细胞实现）。

### 5.2 三级权限说明

| 层级 | 说明 | 配置位置 |
|------|------|----------|
| 菜单级 | 控制可见菜单/模块 | `menus` |
| 按钮级 | 控制页面内按钮/操作是否可用 | `buttons` |
| 数据级 | 控制数据可见范围（本人/部门/全部） | `dataScope` |

权限校验由认证中心或各细胞根据用户所属租户与角色配置执行；网关仅校验租户有效性与配额，不解析具体菜单/按钮权限。

---

## 六、租户配额管理

### 6.1 接口请求量配额（自动限流）

**接口**：`GET /api/admin/tenants/<tenant_id>/quota` 查看当前配额。  
**接口**：`PUT /api/admin/tenants/<tenant_id>/quota` 设置配额。

**请求体示例**：

```json
{
  "requestsPerMin": 1000,
  "cpuLimit": "2",
  "memoryMb": 4096,
  "storageGb": 100
}
```

- `requestsPerMin`：每分钟接口请求量上限。网关强制校验，超限返回 429。0 或不配置表示不限制。
- `cpuLimit`、`memoryMb`、`storageGb`：为配置项，供细胞或基础设施按需使用，实现 CPU/内存/存储隔离；平台网关不直接强制。

### 6.2 超配额行为

- 当 `GATEWAY_VALIDATE_TENANT=1` 且租户配置了 `requestsPerMin` 时，该租户在 1 分钟内请求数超过配额后，网关返回 **429**，错误码 `QUOTA_EXCEEDED`，提示「租户接口请求量已达配额上限，请稍后重试」。

---

## 七、租户级配置中心

### 7.1 命名空间

租户配置按命名空间隔离，不影响平台全局配置：

- `system`：系统参数（如开关、超时等）。
- `approval`：审批流程配置。
- `ui`：界面风格（主题、Logo 等）。

### 7.2 查询与设置

**查询**：`GET /api/admin/tenants/<tenant_id>/config?namespace=system`  
返回该租户该命名空间下所有 key-value。

**查询全部**：`GET /api/admin/tenants/<tenant_id>/config`  
返回 `{ "system": {...}, "approval": {...}, "ui": {...} }`。

**设置**：`PUT /api/admin/tenants/<tenant_id>/config`  
**请求体**：

```json
{
  "namespace": "ui",
  "config": {
    "theme": "dark",
    "logoUrl": "https://..."
  }
}
```

- 仅更新指定命名空间，不影响其他命名空间及平台全局配置。

---

## 八、数据隔离原则

1. **平台不存业务数据**：PaaS 核心层仅存储租户元数据（id、name、status、expire_at）、配额、配置、角色；业务数据由各细胞按 `X-Tenant-Id` 隔离存储。
2. **请求必带租户**：生产建议 `GATEWAY_REQUIRE_TENANT_ID=1`，所有业务请求携带 `X-Tenant-Id`，网关透传至细胞。
3. **租户校验**：开启 `GATEWAY_VALIDATE_TENANT=1` 后，网关对带 `X-Tenant-Id` 的 `/api/v1/*` 请求校验租户有效（存在、启用、未到期）及请求量配额，无效或超配额直接拒绝，避免非法或超量访问。
4. **细胞侧隔离**：各细胞从请求头读取 `X-Tenant-Id`，所有读写按 tenant_id 过滤，确保不同租户数据 100% 不互通。

---

## 九、操作步骤速查

| 步骤 | 操作 | 接口 |
|------|------|------|
| 1 | 创建租户 | POST /api/admin/tenants |
| 2 | 查看/启用/禁用/到期 | GET/PATCH /api/admin/tenants, /api/admin/tenants/<id> |
| 3 | 配置请求量及资源配额 | GET/PUT /api/admin/tenants/<id>/quota |
| 4 | 配置角色与菜单/按钮/数据权限 | GET/PUT /api/admin/tenants/<id>/roles |
| 5 | 配置租户系统参数/审批/界面 | GET/PUT /api/admin/tenants/<id>/config |

---

## 十、环境变量

| 变量 | 说明 | 推荐 |
|------|------|------|
| GATEWAY_REQUIRE_TENANT_ID | 是否强制要求 X-Tenant-Id | 生产 1 |
| GATEWAY_VALIDATE_TENANT | 是否校验租户有效性与配额 | 生产 1 |
| TENANT_QUOTA_DEFAULT_REQUESTS_PER_MIN | 未配置配额时默认每分钟请求上限，0=不限制 | 0 |

---

**文档归属**：PaaS 核心层多租户 · 企业级商用
