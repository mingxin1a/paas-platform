# 商用化问题整改清单

**版本**：1.0  
**说明**：按优先级 P0（阻塞商用）/P1（高）/P2（中）标注；每项给出具体修复代码或配置建议。

---

## P0（阻塞商用）

### P0-1 无可执行的数据备份脚本

| 项目 | 内容 |
|------|------|
| 问题 | 仅有 backup_example.md 说明，无可直接执行的备份脚本，不符合可运维验收。 |
| 修复 | 在 `deploy/scripts/` 下新增可执行备份脚本（示例：备份配置与逻辑，真实库需替换连接串）。 |

**具体修复**：新增 `deploy/scripts/backup.sh`（示例逻辑，生产需替换 DB_* 与路径）：

```bash
#!/usr/bin/env sh
# 数据备份脚本（示例：需按实际 DB 与路径修改）
set -e
BACKUP_DIR="${BACKUP_DIR:-./backup}"
DATE=$(date +%Y%m%d_%H%M)
mkdir -p "$BACKUP_DIR"
# 配置备份（脱敏后）
if [ -f "../.env" ]; then
  sed 's/=.*/=***/' "../.env" > "$BACKUP_DIR/env_sample_${DATE}.txt" || true
fi
# 各 Cell 若使用 MySQL，示例： mysqldump -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" dbname | gzip > "$BACKUP_DIR/dbname_${DATE}.sql.gz"
echo "Backup finished: $BACKUP_DIR"
```

并在 `deploy/README.md` 或《商用化交付总手册》中说明备份周期、保留策略与恢复步骤。

---

### P0-2 冒烟测试路径与网关路由不一致导致全量冒烟失败

| 项目 | 内容 |
|------|------|
| 问题 | smoke_test.py 使用 `/api/v1/crm/customers` 等，网关转发到 cell 时 path 为 `customers`；CRM 实际为 FastAPI 挂载在 `/customers`，GET 为 `/customers`，一致。但 ERP 等 Flask 细胞路径可能为 `/orders` 等，需与 gateway_route_spec 及各 cell 实际路由一致。若网关解析 cell 为 `crm` 且 base_url 为 `http://crm-cell:8001`，则 `target = base_url + "/" + path` = `http://crm-cell:8001/customers`，正确。需确认 ERP 等是否为 `/orders`。 |
| 修复 | 统一冒烟路径与各 Cell 实际 GET 列表路径；或文档明确「经网关访问时 URL 为 /api/v1/<cell>/<cell 内 path>」。 |

**具体修复**：核对 `deploy/smoke_test.py` 中 `CELL_PATHS` 与各 Cell 实际首屏列表路径（如 ERP 是否为 `orders` 或 `api/v1/erp/orders`）。若 Cell 无 `/orders` 则改为该 Cell 实际存在的 GET 路径（如 ERP 的订单列表路径）。建议：

- CRM: `/api/v1/crm/customers` → cell 收到 GET `/customers` ✓  
- ERP: 若为 Flask 且路由为 `/orders`，则 `/api/v1/erp/orders` ✓  
- 其他 Cell 同理。若某 Cell 列表路径不同（如 `/inventory`），将 `CELL_PATHS["wms"]` 改为 `/api/v1/wms/inventory` 等。

---

## P1（高）

### P1-1 生产环境 Cell 数据持久化

| 项目 | 内容 |
|------|------|
| 问题 | ERP/OA/SRM/MES/WMS/TMS/EMS/PLM/HIS/LIS/LIMS 等使用内存 store，重启数据丢失。 |
| 修复 | 为每个 Cell 提供「生产模式」配置：连接 MySQL/PostgreSQL，将 store 层改为 DB 实现；或保留内存 store 仅用于演示，文档中明确「生产需切换持久化」。 |

**具体修复**：在各自 Cell 的 `store.py` 或配置中增加 `USE_DB=1` 时使用 SQLAlchemy/MySQL 的实现（可先实现 1 个 Cell 如 ERP 作为模板），其余 Cell 按相同模式接入。或至少在《商用化交付总手册》中写明「当前为内存存储，生产部署需替换为数据库持久化」。

---

### P1-2 监控栈可部署（Prometheus + Grafana）

| 项目 | 内容 |
|------|------|
| 问题 | 仅有 prometheus.example.yml，无一键启动监控栈。 |
| 修复 | 提供 docker-compose 片段或独立 compose 文件，启动 Prometheus + Grafana，并抓取网关、治理、monitor、各 Cell 的 /health 或 /metrics。 |

**具体修复**：在 `deploy/monitoring/docker-compose.monitoring.yml` 中增加：

```yaml
version: "3.8"
services:
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - "./prometheus.example.yml:/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
```

将 `prometheus.example.yml` 中 targets 改为与主 compose 网络一致（如 `gateway:8000`、`crm-cell:8001` 等），并在 `deploy/README.md` 中说明「启动监控：docker compose -f deploy/monitoring/docker-compose.monitoring.yml up -d」。

---

### P1-3 审计日志落库与只追加策略

| 项目 | 内容 |
|------|------|
| 问题 | 各 Cell 的 _human_audit 仅打 logging，未落库，无法满足「可审计、不可篡改」的严格合规。 |
| 修复 | 在 PaaS 或各 Cell 增加审计日志写入（如独立 audit_log 表或日志服务），并配置日志存储为只追加（如写入 Kafka/文件仅 append）。 |

**具体修复**：在平台侧或每个 Cell 增加 `audit_log` 表写入（与现有 database_schema 中 audit_log 一致）。在 _human_audit 调用处除 logging 外增加一次 DB insert（或 HTTP 上报审计服务）。生产环境对审计存储启用只追加策略（应用层不提供删除/更新接口）。

---

## P2（中）

### P2-1 网关强制 X-Tenant-Id 与 Cell 层 POST 校验 X-Request-ID

| 项目 | 内容 |
|------|------|
| 问题 | 生产建议强制租户；部分 Cell 未在 POST 时校验 X-Request-ID。 |
| 修复 | 生产环境设置 `GATEWAY_REQUIRE_TENANT_ID=1`；各 Cell 在 POST/PUT/PATCH 入口若未校验 X-Request-ID，增加校验（已有幂等逻辑的保留）。 |

**具体修复**：在 `deploy/.env.example` 中增加注释：

```bash
# 生产环境建议开启
# GATEWAY_REQUIRE_TENANT_ID=1
```

对尚未校验 X-Request-ID 的 Cell，在 create 类视图中读取 `request.headers.get("X-Request-ID")`，若为空且为 POST/PUT 可返回 400 或使用生成的 id 继续（以《接口设计说明书》为准）。

---

### P2-2 批量操作上限与超时文档化

| 项目 | 内容 |
|------|------|
| 问题 | 批量导入/导出上限、超时未在接口文档中明确。 |
| 修复 | 在各 Cell 商用接口文档中注明：如「单次导入不超过 1000 条」「请求超时 30s」等；必要时在接口层增加 limit 校验与超时返回。 |

---

### P2-3 Flask Cell 提供 OpenAPI/Swagger

| 项目 | 内容 |
|------|------|
| 问题 | 仅 CRM（FastAPI）有 /docs；Flask 细胞无 Swagger。 |
| 修复 | 为 Flask 细胞增加 flasgger 或 apispec，或为每个 Cell 维护一份静态 openapi.yaml，经网关 /api/admin/cells/<id>/docs 代理到静态文档页。 |

**具体修复**：在 Flask 细胞中 `pip install flasgger`，在 app 中挂载：

```python
from flasgger import Swagger
app.config['SWAGGER'] = {'title': 'ERP Cell API', 'uiversion': 3}
swagger = Swagger(app)
```

并对核心接口补充 docstring（YAML 格式），即可生成 /docs。或在 docs 目录下手写 openapi.yaml，通过静态服务暴露。

---

### P2-4 部署脚本在 Windows 下的说明

| 项目 | 内容 |
|------|------|
| 问题 | deploy.sh 为 shell，Windows 需 Git Bash 或 WSL。 |
| 修复 | 在 deploy/README.md 中增加「Windows 用户请使用 Git Bash 或 WSL 执行 deploy.sh」，或提供 deploy.ps1 的等价步骤说明。 |

---

### P2-5 CI 中代码规范与注释率检查

| 项目 | 内容 |
|------|------|
| 问题 | 未在 CI 中执行 PEP8/ESLint 与注释覆盖率≥80%。 |
| 修复 | 在 CI 流水线中增加步骤：flake8 或 black --check；可选使用 coverage + 注释率工具（如 docstring 覆盖率）并设定阈值 ≥80%。 |

**具体修复**：示例 GitHub Actions 片段：

```yaml
- name: Lint
  run: |
    pip install flake8
    flake8 cells/ platform_core/ --max-line-length=120 --extend-ignore=E203
- name: Check docstrings (optional)
  run: |
    pip install interrogate
    interrogate -v --fail-under=80 cells/ platform_core/
```

---

## 整改汇总表

| 编号 | 优先级 | 简述 | 状态 |
|------|--------|------|------|
| P0-1 | P0 | 可执行备份脚本 | 待整改 |
| P0-2 | P0 | 冒烟路径与路由一致性 | 待整改 |
| P1-1 | P1 | Cell 生产持久化 | 待整改 |
| P1-2 | P1 | 监控栈可部署 | 待整改 |
| P1-3 | P1 | 审计日志落库与只追加 | 待整改 |
| P2-1 | P2 | 租户与 X-Request-ID 强制 | 待整改 |
| P2-2 | P2 | 批量上限与超时文档 | 待整改 |
| P2-3 | P2 | Flask Cell Swagger | 待整改 |
| P2-4 | P2 | Windows 部署说明 | 待整改 |
| P2-5 | P2 | CI 规范与注释率 | 待整改 |
