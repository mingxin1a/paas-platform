# 架构对齐与开发指南

**依据**：docs 目录下全套架构文档（00/01 宪法、02 概要设计、接口设计、全量化架构设计、项目目录与架构说明、架构实现对照表、待补充项清单、项目合规校验报告等）  
**目的**：对齐当前项目与架构文档的完成度，列出待完善项，并为每项提供可直接在 Cursor 中落地的开发步骤与 Prompt；优先聚焦「验证架构解耦性」。

---

## 一、当前项目已完成内容（对齐架构文档）

| 架构文档要求 | 当前实现状态 | 位置/说明 |
|--------------|--------------|-----------|
| **五层架构 - 应用开发层：API 网关、细胞化** | ✅ 已完成 | platform_core/core/gateway（路由、熔断、trace_id）；cells/ 下 13 个细胞独立目录与 app |
| **01 细胞自治** | ✅ 已完成 | 各细胞独立目录、独立端口、独立 Docker、独立 store，无跨细胞 DB 直连 |
| **01 跨细胞仅事件/接口** | ✅ 已完成 | 细胞经网关 /api/v1/{cell}/... 访问，无跨细胞库直连 |
| **01 平台无业务数据** | ✅ 已满足 | 网关不存业务数据，仅路由、鉴权、透传 |
| **细胞不依赖 platform_core 代码** | ✅ 已满足 | 全量扫描 cells/**/*.py 无 import platform_core；验签为各细胞自实现副本 |
| **接口设计：REST、请求头 X-Request-ID、统一错误码** | ✅ 已完成 | 网关与前端已带 X-Request-ID；统一错误格式；trace_id 透传 |
| **接口设计：熔断 10s/50%、半开恢复** | ✅ 已完成 | platform_core/core/gateway/circuit_breaker.py |
| **00 红绿灯原则** | ✅ 已完成 | traffic_light.py，CPU 超阈值仅放行 GET |
| **00/01 验签与抗抵赖** | ✅ 占位/可选 | 网关 signing、细胞 signing_verify，CELL_VERIFY_SIGNATURE=1 时启用 |
| **全细胞交付校验与健康测试** | ✅ 已完成 | verify_all_cells、verify_delivery；test_all_cells_health；run_full_verification、self_check |
| **部署与路由配置** | ✅ 部分完成 | docker-compose 含 gateway + 4 细胞 + monitor；gateway 支持 YAML/ENV 路由 |
| **双端前端** | ✅ 已完成 | frontend（5173）、frontend-admin（5174），登录与 allowedCells、细胞管理占位 |
| **进化与透明化** | ✅ 已完成 | evolution_engine、glass_house（ADR、gap、runbook、live_evolution_log） |
| **细胞契约与交付物** | ✅ 已完成 | 各细胞 api_contract.yaml、delivery.package、completion.manifest、cell_profile、auto_healing |

---

## 二、待完善核心内容（按优先级排序）

### P0（高）：架构解耦与平台无业务状态

| 序号 | 待完善项 | 依据文档 | 说明 |
|------|----------|----------|------|
| **A1** | **网关细胞名录配置化** | 01 7.4、00 #11、项目合规校验报告 P0-1 | 移除 app.py 中 _CELL_NAMES 硬编码；细胞列表与显示名由 load_routes()/配置文件/环境变量驱动，admin_cells_patch 仅校验“在路由表中存在” |
| **A2** | **网关用户与权限配置化** | 01 7.4、项目合规校验报告 P0-2 | _MOCK_USERS 及 allowedCells 移至配置文件或环境变量，网关不写死业务侧权限 |

### P1（中）：乐高原则与单一数据源

| 序号 | 待完善项 | 依据文档 | 说明 |
|------|----------|----------|------|
| **B1** | **演示页细胞列表动态化** | 项目合规校验报告 P1-3 | demo_cells.html 从 /api/admin/cells 或服务端注入获取细胞列表，移除硬编码 CELLS 数组 |
| **B2** | **客户端细胞配置从 API 获取** | 02 细胞化/热插拔、项目合规校验报告 P1-4 | 前端 cells 基础列表从 /api/admin/cells 获取，本地仅保留展示增强（如 labelMap）或由细胞自描述补充 |
| **B3** | **冒烟测试路径动态化** | 项目合规校验报告 P1-5 | smoke_test.py 从网关或细胞 manifest 动态生成待测路径，移除 CELL_PATHS 硬编码 |
| **B4** | **平台测试主列表路径来自契约** | 项目合规校验报告 P1-6 | test_all_cells_health 从各细胞 api_contract.yaml 解析主列表路径，移除 CELL_MAIN_GET 硬编码 |
| **B5** | **部署/路由扩展脚本或文档** | 项目合规校验报告 P1-7 | 提供按 cells 目录或 manifest 批量生成 docker-compose 片段 / gateway_route_spec 的脚本或文档 |

### P2（低）：合规与体验增强

| 序号 | 待完善项 | 依据文档 | 说明 |
|------|----------|----------|------|
| **C1** | **敏感数据加密与脱敏实施** | 01 2.2、00 #4、待补充项清单 | 各细胞按《敏感数据加密与脱敏规范》落实敏感列加密与界面/日志脱敏 |
| **C2** | **前端感知安全** | 00 #14、01 4.1、前端感知安全需求说明 | 安全态势可视化、动态水印、「谁在何时访问了我的数据」审计入口 |
| **C3** | **架构解耦自动化校验** | 01 7.2/7.4、项目合规校验报告 | 在 CI/自检中自动校验：细胞无 platform_core 依赖；可选：网关细胞名录来自配置 |

---

## 三、每个待完善项的 Cursor 开发步骤与 Prompt

### A1：网关细胞名录配置化

**开发步骤：**

1. 在 `platform_core/core/gateway/config.py` 中增加“细胞显示名”的加载逻辑（如从 YAML 的 `routes[].name` 或环境变量 `CELL_*_NAME` 或独立配置文件），与现有 `load_routes()` 对齐，返回 `Dict[str, str]`（cell_id -> display_name），无配置时用 cell_id 作为显示名。
2. 在 `app.py` 中删除硬编码 `_CELL_NAMES`；`admin_cells_list` 改为遍历 `load_routes()` 的 keys，显示名从 config 新方法获取。
3. `admin_cells_patch(cell_id)` 校验改为：`cell_id` 在 `load_routes()` 的 keys 中即允许，不再依赖 `_CELL_NAMES`。
4. 更新 `deploy/gateway_route_spec.yaml`（或文档）示例：为每个 route 增加可选 `name` 字段；更新 `config.py` 的 YAML 解析以读取 `name`。
5. 运行 `pytest tests/` 与 `python evolution_engine/verify_all_cells.py`，确认管理端 GET/PATCH cells 行为与现有一致（可通过 e2e 或手工验证）。

**Cursor Prompt（复制即用）：**

```
请基于 docs/项目合规校验报告.md 的 P0-1 修改建议，实现「网关细胞名录配置化」：

1. 在 platform_core/core/gateway/config.py 中新增 get_cell_display_names()：从 GATEWAY_ROUTES_PATH 指向的 YAML 中读取 routes[].name（或 id 作 fallback），或从环境变量 CELL_<ID>_NAME 读取；返回 Dict[cell_id, display_name]。与 load_routes() 使用同一 CONFIG_PATH。
2. 在 platform_core/core/gateway/app.py 中移除 _CELL_NAMES 硬编码；admin_cells_list 使用 load_routes() 的 keys 作为细胞列表，显示名从 get_cell_display_names() 获取，无则用 cell_id。
3. admin_cells_patch(cell_id) 的校验改为：仅当 cell_id 在 load_routes() 的 keys 中时允许 PATCH，不再依赖 _CELL_NAMES。
4. 在 deploy/gateway_route_spec.yaml 的每个 route 下增加可选 name 字段示例（如 crm 的 name: "客户关系"），并确保 config 能解析。
5. 保持向后兼容：若 CONFIG_PATH 未配置，load_routes() 仍从环境变量 CELL_*_URL 获取路由；get_cell_display_names() 此时返回空 dict，显示名用 cell_id。
```

---

### A2：网关用户与权限配置化

**开发步骤：**

1. 新增配置文件（如 `platform_core/core/gateway/users_config.yaml` 或通过环境变量 `GATEWAY_MOCK_USERS_JSON`）描述 Mock 用户及 allowedCells；若不存在则回退到当前代码内默认值以保证兼容。
2. 在 `app.py` 启动时或首次访问时加载该配置，替换硬编码 `_MOCK_USERS`。
3. 运行现有登录与 E2E 测试，确认行为不变。

**Cursor Prompt：**

```
请实现「网关用户与权限配置化」（docs/项目合规校验报告 P0-2）：

1. 支持通过环境变量 GATEWAY_MOCK_USERS_JSON（JSON 字符串）或配置文件（如 GATEWAY_USERS_CONFIG_PATH 指向的 YAML/JSON）加载 Mock 用户列表，结构为 [{ "username", "password", "role", "allowedCells": [] }]。
2. 在 platform_core/core/gateway/app.py 中，将 _MOCK_USERS 改为从上述配置加载；若未配置则保留当前硬编码默认值（admin、client、operator）作为 fallback。
3. 确保 auth_login 与 auth_me 行为与现有一致，allowedCells 从配置读取。
```

---

### B1：演示页细胞列表动态化

**开发步骤：**

1. 将 `demo_cells.html` 改为：页面加载后调用 `GET /api/admin/cells`（Authorization: Bearer &lt;token&gt;，可用固定 demo token 或从 URL 参数读取），用返回的 `data[].id` 渲染细胞列表并探测 `/api/v1/{id}/health`。
2. 若需未登录访问，可新增网关只读接口（如 `GET /api/public/cells` 仅返回 id 列表）或由服务端渲染 demo 页时注入细胞列表（需网关提供模板渲染或静态生成）。

**Cursor Prompt：**

```
请按 docs/项目合规校验报告 P1-3 修改 platform_core/core/gateway/demo_cells.html：

1. 移除硬编码 var CELLS = [...]。
2. 页面加载后请求 GET /api/admin/cells，请求头带 Authorization: Bearer demo（或网关支持的固定 token）。用返回的 data[].id 作为细胞列表，若请求失败则显示“无法获取细胞列表，请先登录网关”。
3. 探测逻辑保持不变：对每个 cell id 请求 /api/v1/{id}/health 并显示结果。
```

---

### B2：客户端细胞配置从 API 获取

**开发步骤：**

1. 在 frontend 中新增 API 调用：登录后请求 `GET /api/admin/cells`，将返回的 `{ data: [{ id, name, enabled, baseUrl }] }` 转为客户端可用的细胞列表（至少 id、name）。
2. 将 `frontend/src/config/cells.ts` 改为：优先使用 API 返回的列表；本地 CELLS 仅作为“展示增强”默认值（如 path、listKey、labelMap），通过 id 与 API 结果 merge；未在本地配置的细胞用 id + name 默认展示。
3. 保证未登录或 API 失败时仍有 fallback（如仅显示本地配置的细胞或提示登录）。

**Cursor Prompt：**

```
请按 docs/项目合规校验报告 P1-4 和 docs/架构实现对照表 实现「客户端细胞配置从 API 获取」：

1. 在 frontend 中新增获取细胞列表的 API：调用 GET /api/admin/cells（使用现有 gateway 的 token），返回 data 含 id、name、enabled、baseUrl。
2. 修改 frontend/src/config/cells.ts：导出 getCellsAsync()，优先从 API 获取细胞列表；本地 CELLS 数组仅作为展示增强（path、listKey、idKey、labelMap）的默认配置，按 id 与 API 结果合并；API 中有但本地无的细胞用 { id, name: name || id, path: \`/\${id}\` } 等默认值。
3. 使用 getCellsAsync() 的页面（如 CellList、Dashboard）在挂载时请求并 setState，加载中显示 loading；若 API 失败则回退到本地 CELLS 或提示“请登录后查看细胞列表”。
```

---

### B3：冒烟测试路径动态化

**开发步骤：**

1. 在 `deploy/smoke_test.py` 中，若启用 `--all`：先请求 `GET /api/admin/cells` 获取细胞 id 列表（需带 Authorization）。
2. 对每个 cell id，先请求 `GET /api/v1/{id}/health` 作为冒烟路径；若需测试主列表，可从 cells 目录下该细胞的 api_contract.yaml 解析首个 GET path，或保持仅 health。
3. 移除或弃用硬编码 `CELL_PATHS`，改为上述动态生成。

**Cursor Prompt：**

```
请按 docs/项目合规校验报告 P1-5 修改 deploy/smoke_test.py：

1. 当使用 --all 或 USE_ALL_CELLS=1 时：先请求 GATEWAY_URL + '/api/admin/cells'，请求头带 Authorization: Bearer smoke-test（或可配置的 SMOKE_TOKEN），解析返回的 data[].id 得到细胞列表。
2. 对每个 cell id 请求 GET /api/v1/{id}/health 作为冒烟检查，不再使用硬编码 CELL_PATHS。
3. 若 /api/admin/cells 不可用或返回非 200，则回退到仅测 gateway /health 和 /api/v1/crm/health（或保留原默认单细胞 CRM 逻辑）。移除或注释掉 CELL_PATHS 常量。
```

---

### B4：平台测试主列表路径来自契约

**开发步骤：**

1. 在 `tests/test_all_cells_health.py` 中新增辅助函数：从 `cells/<name>/api_contract.yaml` 解析 OpenAPI paths，取首个 GET 的 path（或约定 tag 为 list 的 path）作为该细胞主列表路径。
2. 将 `CELL_MAIN_GET` 改为：对 `discover_cells()` 的每个细胞，若存在 api_contract.yaml 则解析得到主路径，否则 skip 该细胞的主列表契约测试。
3. 保留 discover_cells() 与 load_cell_app() 逻辑不变。

**Cursor Prompt：**

```
请按 docs/项目合规校验报告 P1-6 修改 tests/test_all_cells_health.py：

1. 新增函数 get_cell_main_list_path(cell_name: str) -> Optional[str]：读取 cells/<cell_name>/api_contract.yaml，解析 OpenAPI 3.0 的 paths，返回第一个 GET 操作的 path（如 /customers）；若文件不存在或解析失败返回 None。
2. test_cell_main_list_contract 的 parametrize 改为对 discover_cells() 的每个细胞，若 get_cell_main_list_path(cell_name) 非空则加入测试，否则 skip；移除硬编码 CELL_MAIN_GET。
3. 测试内部用 get_cell_main_list_path(cell_name) 获取 path，其余断言不变。
```

---

### B5：部署/路由扩展脚本或文档

**开发步骤：**

1. 新增脚本（如 `scripts/generate_deploy_config.py`）或文档：根据 `cells/` 子目录与各细胞 `delivery.package` 或固定约定，生成 `gateway_route_spec.yaml` 片段或 docker-compose 的 service 片段。
2. 在 docs 中说明：新增细胞时运行该脚本或按文档模板追加配置即可，无需手改多处。

**Cursor Prompt：**

```
请按 docs/项目合规校验报告 P1-7 增加「部署与路由扩展」能力：

1. 新增 scripts/generate_deploy_config.py：扫描 cells/ 下所有子目录（细胞 id），为每个细胞生成 gateway_route_spec 的一条 route（id: cell-<id>, path_prefix: /api/cells/<id>, upstream: http://<id>-cell:PORT）及 docker-compose 的 service 片段（build context、port、healthcheck）；端口可来自 cells/<id>/delivery.package 或按顺序分配（8001, 8002, ...）。
2. 输出为可追加到 gateway_route_spec.yaml 的 YAML 和可追加到 docker-compose.yml 的片段，或直接覆盖/合并（由脚本参数控制）。
3. 在 deploy/README.md 或 docs/项目目录与架构说明.md 中增加一节「新增细胞时的部署与路由配置」，说明运行 generate_deploy_config 或按模板手改的步骤。
```

---

### C1 / C2：敏感数据与前端感知安全

**Cursor Prompt（C1）：**

```
请按 docs/待补充项清单 与《敏感数据加密与脱敏规范》在 cells/crm 中做试点：对 store 中敏感字段（如 contactPhone、身份证号等）在写入前做 AES-256 或占位加密，读取后脱敏再返回 API；在 api_contract 或 README 中注明敏感字段清单。其他细胞可后续按同一规范扩展。
```

**Cursor Prompt（C2）：**

```
请按《前端感知安全需求说明》在 frontend 中实现：1）登录后或敏感操作时展示安全态势区域（如“当前会话安全”+ 简单动画）；2）列表/详情页增加动态水印（用户名+时间）；3）在主导航增加「谁在何时访问了我的数据」入口，对接 GET /api/admin/audit 或占位数据并展示列表。参考 docs/待补充项清单 项 3。
```

---

### C3：架构解耦自动化校验（第一个可落地的开发动作，见第四节）

---

## 四、优先聚焦：第一个可落地的开发动作——验证架构解耦性

**目标**：在 CI/自检中自动校验「细胞不依赖 platform_core」「平台不持有业务细胞名录的硬编码依赖（可选）」，确保架构解耦可被持续验证。

**具体动作**：新增 **架构解耦专项测试**，纳入 `run_full_verification` 与 `self_check`。

### 4.1 开发步骤（可直接在 Cursor 中执行）

1. **新增测试文件** `tests/test_architecture_decoupling.py`：
   - **用例 1**：扫描 `cells/` 下所有 `.py` 文件，断言没有任何一行包含 `from platform_core` 或 `import platform_core`（允许注释或文档字符串中出现“规范实现”等说明文字，但不允许 import）。
   - **用例 2（可选）**：断言 `platform_core/core/gateway/app.py` 中不存在硬编码的 `_CELL_NAMES` 字典字面量（即细胞名录来自配置；若尚未做 A1，可先改为“检测到 _CELL_NAMES 时发出 warn 或 skip”，待 A1 完成后再改为强制断言）。
2. **纳入流水线**：确保 `python -m pytest tests/` 会执行该文件；`scripts/run_full_verification.py` 与 `scripts/self_check.py` 已包含 `pytest tests/`，无需改。
3. 运行一次 `python -m pytest tests/test_architecture_decoupling.py -v` 与 `python scripts/run_full_verification.py`，确认通过。

### 4.2 Cursor Prompt（第一个可落地的开发动作，复制即用）

```
请在本项目中新增「架构解耦」的自动化校验，并纳入现有自检流程。

1. 新建 tests/test_architecture_decoupling.py，实现以下测试：
   a) test_cells_do_not_import_platform_core：遍历 cells/ 下所有 .py 文件（含子目录），检查文件内容中是否出现 "from platform_core" 或 "import platform_core"（不区分大小写）；若出现则断言失败并列出违规文件与行号。允许注释或字符串中出现 platform_core（例如“规范实现”说明），仅禁止作为 import 语句的一部分。
   b) test_gateway_cell_list_not_hardcoded（可选）：检查 platform_core/core/gateway/app.py 中是否仍存在 _CELL_NAMES 的硬编码字典字面量（即包含多个细胞 id 的 dict）；若存在则 pytest.skip("网关细胞名录尚未配置化，见 docs/项目合规校验报告 P0-1")，以便 A1 完成后将此 skip 改为断言失败。
2. 确保 tests 的 conftest 或 pytest 能发现该文件；run_full_verification 和 self_check 已包含 pytest tests/，无需修改。
3. 在 docs/整体检验程序说明.md 的「检验层次」表中增加一行：架构解耦校验 | tests/test_architecture_decoupling.py | 细胞无 platform_core 依赖；网关细胞名录配置化（可选）。
```

完成上述后，每次运行 `./run.sh full_verify` 或 `./run.sh self_check`（或 `python scripts/run_full_verification.py` / `python scripts/self_check.py`） 都会自动执行架构解耦校验，**第一个可落地的开发动作**即告完成。随后可按「三、每个待完善项的 Cursor 开发步骤与 Prompt」依次落地 A1、A2、B1～B5、C1、C2。

---

## 五、文档索引（docs 目录下架构相关）

| 文档 | 用途 |
|------|------|
| 00_【最高宪法】SuperPaaS-God.md | 五重审判、人性审判、集装箱/乐高/生物学等修正案 |
| 01_【核心法律】基础与AI安全宪法.md | 技术栈、细胞自治、平台无业务状态、多租户、审计 |
| 02_概要设计说明书.md | 细胞化架构、事件驱动、安全与体验 |
| 接口设计说明书.md | REST、请求头、熔断、事件总线、错误码 |
| 超级PaaS平台全量化系统架构设计说明书.md | 五层架构、感知交互层到基础设施层 |
| 项目目录与架构说明.md | 目录树、请求流、入口 |
| 架构实现对照表.md | 五层与 01 条款的当前实现映射 |
| 待补充项清单.md | P0/P1/P2 待办与已补充状态 |
| 项目合规校验报告.md | 解耦与细胞隔离的不符合项与修改建议 |
| 项目基本要求与架构基础.md | 00/01 为基准、架构以文档为基础扩展 |

---

**文档状态**：与当前代码和 docs 全量扫描结果一致；随实现进展可更新「一、已完成内容」与「二、待完善核心内容」及对应 Cursor Prompt。
