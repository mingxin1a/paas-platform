# 超级 PaaS 平台 - 监控告警体系使用手册

**版本**：1.0  
**读者**：运维、SRE、交付工程师  
**目标**：企业级可观测性（Prometheus+Grafana、告警、ELK 日志、APM 全链路）的部署、配置与日常使用。

---

## 1. 架构总览

| 能力       | 组件                     | 用途                           |
|------------|--------------------------|--------------------------------|
| 指标与大盘 | Prometheus + Grafana     | 业务/系统/DB 指标采集与可视化   |
| 告警       | Alertmanager + 钉钉/邮件/企微 | 多维度告警、分级路由           |
| 日志       | ELK (ES + Logstash + Kibana) + Filebeat | 统一采集、检索、全链路 trace_id |
| APM        | SkyWalking OAP + UI      | 调用链路、性能瓶颈、错误分析   |

各栈通过 `docker-compose` 与主平台同网 `paas-net` 对接，无需改业务代码即可接入。

---

## 2. 监控部署（Prometheus + Grafana）

### 2.1 前置条件

- 已启动主栈并创建网络：  
  `docker network create paas-net`（若已运行 `docker compose -f deploy/docker-compose.yml up -d` 则已有）。
- 当前目录为项目根目录。

### 2.2 启动监控栈

```bash
# 与主栈一起启动
docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.observability.yml up -d

# 仅启动可观测性栈（主栈已运行）
docker compose -f deploy/docker-compose.observability.yml up -d
```

可选 profile：

- `--profile with-node`：启用 Node Exporter（主机 CPU/内存）。
- `--profile with-redis`：启用 Redis Exporter（需主栈已起 Redis）。
- `--profile with-dingtalk`：启用钉钉告警适配器（需配置 `DINGTALK_WEBHOOK_URL`）。

### 2.3 验证

- Prometheus：<http://localhost:9090> → Status → Targets，确认 gateway、governance、cells-health 等为 UP。
- Grafana：<http://localhost:3000>，默认账号 `admin`/`admin`（由 `GF_ADMIN_USER`/`GF_ADMIN_PASSWORD` 覆盖）。

### 2.4 采集说明

- **业务/健康**：`prometheus.yml` 已配置网关、治理中心、监控中心、13 个 Cell 的 `/health` 采集（`job=gateway|governance|monitor|cells-health`）。
- **系统**：启用 `with-node` 时采集 Node Exporter（`job=node`）。
- **数据库/Redis**：启用 `with-redis` 时采集 Redis Exporter；数据库需自建 Exporter 并在 `prometheus.yml` 中增加对应 `scrape_configs`。
- **接口 RED**：需网关或各 Cell 暴露 Prometheus 格式的 `/metrics`（如 `http_requests_total`、`http_request_duration_seconds`），并在 `prometheus.yml` 中保留/启用 `gateway-metrics` 等 job；未暴露前大盘中 RED 面板可能无数据，仅健康与系统指标生效。

---

## 3. Grafana 大盘配置

### 3.1 预置大盘

- **PaaS 平台总览**（`paas-platform-overview`）：网关/治理/监控健康、各细胞健康数、各细胞健康表、接口 QPS、P99 延迟、主机 CPU/内存（需 node_exporter）。
- **Cell 模块详情**（`paas-cell-detail`）：下拉选择细胞，查看该细胞健康、QPS、P99、错误率。

大盘位于 `deploy/monitoring/grafana/dashboards/`，由 Grafana provisioning 自动加载到 `PaaS` 文件夹。

### 3.2 手动导入

若未自动出现：Grafana → Dashboards → Import → Upload JSON，选择上述目录下 `paas-platform-overview.json` 或 `cell-detail.json`。

### 3.3 变量与数据源

- 数据源：预置为默认 Prometheus，URL 为 `http://prometheus:9090`。
- Cell 详情中的 `cell` 变量：从 `up{job="cells-health"}` 的 `cell` 标签取值。

---

## 4. 告警规则与告警渠道

### 4.1 告警分级

| 级别 | 含义     | 典型场景                     | 默认路由       |
|------|----------|------------------------------|----------------|
| P0   | 紧急     | 网关/治理中心/细胞宕机       | 钉钉 + 邮件    |
| P1   | 高       | 接口错误率>10%、P99>5s       | 钉钉 + 邮件    |
| P2   | 中       | CPU/内存/Redis 过高、Redis 宕机 | 邮件          |
| P3   | 低       | 采集缺失、部分细胞不健康     | 可选邮件/仅记录 |

规则文件：`deploy/monitoring/prometheus/rules/alerts.yml`。

### 4.2 规则说明

- **服务宕机**：`up{job="gateway"}==0`、`up{job="governance"}==0`、`up{job="cells-health"}==0`，for 1m/2m。
- **接口异常/性能**：依赖 `http_requests_total`、`http_request_duration_seconds_bucket`（需网关/Cell 暴露 `/metrics`）。
- **资源**：依赖 Node Exporter（`node_cpu_*`、`node_memory_*`）和 Redis Exporter（`redis_*`）。
- **数据异常**：`absent(up{job=...})`、健康细胞数过少等。

修改阈值或新增规则后，重载 Prometheus：  
`curl -X POST http://localhost:9090/-/reload`（需启用了 `--web.enable-lifecycle`）。

### 4.3 Alertmanager 配置

配置文件：`deploy/monitoring/alertmanager/alertmanager.yml`。

- **邮件**：在 `receivers` 中配置 `email_configs`（to、headers），或设置 `global.smtp_smarthost`、`global.smtp_from` 等。
- **钉钉**：通过钉钉适配器（镜像 `timonwong/prometheus-webhook-dingtalk`）接收 Alertmanager webhook 并转为钉钉 API。启动可观测性栈时使用 `--profile with-dingtalk`，并设置环境变量 `DINGTALK_WEBHOOK_URL=https://oapi.dingtalk.com/robot/send?access_token=XXX`（需在钉钉群创建自定义机器人获取）。
- **企业微信**：Alertmanager 无内置企微；需自建或使用第三方 Webhook 适配器，将告警 JSON 转为企业微信机器人格式，并在 `alertmanager.yml` 中增加对应 receiver 的 `webhook_configs` URL。

### 4.4 企业微信配置示例

1. 企业微信群机器人或自建应用获取 Webhook URL。
2. 部署可将 Alertmanager 告警转为企微格式的适配器（或使用通用 webhook 转企微脚本）。
3. 在 `alertmanager.yml` 中新增 receiver，例如：

```yaml
- name: p0-wecom
  webhook_configs:
    - url: 'http://wecom-adapter:8061/wecom/send'
      send_resolved: true
```

将 P0 路由复制一份指向 `p0-wecom` 即可。

### 4.5 告警抑制

- 已配置：当 `GatewayDown` 触发时，抑制 `CellDown`、`HighErrorRate`，避免下游细胞因网关不可用而刷屏。

---

## 5. 日志体系（ELK）

### 5.1 部署

```bash
docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.elk.yml up -d
```

将启动 Elasticsearch、Logstash、Kibana、Filebeat。

### 5.2 采集与管道

- **Filebeat**：采集 Docker 容器 stdout（`/var/lib/docker/containers/*/*.log`），仅包含名称含 `gateway`、`governance`、`cell`、`monitor` 的容器。
- **Logstash**：接收 Beats，解析 JSON，提取 `trace_id`、`cell`、`tenant_id`，写入 ES 索引 `paas-logs-%{+YYYY.MM.dd}`。
- **应用侧**：建议网关与各 Cell 输出 JSON 日志，字段含 `level`、`message`、`trace_id`、`timestamp`，可选 `tenant_id`、`cell`、`path`。

### 5.3 Kibana 检索

1. 打开 <http://localhost:5601>。
2. Stack Management → Index Patterns → 创建 `paas-logs-*`，时间字段 `@timestamp`。
3. Discover 中选择该索引，按 `trace_id`、`cell`、`message` 等筛选，实现全链路检索。

### 5.4 日志告警

在 Kibana 中配置 Rule（Alerting），按条件（如某 cell 错误日志率、关键词）触发，可对接 Webhook/邮件（与现有告警体系互补）。

---

## 6. 全链路 APM（SkyWalking）

### 6.1 部署

```bash
docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.apm.yml up -d
```

默认使用 H2 存储；生产可改为 Elasticsearch 存储（需先起 ELK），设置环境变量：  
`SW_STORAGE=elasticsearch`、`SW_STORAGE_ES_CLUSTER_NODES=elasticsearch:9200`，并在同一 compose 或网络中能访问 `elasticsearch`。

### 6.2 应用接入

- **Python（Flask）**：安装 `apache-skywalking`，启动前设置：
  - `SW_AGENT_NAME=gateway`（或 `crm-cell`、`erp-cell` 等）
  - `SW_AGENT_COLLECTOR_BACKEND_SERVICES=oap:11800`
  启动命令示例：`python -m skywalking bootstrap app.py`（或 `deploy/run_gateway.py`）。
- **Java**：在 JVM 参数中增加 `-javaagent:/path/to/skywalking-agent/skywalking-agent.jar` 及 `SW_AGENT_NAME`、`SW_AGENT_COLLECTOR_BACKEND_SERVICES`。

OAP 与业务容器需同网（如 `paas-net`），确保能访问 `oap:11800`。

### 6.3 UI 使用

打开 <http://localhost:8080>（或 `SKYWALKING_UI_PORT` 指定端口）：  
查看服务拓扑、调用链、端点与实例性能、错误分布，用于性能瓶颈定位与错误分析。

### 6.4 可选：Pinpoint

若选用 Pinpoint 替代 SkyWalking，需自行部署 Pinpoint Collector + Web；应用侧接入 Pinpoint Agent（Java 为主）。链路与性能能力与 SkyWalking 类似，本手册以 SkyWalking 为例，Pinpoint 部署与接入步骤请参考官方文档。

---

## 7. 一键启动顺序建议

1. 主平台：`docker compose -f deploy/docker-compose.yml up -d`
2. 监控：`docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.observability.yml up -d`
3. 日志（可选）：`docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.elk.yml up -d`
4. APM（可选）：`docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.apm.yml up -d`

若需钉钉/Node/Redis：  
`docker compose -f deploy/docker-compose.yml -f deploy/docker-compose.observability.yml --profile with-dingtalk --profile with-node --profile with-redis up -d`

---

## 8. 相关文件索引

| 类型     | 路径 |
|----------|------|
| Prometheus 主配置 | `deploy/monitoring/prometheus/prometheus.yml` |
| 告警规则     | `deploy/monitoring/prometheus/rules/alerts.yml` |
| Alertmanager | `deploy/monitoring/alertmanager/alertmanager.yml` |
| Grafana 大盘 | `deploy/monitoring/grafana/dashboards/*.json` |
| 可观测性 Compose | `deploy/docker-compose.observability.yml` |
| ELK Compose  | `deploy/docker-compose.elk.yml` |
| ELK Logstash | `deploy/monitoring/elk/logstash/pipeline/logstash.conf` |
| ELK Filebeat | `deploy/monitoring/elk/filebeat/filebeat.yml` |
| APM Compose  | `deploy/docker-compose.apm.yml` |
| SkyWalking Agent 示例 | `deploy/monitoring/apm/skywalking-agent.config` |

---

**文档状态**：监控告警体系使用手册 v1.0  
**关联**：`deploy/docs/监控与告警说明.md`、`docs/phase1_PaaS层商用化增强设计.md`
