# Nacos 配置中心灰度发布与版本回滚说明

**用途**：网关/治理中心路由与配置可由 Nacos 管理；本说明为**灰度发布与版本回滚**的基础能力说明，平台层不新增业务逻辑，仅通过配置驱动。

---

## 一、数据 ID 与分组建议

| 用途 | dataId | group | 说明 |
|------|--------|-------|------|
| 网关路由 | gateway_routes | DEFAULT_GROUP | JSON/YAML：cell_id -> base_url |
| 细胞灰度 | cell_<cellId>_beta | DEFAULT_GROUP | 灰度 upstream 地址，网关优先取 beta 再取正式 |
| 配置版本 | gateway_routes_v2 | DEFAULT_GROUP | 新版本；发布时切换引用 |

---

## 二、灰度发布流程（建议）

1. **发布新配置**：在 Nacos 新建或编辑 `gateway_routes_v2`，将待灰度细胞指向新版本 upstream（如 crm-v2）。
2. **网关读取**：网关启动时或定时从 Nacos 拉取 `GATEWAY_ROUTES_DATA_ID=gateway_routes_v2`；或通过治理中心下发“当前生效 dataId”。
3. **灰度流量**：通过请求头 `X-Cell-Beta: crm` 或治理中心“细胞灰度开关”将指定细胞流量指向 beta upstream。
4. **全量切换**：灰度验证通过后，将默认 dataId 切为 v2；或更新 `gateway_routes` 内容为 v2 路由。

---

## 三、版本回滚

1. **快速回滚**：将 Nacos 中当前 dataId 内容改回上一版本（或切换 dataId 为 `gateway_routes_v1`）。
2. **网关/治理**：支持通过环境变量 `GATEWAY_ROUTES_PATH` 或治理 API 切换“路由配置源”为本地文件或 Nacos 上一版本。
3. **生效**：网关支持配置热更新时立即生效；否则滚动重启网关 Pod。

---

## 四、与现有网关的衔接

- 当前网关通过 `config.load_routes()` 从**环境变量**（CELL_*_URL）和**文件**（GATEWAY_ROUTES_PATH）加载路由。
- 生产可增加 **Nacos 配置源**：在 `platform_core/core/gateway/config.py` 中增加从 Nacos 拉取的路径（由部署侧注入 Nacos 地址与 dataId），保持“仅配置、无业务逻辑”原则。
- 灰度/回滚均由**配置内容或 dataId 切换**完成，无需改业务代码。

**文档归属**：deploy/config/nacos · 商用交付
