# Logstash 管道：接收 Beats，解析 JSON 日志，写入 ES；支持 trace_id 全链路
input {
  beats {
    port => 5044
  }
}

filter {
  # 仅保留 PaaS 相关容器日志（gateway、governance、*-cell、monitor）
  if [docker][container][name] {
    if not (
      [docker][container][name] =~ /gateway|governance|monitor|cell/
    ) {
      drop { }
    }
  }
  json {
    source => "message"
    target => "paas"
    skip_on_invalid_json => true
  }
  if [paas][trace_id] {
    mutate {
      add_field => { "trace_id" => "%{[paas][trace_id]}" }
    }
  }
  if [paas][cell] {
    mutate {
      add_field => { "cell" => "%{[paas][cell]}" }
    }
  }
  if [paas][tenant_id] {
    mutate {
      add_field => { "tenant_id" => "%{[paas][tenant_id]}" }
    }
  }
  date {
    match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss.SSS" ]
    target => "@timestamp"
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "paas-logs-%{+YYYY.MM.dd}"
  }
}
