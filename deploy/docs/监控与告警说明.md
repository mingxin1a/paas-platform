# 超级PaaS平台 - 监控与告警说明

**用途**：商用化可运维标准——监控、告警、日志规范。  
**读者**：运维、SRE、交付工程师。

---

## 1. 监控架构建议

| 组件 | 说明 |
|------|------|
| **Prometheus** | 采集网关、治理中心、各 Cell 的 HTTP 指标（请求量、延迟、错误率）；可选采集 Redis/DB 指标 |
| **Grafana** | 大盘展示：服务健康、接口 RED（Rate/Error/Duration）、依赖健康汇总 |
| **健康汇总 API** | 网关提供 `GET /api/admin/health-summary`（需 Authorization），聚合治理中心各 Cell 健康状态，便于单点查看 |

---

## 2. 指标与采集

### 2.1 已有能力

- **网关**：`X-Response-Time` 响应头、trace_id；可对接治理中心上报 RED。
- **治理中心**：`/api/governance/health`、`/api/governance/health/cells`、`/api/governance/metrics`（RED 指标）。
- **各 Cell**：`GET /health`；部分 Cell 可扩展 `/metrics`（Prometheus 格式）。

### 2.2 建议采集目标

- 网关：`http://gateway:8000/health`（存活）；若网关暴露 `/metrics` 则采集。
- 治理中心：`http://governance:8005/api/governance/health`。
- 各 Cell：`http://<cell>:port/health`。
- 监控中心：`http://monitor:9000/health`。

示例 Prometheus 配置见 `deploy/monitoring/prometheus.example.yml`。

---

## 3. 告警规则示例

建议对以下情况告警（示例规则见 `deploy/monitoring/alerts.example.yaml`）：

| 规则 | 条件 | 说明 |
|------|------|------|
| 服务宕机 | 健康检查失败超过 1 分钟 | 网关/治理中心/Cell 不可用 |
| 错误率过高 | 5xx 或 4xx 率 > 10% | 接口异常 |
| 响应过慢 | P99 延迟 > 5s | 性能劣化 |
| 熔断打开 | 网关返回 503 CIRCUIT_OPEN | 下游 Cell 熔断 |

AlertManager 与通知渠道（邮件/钉钉/企业微信）由部署侧自行配置。

---

## 4. 日志规范

| 项 | 要求 |
|----|------|
| 格式 | JSON，字段含：level、message、trace_id、timestamp；可选 tenant_id、cell、path |
| 级别 | INFO（正常请求）、WARN（熔断/缺头/重试）、ERROR（5xx、转发失败） |
| 聚合 | 通过 Filebeat/Fluentd 等采集至 ELK 或云日志，便于按 trace_id 检索 |

网关与治理中心已使用结构化日志（如 trace_id）；各 Cell 建议统一输出 JSON 到 stdout，由容器或 K8s 采集。

---

## 5. 高可用部署说明

- **网关 / 治理中心**：无状态，可多副本 + 负载均衡（Nginx 或 K8s Service）。
- **健康检查**：Docker 使用 `HEALTHCHECK` 调用 `/health`；K8s 使用 `livenessProbe`/`readinessProbe`。
- **故障转移**：依赖编排层（Docker/K8s）重启不健康实例；网关调用 Cell 失败时返回 503 并触发熔断。

---

## 6. 企业级可观测性（扩展）

完整 Prometheus+Grafana、告警（P0-P3、邮件/钉钉/企微）、ELK 日志、SkyWalking APM 的部署与使用见：

- **《监控告警体系使用手册》**：`docs/监控告警体系使用手册.md`
- 可观测性 Compose：`deploy/docker-compose.observability.yml`
- ELK Compose：`deploy/docker-compose.elk.yml`
- APM Compose：`deploy/docker-compose.apm.yml`
- 全量 Prometheus/告警/大盘：`deploy/monitoring/prometheus/`、`deploy/monitoring/alertmanager/`、`deploy/monitoring/grafana/`

---

## 7. 相关文件

| 路径 | 说明 |
|------|------|
| `deploy/monitoring/prometheus.example.yml` | Prometheus 抓取示例（旧，可参考） |
| `deploy/monitoring/prometheus/prometheus.yml` | 企业级全量采集配置 |
| `deploy/monitoring/prometheus/rules/alerts.yml` | P0-P3 告警规则 |
| `deploy/monitoring/alertmanager/alertmanager.yml` | 告警路由与渠道 |
| `deploy/monitoring/alerts.example.yaml` | 告警规则示例（旧） |
| `docs/监控告警体系使用手册.md` | 监控告警体系使用手册（完整步骤） |
| `docs/phase1_PaaS层商用化增强设计.md` | 阶段 1 设计（监控/日志/HA） |
